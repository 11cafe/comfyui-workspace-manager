import{f as se,l as te,o as ne,j as t,g as oe,h as le,r as u,K as ie,F as ce,B as N,U as re,M as ae,L as he,N as xe,O as ue,Q as de,R as ge}from"./input.js";import{W as fe,h as T,F as j,a9 as je,I as w,B as J,k as L,T as z,o as C,w as Z,z as Y,a1 as Q,j as we,H as S,i as ve,aa as X,x as _,ab as ye,y as pe}from"./App-Rycz7pg4.js";import{I as be,i as Ie,a as Ce,b as ke,g as Pe,S as ze,M as Oe}from"./MediaPreview-QkJfcR2L.js";import{I as Me,C as q}from"./chunk-JARCRF6W-ADGa7_HV.js";import{I as V,L as E}from"./IconCopy-R0fURUht.js";import{V as D}from"./chunk-NTCQBYKE-izZ4Ms_6.js";import"/scripts/app.js";import"/scripts/api.js";import"./index-pz0vT7Or.js";function Se(s,e=[]){const n=Object.assign({},s);for(const l of e)l in n&&delete n[l];return n}var Fe=["h","minH","height","minHeight"],B=se((s,e)=>{const n=te("Textarea",s),{className:l,rows:o,...i}=ne(s),c=fe(i),d=o?Se(n,Fe):n;return t.jsx(oe.textarea,{ref:e,rows:o,...c,className:le("chakra-textarea",l),__css:d})});B.displayName="Textarea";var Te=T("arrow-left","IconArrowLeft",[["path",{d:"M5 12l14 0",key:"svg-0"}],["path",{d:"M5 12l6 6",key:"svg-1"}],["path",{d:"M5 12l6 -6",key:"svg-2"}]]),_e=T("chevron-left","IconChevronLeft",[["path",{d:"M15 6l-6 6l6 6",key:"svg-0"}]]),Ee=T("pin-filled","IconPinFilled",[["path",{d:"M15.113 3.21l.094 .083l5.5 5.5a1 1 0 0 1 -1.175 1.59l-3.172 3.171l-1.424 3.797a1 1 0 0 1 -.158 .277l-.07 .08l-1.5 1.5a1 1 0 0 1 -1.32 .082l-.095 -.083l-2.793 -2.792l-3.793 3.792a1 1 0 0 1 -1.497 -1.32l.083 -.094l3.792 -3.793l-2.792 -2.793a1 1 0 0 1 -.083 -1.32l.083 -.094l1.5 -1.5a1 1 0 0 1 .258 -.187l.098 -.042l3.796 -1.425l3.171 -3.17a1 1 0 0 1 1.497 -1.26z",fill:"currentColor",key:"svg-0",strokeWidth:"0"}]]),Ne=T("pin","IconPin",[["path",{d:"M15 4.5l-4 4l-4 1.5l-1.5 1.5l7 7l1.5 -1.5l1.5 -4l4 -4",key:"svg-0"}],["path",{d:"M9 15l-4.5 4.5",key:"svg-1"}],["path",{d:"M14.5 4l5.5 5.5",key:"svg-2"}]]);const Be=({setMediaAct:s,media:e,currentNum:n})=>{const[l,o]=u.useState(0);u.useEffect(()=>{n!==void 0&&o(n)},[n]);const i=r=>{const h=(l+r+e.length)%e.length;o(h),s&&s(e[h])},c={width:"100%",height:"100%"},d={enter:r=>({x:r>0?500:-500,opacity:1}),center:{x:0,opacity:1},exit:r=>({x:r<0?500:-500,opacity:1})};return t.jsxs(j,{justifyContent:"center",alignItems:"center",position:"relative",width:c.width,height:c.height,overflow:"hidden",children:[t.jsx(ie,{custom:l,children:e.map((r,h)=>t.jsx(ce.div,{custom:h-l,variants:d,initial:"enter",animate:"center",exit:"exit",transition:{x:{type:"spring",stiffness:300,damping:30},opacity:{duration:.2}},style:{position:"absolute",cursor:"pointer",width:"100%",height:"100%",display:h===l?"block":"none"},onClick:()=>{window.open(r.imageUrl)},children:je(r.imageUrl)?t.jsx(Me,{src:r.imageUrl,alt:`image-${r.id}`,width:"100%",height:"100%",objectFit:"contain"}):t.jsx("video",{style:{objectFit:"contain"},width:"100%",height:"100%",src:r.imageUrl,loop:!0,autoPlay:!0,muted:!0,children:t.jsx("track",{kind:"captions"})})},r.id))}),t.jsx(w,{size:"sm",color:"white",bgColor:"whiteAlpha.400","aria-label":"Previous image",icon:t.jsx(_e,{}),onClick:()=>i(-1),position:"absolute",left:"0",zIndex:"2"}),t.jsx(w,{size:"sm",color:"white",bgColor:"whiteAlpha.400","aria-label":"Next image",icon:t.jsx(be,{}),onClick:()=>i(1),position:"absolute",right:"0",zIndex:"2"})]})};function Ae(s){const e=s.split(".").pop();return fetch(s).then(n=>{if(!n.ok)throw new Error("Network response was not ok");return n.blob()}).then(async n=>{const l=s.split("/").pop()??"",o=new File([n],l);if(Ie(s))return Ce(o);if(e==="webp")return ke(o);const i=await Pe(o),c=JSON.parse(i==null?void 0:i.prompt),d=JSON.parse(i==null?void 0:i.workflow);return{prompt:c,workflow:d}})}const M=s=>{if(typeof s=="string")return s};function F(s){navigator.clipboard.writeText(s).then(function(){}).catch(function(e){console.error("Unable to copy to clipboard: ",e)})}function ee(s,e){var h,g,f,y,v,p,b,k,a,x,A,K,G,$,U,m,H,R;const n=M((y=(f=s==null?void 0:s[(g=(h=e==null?void 0:e.inputs)==null?void 0:h.model)==null?void 0:g[0]])==null?void 0:f.inputs)==null?void 0:y.ckpt_name)??M((b=(p=s==null?void 0:s[((v=Object.keys(s))==null?void 0:v.find(O=>{var I,P;return(P=(I=s[O])==null?void 0:I.inputs)==null?void 0:P.ckpt_name}))??""])==null?void 0:p.inputs)==null?void 0:b.ckpt_name)??"",l=M((A=(x=s==null?void 0:s[(a=(k=e==null?void 0:e.inputs)==null?void 0:k.positive)==null?void 0:a[0]])==null?void 0:x.inputs)==null?void 0:A.text),o=M((U=($=s==null?void 0:s[(G=(K=e==null?void 0:e.inputs)==null?void 0:K.negative)==null?void 0:G[0]])==null?void 0:$.inputs)==null?void 0:U.text),i=["seed","sampler_name","scheduler","steps","cfg"].reduce((O,I)=>{var P,W;return(P=e==null?void 0:e.inputs)!=null&&P[I]?{...O,[I]:(W=e==null?void 0:e.inputs)==null?void 0:W[I]}:O},{}),c=(R=s==null?void 0:s[(H=(m=e==null?void 0:e.inputs)==null?void 0:m.latent_image)==null?void 0:H[0]])==null?void 0:R.inputs,d=c==null?void 0:c.width,r=c==null?void 0:c.height;return{ckptName:n,positive:l,negative:o,...i,width:d,height:r}}const Ke=s=>{var o;const{prompt:e,workflow:n}=s;console.log(n);const l=e==null?void 0:e[((o=Object.keys(e))==null?void 0:o.find(i=>e[i].class_type==="KSampler"))??""];return ee(e,l)},Ge=({metaData:s})=>{const e=Ke(s);return t.jsxs(D,{spacing:2,align:"stretch",children:[t.jsx(J,{children:t.jsx(N,{size:"sm",onClick:()=>F(JSON.stringify(e)),children:"Copy all"})}),Object.keys(e??{}).map(n=>{var l,o;return t.jsxs(j,{gap:2,children:[t.jsxs(j,{gap:1,alignItems:"center",flexBasis:"200px",children:[n,t.jsx(w,{size:"xm",onClick:()=>F((e==null?void 0:e[n])??""),"aria-label":"copy text",icon:t.jsx(V,{}),variant:"ghost"})]}),(l=e==null?void 0:e[n])!=null&&l.length&&((o=e==null?void 0:e[n])==null?void 0:o.length)>300?t.jsx(B,{readOnly:!0,value:e==null?void 0:e[n]}):t.jsx(L,{readOnly:!0,value:e==null?void 0:e[n]})]},`meta${n}`)})]})},$e=s=>{var e,n,l;return((l=(n=(e=Object.keys(s==null?void 0:s.prompt))==null?void 0:e.filter)==null?void 0:n.call(e,o=>{var i,c;return((c=(i=s==null?void 0:s.prompt)==null?void 0:i[o])==null?void 0:c.class_type)==="KSampler"}))==null?void 0:l.length)>1},Ue=s=>{const{prompt:e}=s,n=Object.keys(e);return(n==null?void 0:n.filter(o=>{var i;return((i=e==null?void 0:e[o])==null?void 0:i.class_type)==="KSampler"})).reduce((o,i,c)=>{const d=e==null?void 0:e[i],r=ee(e,d),h=Object.keys(r).reduce((g,f)=>({...g,[`${f}_${c+1}`]:r==null?void 0:r[f]}),{});return{...o,...h}},{})},me=({metaData:s})=>{var n;const e=Ue(s);return t.jsxs(D,{spacing:2,align:"stretch",children:[t.jsx(J,{children:t.jsx(N,{size:"sm",onClick:()=>F(JSON.stringify(e)),children:"Copy all"})}),(n=Object.keys(e??{}))==null?void 0:n.filter(l=>!!(e!=null&&e[l])).map(l=>{var o,i;return t.jsxs(j,{gap:2,children:[t.jsxs(j,{gap:1,alignItems:"center",flexBasis:"200px",children:[l,t.jsx(w,{size:"xm",onClick:()=>F((e==null?void 0:e[l])??""),"aria-label":"copy text",icon:t.jsx(V,{}),variant:"ghost"})]}),(o=e==null?void 0:e[l])!=null&&o.length&&((i=e==null?void 0:e[l])==null?void 0:i.length)>300?t.jsx(B,{readOnly:!0,value:e==null?void 0:e[l]}):t.jsx(L,{readOnly:!0,value:e==null?void 0:e[l]})]},`meta${l}`)})]})},He=({media:s})=>{const[e,n]=u.useState(),l=async o=>{try{const i=await Ae(`/workspace/view_media?filename=${o.localPath}`);n(i)}catch(i){console.log(i)}};return u.useEffect(()=>{s&&l(s)},[s]),t.jsxs(j,{overflowY:"auto",mb:4,direction:"column",gap:2,flex:1,children:[t.jsxs(ze,{alignItems:"center",columns:2,spacing:2,children:[t.jsxs(j,{alignItems:"center",gap:1,children:[t.jsx(z,{children:s==null?void 0:s.localPath}),t.jsx(C,{label:"Donwload image from gallery",children:t.jsx(E,{href:`/workspace/view_media?filename=${s==null?void 0:s.localPath}`,download:s==null?void 0:s.localPath,children:t.jsx(w,{size:"sm",icon:t.jsx(Z,{size:19}),"aria-label":"donwload image from gallery"})})})]}),t.jsxs(j,{gap:1,alignItems:"center",children:[t.jsx(z,{children:"Create Time:"}),t.jsx(z,{children:Y((s==null?void 0:s.createTime)??0,!0)})]})]}),(()=>{if(!s||!e)return null;const o={metaData:e,media:s};return $e(e)&&t.jsx(me,{...o})||t.jsx(Ge,{...o})})()]})},Re=({mediaList:s,media:e})=>{const[n,l]=u.useState();return u.useEffect(()=>{e&&l(e)},[e]),t.jsxs(j,{gap:3,h:"100%",children:[t.jsx(j,{flex:1,children:t.jsx(Be,{media:s.map(o=>({id:o.id,imageUrl:`/workspace/view_media?filename=${o.localPath}`})),currentNum:s==null?void 0:s.findIndex(o=>o.id===(n==null?void 0:n.id)),setMediaAct:o=>l(s==null?void 0:s.find(i=>i.id===o.id))})}),t.jsx(He,{media:n})]})},We=({media:s,isSelecting:e,selectedID:n,onClickMedia:l,onRefreshImagesList:o,coverPath:i,setCoverPath:c})=>{const{curFlowID:r,loadFilePath:h}=u.useContext(Q),{showDialog:g}=re();if(s.localPath==null)return null;const f=i!=null&&i===s.localPath;if(r==null)return null;const y=t.jsxs(E,{isExternal:!0,onClick:()=>l(s),position:"relative",children:[e&&t.jsx(q,{isChecked:n.includes(s.id),position:"absolute",top:2,left:2}),t.jsx(Oe,{mediaLocalPath:s.localPath,size:180,onBrokenLink:()=>{},autoPlay:!0,isPreview:!0})]});return t.jsxs(we,{width:180,mb:2,children:[t.jsx(C,{label:Y(s.createTime,!0),children:y}),t.jsx(C,{label:s.localPath,children:t.jsx(z,{color:"GrayText",noOfLines:1,children:s.localPath})}),t.jsxs(S,{hidden:e,gap:0,children:[t.jsx(C,{label:"Set as cover",children:t.jsx(w,{size:"sm",variant:"ghost",icon:f?t.jsx(Ee,{size:19}):t.jsx(Ne,{size:19}),"aria-label":"set as cover",onClick:()=>{var v;(v=_)==null||v.updateFlow(r,{coverMediaPath:s.localPath}),c(s.localPath)}})}),t.jsx(N,{flexGrow:1,onClick:()=>g("How do you want to load this workflow?",[{label:"Load in new workflow",onClick:()=>{h(s.localPath)},colorScheme:"teal"},{label:"Overwrite current workflow",onClick:()=>h(s.localPath,!0),colorScheme:"red"}]),size:"sm",children:"Load"}),t.jsx(C,{label:"Donwload image from gallery",children:t.jsx(E,{href:`/workspace/view_media?filename=${s.localPath}`,download:s.localPath,children:t.jsx(w,{size:"sm",variant:"ghost",icon:t.jsx(Z,{size:19}),"aria-label":"donwload image from gallery"})})}),t.jsx(C,{label:"Remove image from gallery",children:t.jsx(w,{size:"sm",variant:"ghost",icon:t.jsx(ve,{size:19}),"aria-label":"remove image from gallery",colorScheme:"red",onClick:async()=>{var p,b;confirm("Are you sure to remove this image from gallery? (won't delete image on your disk)")&&(await((p=X)==null?void 0:p.delete(s.id)),f&&(await((b=_)==null?void 0:b.updateFlow(r,{coverMediaPath:void 0})),c("")),o())}})})]})]})},Je=We;function ss({onclose:s}){const{curFlowID:e}=u.useContext(Q),[n,l]=u.useState(""),[o,i]=u.useState([]),[c,d]=u.useState(!1),[r,h]=u.useState(""),[g,f]=u.useState([]),[y,v]=u.useState(),p=async()=>{var x;if(e==null)return;const a=await((x=X)==null?void 0:x.listByWorkflowID(e));f(a??[])};if(u.useEffect(()=>{var a;p(),e&&((a=_)==null||a.get(e).then(x=>{x&&(l(x.name),x!=null&&x.coverMediaPath&&h(x==null?void 0:x.coverMediaPath))}))},[]),e==null)return null;const b=a=>{if(c){o.includes(a.id)?i(o.filter(x=>x!==a.id)):i([...o,a.id]);return}v(a)},k=g.length>0&&o.length===g.length;return t.jsxs(ae,{isOpen:!0,onClose:s,blockScrollOnMount:!0,children:[t.jsx(he,{}),t.jsxs(xe,{width:"90%",maxWidth:"90vw",height:"90vh",children:[t.jsxs(ue,{children:[t.jsx(S,{gap:2,mb:2,children:t.jsxs(ye,{size:"md",mr:2,children:[!!y&&t.jsx(w,{onClick:()=>v(void 0),variant:"ghost",mr:1,"aria-label":"back",icon:t.jsx(Te,{})}),"Gallery - ",n]})}),c&&t.jsxs(S,{gap:3,children:[t.jsx(q,{isChecked:k,onChange:()=>{i(k?[]:g.map(a=>a.id))},children:"All"}),t.jsxs(z,{fontSize:16,children:[o.length," Selected"]}),t.jsx(w,{size:"sm",icon:t.jsx(pe,{size:19}),onClick:()=>d(!1),"aria-label":"cancel"})]})]}),t.jsx(de,{}),t.jsx(ge,{overflowY:"auto",children:y?t.jsx(Re,{mediaList:g,media:y}):t.jsx(S,{wrap:"wrap",children:g.map(a=>t.jsx(Je,{selectedID:o,media:a,isSelecting:c,onClickMedia:b,onRefreshImagesList:p,coverPath:r,setCoverPath:h},a.id))})})]})]})}export{ss as default};
