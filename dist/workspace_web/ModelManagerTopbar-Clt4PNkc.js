import{f as k,r as u,j as e,b as S,d as B,Z as A,c as he,o as q,e as J,g as me,a7 as pe,B as _,a3 as z,a8 as fe,G as Q,a9 as ge,J as X,L as Z,N as xe,T as je,M as ye,H as ve,K as _e,P as we,R as Se,_ as be}from"./input.js";import{ad as Me,ac as Ce,A as Ie,ae as P,F as D,T as I,B as ee,a2 as te,n as se,r as F,N as ke,H as T,o as Le,af as Te,ag as Ee,a9 as ne,ah as De,ai as Pe}from"./App-Eqg3V87d.js";import{I as ae,G as Re}from"./chunk-JARCRF6W-po8hqWTL.js";import{app as E}from"/scripts/app.js";import{api as R}from"/scripts/api.js";import{u as oe}from"./chunk-6RSEZNRH-3Efv3ksN.js";var re=k(function(s,r){const{spacing:a="0.5rem",spacingX:o,spacingY:n,children:d,justify:c,direction:l,align:i,className:h,shouldWrapChildren:f,...x}=s,v=u.useMemo(()=>f?u.Children.map(d,(j,y)=>e.jsx(O,{children:j},y)):d,[d,f]);return e.jsx(S.div,{ref:r,className:B("chakra-wrap",h),...x,children:e.jsx(S.ul,{className:"chakra-wrap__list",__css:{display:"flex",flexWrap:"wrap",justifyContent:c,alignItems:i,flexDirection:l,listStyleType:"none",gap:a,columnGap:o,rowGap:n,padding:"0"},children:v})})});re.displayName="Wrap";var O=k(function(s,r){const{className:a,...o}=s;return e.jsx(S.li,{ref:r,__css:{display:"flex",alignItems:"flex-start"},className:B("chakra-wrap__listitem",a),...o})});O.displayName="WrapItem";function $(t){return Ce(t,s=>s==="auto"?"auto":`span ${s}/span ${s}`)}var le=k(function(s,r){const{area:a,colSpan:o,colStart:n,colEnd:d,rowEnd:c,rowSpan:l,rowStart:i,...h}=s,f=Me({gridArea:a,gridColumn:$(o),gridRow:$(l),gridColumnStart:n,gridColumnEnd:d,gridRowStart:i,gridRowEnd:c});return e.jsx(S.div,{ref:r,__css:f,...h})});le.displayName="GridItem";function Ae(t,s,r){return(t-s)*100/(r-s)}A({"0%":{strokeDasharray:"1, 400",strokeDashoffset:"0"},"50%":{strokeDasharray:"400, 400",strokeDashoffset:"-100"},"100%":{strokeDasharray:"400, 400",strokeDashoffset:"-260"}});A({"0%":{transform:"rotate(0deg)"},"100%":{transform:"rotate(360deg)"}});var Ne=A({"0%":{left:"-40%"},"100%":{left:"100%"}}),Be=A({from:{backgroundPosition:"1rem 0"},to:{backgroundPosition:"0 0"}});function ze(t){const{value:s=0,min:r,max:a,valueText:o,getValueText:n,isIndeterminate:d,role:c="progressbar"}=t,l=Ae(s,r,a);return{bind:{"data-indeterminate":d?"":void 0,"aria-valuemax":a,"aria-valuemin":r,"aria-valuenow":d?void 0:s,"aria-valuetext":(()=>{if(s!=null)return typeof n=="function"?n(s,l):o})(),role:c},percent:l,value:s}}var[Oe,Ge]=he({name:"ProgressStylesContext",errorMessage:`useProgressStyles returned is 'undefined'. Seems you forgot to wrap the components in "<Progress />" `}),Ue=k((t,s)=>{const{min:r,max:a,value:o,isIndeterminate:n,role:d,...c}=t,l=ze({value:o,min:r,max:a,isIndeterminate:n,role:d}),h={height:"100%",...Ge().filledTrack};return e.jsx(S.div,{ref:s,style:{width:`${l.percent}%`,...c.style},...l.bind,...c,__css:h})}),ie=k((t,s)=>{var r;const{value:a,min:o=0,max:n=100,hasStripe:d,isAnimated:c,children:l,borderRadius:i,isIndeterminate:h,"aria-label":f,"aria-labelledby":x,"aria-valuetext":v,title:j,role:y,...p}=q(t),m=J("Progress",t),M=i??((r=m.track)==null?void 0:r.borderRadius),L={animation:`${Be} 1s linear infinite`},g={...!h&&d&&c&&L,...h&&{position:"absolute",willChange:"left",minWidth:"50%",animation:`${Ne} 1s ease infinite normal none running`}},C={overflow:"hidden",position:"relative",...m.track};return e.jsx(S.div,{ref:s,borderRadius:M,__css:C,...p,children:e.jsxs(Oe,{value:m,children:[e.jsx(Ue,{"aria-label":f,"aria-labelledby":x,"aria-valuetext":v,min:o,max:n,value:a,isIndeterminate:h,css:g,borderRadius:M,title:j,role:y}),l]})})});ie.displayName="Progress";var ce=k(function(s,r){const{children:a,placeholder:o,className:n,...d}=s;return e.jsxs(S.select,{...d,ref:r,className:B("chakra-select",n),children:[o&&e.jsx("option",{value:"",children:o}),a]})});ce.displayName="SelectField";function We(t,s){const r={},a={};for(const[o,n]of Object.entries(t))s.includes(o)?r[o]=n:a[o]=n;return[r,a]}var G=k((t,s)=>{var r;const a=J("Select",t),{rootProps:o,placeholder:n,icon:d,color:c,height:l,h:i,minH:h,minHeight:f,iconColor:x,iconSize:v,...j}=q(t),[y,p]=We(j,pe),m=Ie(p),M={width:"100%",height:"fit-content",position:"relative",color:c},L={paddingEnd:"2rem",...a.field,_focus:{zIndex:"unset",...(r=a.field)==null?void 0:r._focus}};return e.jsxs(S.div,{className:"chakra-select__wrapper",__css:M,...y,...o,children:[e.jsx(ce,{ref:s,height:i??l,minH:h??f,placeholder:n,...m,__css:L,children:t.children}),e.jsx(de,{"data-disabled":me(m.disabled),...(x||c)&&{color:x||c},__css:a.icon,...v&&{fontSize:v},children:d})]})});G.displayName="Select";var He=t=>e.jsx("svg",{viewBox:"0 0 24 24",...t,children:e.jsx("path",{fill:"currentColor",d:"M16.59 8.59L12 13.17 7.41 8.59 6 10l6 6 6-6z"})}),Ve=S("div",{baseStyle:{position:"absolute",display:"inline-flex",alignItems:"center",justifyContent:"center",pointerEvents:"none",top:"50%",transform:"translateY(-50%)"}}),de=t=>{const{children:s=e.jsx(He,{}),...r}=t,a=u.cloneElement(s,{role:"presentation",className:"chakra-select__icon",focusable:!1,"aria-hidden":!0,style:{width:"1em",height:"1em",color:"currentColor"}});return e.jsx(Ve,{...r,className:"chakra-select__icon-wrapper",children:u.isValidElement(s)?a:null})};de.displayName="SelectIcon";function Fe({selectedModel:t,setSelectedModel:s,modelTypeList:r}){const a=o=>{s(o)};return e.jsx(re,{children:r.map(o=>e.jsx(O,{children:e.jsx(_,{colorScheme:"blue",variant:t===o?"solid":"outline",onClick:()=>a(o),size:"sm",children:o})}))})}const $e={checkpoints:"CheckpointLoaderSimple",vae:"VAELoader",loras:"LoraLoader",controlnet:"ControlNetLoader",upscale_models:"UpscaleModelLoader"};function Ye({data:t}){const[s,r]=u.useState("https://image.civitai.com/xG1nkqKTMzGDvpLrqFT7WA/27fd7433-cb0a-4a87-88c1-21ccb2b1a842/width=450/00060-881622046.jpeg"),[a,o]=u.useState(!t.file_hash),[n,d]=u.useState();u.useEffect(()=>{o(!t.file_hash),c()},[t.file_hash]);const c=async()=>{var h,f;const i=await P.models.get(t.model_name+"@"+t.model_type);if(i!=null)d(i),(h=i.imageUrl)!=null&&h.length&&r(i.imageUrl);else if(t.file_hash!=null)try{const x=`https://civitai.com/api/v1/model-versions/by-hash/${t.file_hash}`,j=await(await fetch(x)).json(),y=(f=j==null?void 0:j.images)==null?void 0:f.at(0),p=y==null?void 0:y.url;p&&r(p),P.models.add({id:t.model_name+"@"+t.model_type,fileHash:t.file_hash,fileFolder:t.model_type,fileName:t.model_name,civitModelID:j.modelId,civitModelVersionID:j.id,imageUrl:p??null})}catch{}},l=i=>{const h=$e[t.model_type];h&&(i.dataTransfer.setData("eventName","WorkspaceManagerAddNode"),i.dataTransfer.setData("modelRelativePath",t.model_name+t.model_extension),i.dataTransfer.setData("nodeType",h))};return a?e.jsxs(D,{position:"relative",borderRadius:4,bg:"rgba(0, 0, 0, 0.5)",height:178,justifyContent:"center",alignItems:"center",children:[e.jsx(z,{}),e.jsx(I,{position:"absolute",bottom:"0",left:"0",right:"0",bg:"rgba(0, 0, 0, 0.5)",color:"white",textAlign:"center",p:"0",fontSize:12,borderBottomRightRadius:4,borderBottomLeftRadius:4,children:t.model_name})]}):e.jsxs(ee,{position:"relative",borderRadius:4,draggable:!0,onDragStart:l,children:[e.jsx(ae,{src:s,draggable:!1,boxSize:"100%",height:178,objectFit:"cover",borderRadius:4,onClick:()=>{(n==null?void 0:n.civitModelID)==null||(n==null?void 0:n.civitModelVersionID)==null||window.open(`https://civitai.com/models/${n==null?void 0:n.civitModelID}?modelVersionId=${n==null?void 0:n.civitModelVersionID}`)}}),e.jsx(I,{position:"absolute",bottom:"0",left:"0",right:"0",bg:"rgba(0, 0, 0, 0.5)",color:"white",textAlign:"center",p:"0",fontSize:12,borderBottomRightRadius:4,borderBottomLeftRadius:4,children:t.model_name})]})}function Ke({list:t}){return e.jsx(Re,{templateColumns:"repeat(3, 1fr)",gap:1,marginTop:2,children:t.map(s=>e.jsx(le,{children:e.jsx(Ye,{data:s},s.model_name)}))})}const qe=async t=>{window.dispatchEvent(new CustomEvent("model_install_message",{detail:`Installing model ${t.filename} to ${t.save_path}, check progress in the server console.`}));try{const r=await(await R.fetchApi("/model_manager/install_model",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})).text();window.dispatchEvent(new CustomEvent("model_install_message",{detail:r}))}catch(s){console.error("Failed to connect to the server:",s)}};function Y(t,s=1){const o=t/1024;return o>=1024?(o/1024).toFixed(s)+" GB":o.toFixed(s)+" MB"}const K=280;function Je({model:t,onClickInstallModel:s,installing:r}){var f,x,v,j,y;const a=(j=(v=(x=(f=t.modelVersions)==null?void 0:f.at(0))==null?void 0:x.images)==null?void 0:v.at(0))==null?void 0:j.url,o=t.modelVersions,n=o==null?void 0:o.map(p=>{var m;return(m=p==null?void 0:p.files)==null?void 0:m.at(0)}),[d,c]=u.useState(((y=n==null?void 0:n.at(0))==null?void 0:y.name)??""),l=n==null?void 0:n.find(p=>(p==null?void 0:p.name)===d),i=()=>{window.open(`https://civitai.com/models/${t.id}`)},h=u.useCallback(()=>{if(l==null){console.error("no file is find by name",d);return}s(l,t)},[d]);return e.jsxs(te,{width:K,justifyContent:"space-between",mb:2,gap:1,children:[e.jsx(ae,{borderRadius:3,boxSize:K+"px",objectFit:"cover",src:a,alt:"model cover image",cursor:"pointer",onClick:()=>i()}),e.jsxs(se,{p:1,children:[e.jsx(F,{label:t.name,children:e.jsx(I,{fontWeight:500,noOfLines:1,children:t.name})}),e.jsxs(D,{justifyContent:"space-between",alignItems:"center",children:[e.jsx(_,{borderRadius:14,noOfLines:1,size:"xs",colorScheme:"teal",maxWidth:"40%",flexShrink:1,variant:"outline",px:1,cursor:"text",children:e.jsx(I,{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",children:t.type})}),e.jsx(_,{leftIcon:e.jsx(ke,{size:18}),iconSpacing:1,borderRadius:10,size:"sm",py:1,colorScheme:"teal",type:"submit",onClick:()=>h(),isDisabled:!!(d&&r.includes(d)),children:"Install"})]}),e.jsxs(T,{children:[e.jsx(G,{size:"md",style:{paddingLeft:4},onChange:p=>{c(p.target.value)},children:n==null?void 0:n.map(p=>{const m=p==null?void 0:p.name;return m?e.jsx("option",{value:m,style:{padding:0},children:m},p.id):null})}),(l==null?void 0:l.sizeKB)&&e.jsx(F,{label:Y(l.sizeKB),children:e.jsx(I,{flexShrink:1,noOfLines:1,width:"40%",children:Y(l.sizeKB)})})]})]})]})}function Qe({searchQuery:t,setSearchQuery:s,onSearch:r}){return e.jsxs(D,{gap:1,alignItems:"center",grow:1,children:[e.jsx(Le,{placeholder:"Search models in CivitAI",width:"60%",value:t,onChange:a=>s(a.target.value),onKeyUp:a=>{a.code==="Enter"&&r()}}),e.jsx(_,{size:"sm",onClick:()=>r(),colorScheme:"teal",children:"Search"})]})}function Xe({isOpen:t,onClose:s,selectFolder:r}){const[a,o]=u.useState(""),[n,d]=u.useState([]),c=u.useRef(null);u.useEffect(()=>{l()},[]);const l=async()=>{const i=await Te();i&&d(i.filter(h=>!["custom_nodes","config","saved_prompts"].includes(h)))};return e.jsx(fe,{isOpen:t,leastDestructiveRef:c,onClose:s,children:e.jsx(Q,{children:e.jsxs(ge,{children:[e.jsx(X,{fontSize:"lg",fontWeight:"bold",children:"Choose Folder"}),e.jsx(Z,{children:e.jsx(G,{placeholder:"Select option",value:a,onChange:i=>o(i.target.value),children:n.map(i=>e.jsx("option",{value:i,children:i}))})}),e.jsxs(xe,{children:[e.jsx(_,{ref:c,onClick:s,children:"Cancel"}),e.jsx(_,{onClick:()=>r(a),ml:3,children:"Confirm"})]})]})})})}function Ze(){const{colorMode:t}=je(),s=oe(),[r,a]=u.useState([]);return u.useEffect(()=>{R.addEventListener("download_progress",o=>{a(o.detail)}),R.addEventListener("download_error",o=>{s({title:"Download Error",description:o.detail,status:"error",duration:4e3,isClosable:!0})})},[]),e.jsx(se,{spacing:5,pos:"absolute",bottom:"0",left:"0",width:"50%",zIndex:80,backgroundColor:t==="light"?"white":"#242424",paddingX:5,children:r.map(({save_path:o,progress:n})=>e.jsxs(T,{children:[e.jsx(I,{fontSize:16,width:"40%",children:o.replace(/^.*[\\/]/,"")}),e.jsx(ie,{isIndeterminate:!n,hasStripe:!0,width:"50%",value:n}),e.jsxs(I,{fontSize:16,width:"10%",children:[n.toFixed(1),"%"]})]}))})}const et=["Checkpoint","TextualInversion","Hypernetwork","LORA","Controlnet","Upscaler","VAE"],tt=2,st={Checkpoint:"checkpoints",TextualInversion:"embeddings",Hypernetwork:"hypernetworks",LORA:"loras",Controlnet:"controlnet",Upscaler:"upscale_models",VAE:"vae"};function nt({onclose:t,searchQuery:s="",modelType:r}){const[a,o]=u.useState([]),[n,d]=u.useState(!1),[c,l]=u.useState(r),i=oe(),[h,f]=u.useState([]),[x,v]=u.useState(s),{isOpen:j,onOpen:y,onClose:p}=Ee(),m=u.useRef(),M=u.useCallback(async()=>{var V;d(!0);const g={limit:"30",nsfw:"false"};x!==""&&(g.query=x),c!=null&&(g.types=c);const b=`https://civitai.com/api/v1/models?${new URLSearchParams(g).toString()}`,w=await((V=P.cache)==null?void 0:V.get(b));if((w==null?void 0:w.value)!=null)try{const{data:N,timestamp:ue}=JSON.parse(w==null?void 0:w.value);if((Date.now()-ue)/(1e3*60*60*24)<tt){o(N),d(!1);return}}catch(N){console.error("err fetching cache",N)}const H=await(await fetch(b)).json();o(H.items),x===""&&P.cache.add({id:b,value:JSON.stringify({data:H.items,timestamp:Date.now()})}),d(!1)},[x,c]),L=g=>{var C;if(!((C=m.current)!=null&&C.downloadUrl)){console.error("file.downloadUrl is null");return}if(!m.current.name&&(m.current.name=m.current.downloadUrl.split("/").pop(),!m.current.name)){console.error("file.downloadUrl is malformed");return}i({title:"Installing...",description:m.current.name,status:"info",duration:4e3,isClosable:!0}),m.current.name!=null&&f(b=>{var w;return[...b,((w=m.current)==null?void 0:w.name)??""]}),qe({filename:m.current.name,name:m.current.name,save_path:g,url:m.current.downloadUrl}),p()},U=(g,C)=>{let b=st[C.type];m.current=g,b==null?y():L(b)},W=()=>{const g=prompt("Enter the URL to download");g&&(m.current={id:0,downloadUrl:g},y())};return u.useEffect(()=>{M()},[c]),e.jsxs(e.Fragment,{children:[e.jsxs(ye,{isOpen:!0,onClose:t,blockScrollOnMount:!0,children:[e.jsx(Q,{}),e.jsxs(ve,{width:"90%",maxWidth:"90vw",height:"90vh",children:[e.jsxs(X,{children:[e.jsxs(T,{gap:2,mb:2,alignItems:"center",children:[e.jsx(ne,{size:"md",mr:2,children:"Models"}),e.jsx(Qe,{searchQuery:x,setSearchQuery:v,onSearch:M}),e.jsx(_,{size:"sm",py:1,mr:8,onClick:W,children:"Custom URL Install"})]}),e.jsxs(T,{gap:2,mb:2,wrap:"wrap",children:[e.jsx(_,{size:"sm",py:1,onClick:()=>{l(void 0)},isActive:c==null,children:"All"}),et.map(g=>e.jsx(_,{size:"sm",py:1,isActive:c===g,onClick:()=>{l(g)},children:g}))]}),n&&e.jsx(z,{thickness:"4px",emptyColor:"gray.200",color:"pink.500",size:"lg"})]}),e.jsx(_e,{}),e.jsxs(Z,{overflowY:"auto",children:[e.jsx(T,{wrap:"wrap",children:a==null?void 0:a.map(g=>e.jsx(Je,{model:g,onClickInstallModel:U,installing:h},g.id))}),e.jsx(Ze,{})]})]})]}),e.jsx(Xe,{isOpen:j,onClose:p,selectFolder:L})]})}function at(){const[t,s]=u.useState(!1);return e.jsxs(e.Fragment,{children:[e.jsx(_,{size:"sm",colorScheme:"teal",onClick:()=>s(!0),children:"Install Models"}),t&&e.jsx(nt,{modelType:"Checkpoint",onclose:()=>s(!1)})]})}const ot=()=>{const[t,s]=u.useState(["checkpoints"]),[r,a]=u.useState([]),[o,n]=u.useState(!0);u.useEffect(()=>{d(),R.addEventListener("model_list",l=>{c(l.detail)})},[]);const d=async()=>{const l=await De();c(l)},c=async l=>{if(!l)return;n(!1);const i=Array.from(new Set(l.map(f=>f.model_type))),h=i.indexOf("checkpoints");h>=0&&i.splice(h,1),i.unshift("checkpoints"),s(i),a(l)};return{modelTypeList:t,modelsList:r,loading:o}};function rt({onClose:t}){const[s,r]=u.useState("checkpoints"),{loading:a,modelTypeList:o,modelsList:n}=ot(),[d,c]=u.useState([]);u.useEffect(()=>{const h=n.filter(f=>f.model_type===s);c(h)},[s,n]),u.useEffect(()=>(E.canvasEl.addEventListener("click",t),()=>{E.canvasEl.removeEventListener("click",t)}),[]);const l=440,i=()=>e.jsxs(e.Fragment,{children:[e.jsx(Fe,{modelTypeList:o,setSelectedModel:r,selectedModel:s}),e.jsx(Ke,{list:d}),a&&e.jsx(D,{justifyContent:"center",alignItems:"center",height:"100%",children:e.jsx(z,{})})]});return e.jsx(we,{children:e.jsx(ee,{style:{width:l},children:e.jsxs(te,{width:l,height:"100vh",p:4,gap:2,position:"fixed",top:0,left:0,shadow:"xl",zIndex:1e3,overflowY:"auto",children:[e.jsx(Pe,{children:e.jsxs(D,{justifyContent:"space-between",alignContent:"center",children:[e.jsx(ne,{size:"md",mr:2,children:"Models"}),e.jsx(at,{})]})}),i()]})})})}const lt=Se.lazy(()=>be(()=>import("./InstallMissingModelsButton-iH-14Oi5.js"),__vite__mapDeps([0,1,2,3,4,5,6])));function it({}){const[t,s]=u.useState(!1),r=async a=>{if(a.dataTransfer.getData("eventName")!=="WorkspaceManagerAddNode")return;const n=a.dataTransfer.getData("modelRelativePath"),d=a.dataTransfer.getData("nodeType"),c=LiteGraph.createNode(d);c.pos=[a.canvasX,a.canvasY],c.configure({widgets_values:[n]}),E.graph.add(c)};return u.useEffect(()=>(E.canvasEl.addEventListener("drop",r),()=>{E.canvasEl.removeEventListener("drop",r)}),[]),e.jsxs(T,{position:"fixed",top:2,right:2,gap:2,children:[e.jsx(lt,{}),e.jsx(_,{size:"sm",colorScheme:"blue","aria-label":"My models",onClick:()=>s(!0),px:1,children:"Models"}),t&&e.jsx(rt,{onClose:()=>s(!1)})]})}const xt=Object.freeze(Object.defineProperty({__proto__:null,default:it},Symbol.toStringTag,{value:"Module"}));export{le as G,at as I,xt as M,nt as a};
function __vite__mapDeps(indexes) {
  if (!__vite__mapDeps.viteFileDeps) {
    __vite__mapDeps.viteFileDeps = ["workspace_web/InstallMissingModelsButton-iH-14Oi5.js","workspace_web/input.js","workspace_web/App-Eqg3V87d.js","workspace_web/assets/App-JXePnJiV.css","workspace_web/chunk-JARCRF6W-po8hqWTL.js","workspace_web/chunk-NTCQBYKE-qX6uHBx-.js","workspace_web/chunk-6RSEZNRH-3Efv3ksN.js"]
  }
  return indexes.map((i) => __vite__mapDeps.viteFileDeps[i])
}