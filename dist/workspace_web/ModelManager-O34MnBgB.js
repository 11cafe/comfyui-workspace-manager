import{f as B,j as e,c as k,a as W,u as U,o as G,b as V,d as Y,r as o,l as K,H as w,I as $,B as O,e as I,C as q,g as J,S as X,T as E,h as C,F as T,i as Q,k as Z,M as F,m as ee,n as te,p as ne,q as se,s as oe,t as le,v as ae,w as re,x as ie,y as ce}from"./input.js";import{api as de}from"/scripts/api.js";import"/scripts/app.js";var N=B(function(n,a){const{children:l,placeholder:c,className:s,...r}=n;return e.jsxs(k.select,{...r,ref:a,className:W("chakra-select",s),children:[c&&e.jsx("option",{value:"",children:c}),l]})});N.displayName="SelectField";function ue(t,n){const a={},l={};for(const[c,s]of Object.entries(t))n.includes(c)?a[c]=s:l[c]=s;return[a,l]}var R=B((t,n)=>{var a;const l=U("Select",t),{rootProps:c,placeholder:s,icon:r,color:u,height:p,h:x,minH:i,minHeight:f,iconColor:g,iconSize:h,...y}=G(t),[S,m]=ue(y,K),j=V(m),d={width:"100%",height:"fit-content",position:"relative",color:u},b={paddingEnd:"2rem",...l.field,_focus:{zIndex:"unset",...(a=l.field)==null?void 0:a._focus}};return e.jsxs(k.div,{className:"chakra-select__wrapper",__css:d,...S,...c,children:[e.jsx(N,{ref:n,height:x??p,minH:i??f,placeholder:s,...j,__css:b,children:t.children}),e.jsx(A,{"data-disabled":Y(j.disabled),...(g||u)&&{color:g||u},__css:l.icon,...h&&{fontSize:h},children:r})]})});R.displayName="Select";var he=t=>e.jsx("svg",{viewBox:"0 0 24 24",...t,children:e.jsx("path",{fill:"currentColor",d:"M16.59 8.59L12 13.17 7.41 8.59 6 10l6 6 6-6z"})}),me=k("div",{baseStyle:{position:"absolute",display:"inline-flex",alignItems:"center",justifyContent:"center",pointerEvents:"none",top:"50%",transform:"translateY(-50%)"}}),A=t=>{const{children:n=e.jsx(he,{}),...a}=t,l=o.cloneElement(n,{role:"presentation",className:"chakra-select__icon",focusable:!1,"aria-hidden":!0,style:{width:"1em",height:"1em",color:"currentColor"}});return e.jsx(me,{...a,className:"chakra-select__icon-wrapper",children:o.isValidElement(n)?l:null})};A.displayName="SelectIcon";const M={x:0,y:0};function pe({children:t,onDragEnd:n}){const a=o.useRef(M),l=o.useRef(!1),[c,s]=o.useState(M),r=i=>{var f,g,h;if([(f=i.target)==null?void 0:f.id,(h=(g=i.target)==null?void 0:g.parentNode)==null?void 0:h.id].includes("dragPanelIcon")){a.current={x:i.clientX,y:i.clientY},l.current=!0,window.addEventListener("mousemove",u),window.addEventListener("mouseup",p);const y=document.getElementsByTagName("body")[0];y.style.userSelect="none"}},u=o.useCallback(i=>{const f={x:i.clientX-a.current.x,y:i.clientY-a.current.y};s(f)},[]),p=o.useCallback(()=>{s(f=>(n(f),M)),l.current=!1;const i=document.getElementsByTagName("body")[0];i.style.userSelect="auto",window.removeEventListener("mousemove",u),window.removeEventListener("mouseup",p)},[n,u]),x={transform:`translate(${c.x}px, ${c.y}px)`,zIndex:l.current?1e3:1};return e.jsx("div",{style:x,onMouseDown:r,children:t})}const H=o.createContext({setRoute:()=>{}}),z=200;function xe({}){const[t,n]=o.useState({top:0,left:0});o.useEffect(()=>{const r=()=>{const u=localStorage.getItem("model_manager_position");if(u!=null){n(JSON.parse(u));return}n({left:window.innerWidth-z,top:0})};return window.addEventListener("resize",r),r(),()=>window.removeEventListener("resize",r)},[]);const[a,l]=o.useState(!1),{setRoute:c}=o.useContext(H),s=o.useCallback(r=>{const{top:u=0,left:p=0}=t||{};let{top:x=0,left:i=600}=r??{};x+=u,i+=p;const f=document.documentElement.clientWidth,g=document.documentElement.clientHeight,h=document.getElementById("modelManagerPanel"),y=(h==null?void 0:h.offsetWidth)||392;x+36>g&&(x=g-36),i+y>=f&&(i=f-y);const S={top:Math.max(0,x),left:Math.max(0,i)};n(S),localStorage.setItem("model_manager_position",JSON.stringify(S))},[t]);return e.jsx(pe,{onDragEnd:r=>{s({top:r.y,left:r.x})},children:e.jsxs(w,{width:`${z}px`,style:{padding:2,position:"fixed",...t},justifyContent:"flex-end",alignItems:"center",gap:2,draggable:!1,id:"modelManagerPanel",onMouseEnter:()=>l(!0),onMouseLeave:()=>l(!1),children:[a?e.jsx($,{id:"dragPanelIcon",cursor:"move",size:15,color:"#FFF",width:"20px"}):e.jsx(O,{width:"20px"}),e.jsx(I,{size:"sm","aria-label":"models",onClick:()=>c("models"),px:2,children:"Models"})]})})}const fe=async t=>{try{const n=await de.fetchApi("/model_manager/install_model_stream",{method:"POST",body:JSON.stringify(t)});window.dispatchEvent(new CustomEvent("model_install_message",{detail:"Please check the server for progress logs"}))}catch(n){console.error("Failed to connect to the server:",n)}};function P(t,n=1){var a=t/1048576;return Number(a.toFixed(n))}const L=280;function ge({model:t,onClickInstallModel:n,installing:a}){var f,g,h,y,S;const l=(y=(h=(g=(f=t.modelVersions)==null?void 0:f.at(0))==null?void 0:g.images)==null?void 0:h.at(0))==null?void 0:y.url,c=t.modelVersions,s=c==null?void 0:c.map(m=>{var j;return(j=m==null?void 0:m.files)==null?void 0:j.at(0)}),[r,u]=o.useState(((S=s==null?void 0:s.at(0))==null?void 0:S.name)??""),p=s==null?void 0:s.find(m=>(m==null?void 0:m.name)===r),x=()=>{window.open(`https://civitai.com/models/${t.id}`)},i=o.useCallback(()=>{if(p==null){console.error("no file is find by name",r);return}n(p,t)},[r]);return e.jsxs(q,{width:L,justifyContent:"space-between",mb:2,gap:1,children:[e.jsx(J,{borderRadius:3,boxSize:L+"px",objectFit:"cover",src:l,alt:"model cover image",cursor:"pointer",onClick:()=>x()}),e.jsxs(X,{p:1,children:[e.jsx(E,{label:t.name,children:e.jsx(C,{fontWeight:500,noOfLines:1,children:t.name})}),e.jsxs(T,{justifyContent:"space-between",alignItems:"center",children:[e.jsx(I,{borderRadius:14,noOfLines:1,size:"xs",colorScheme:"teal",maxWidth:"40%",flexShrink:1,variant:"outline",px:1,cursor:"text",children:e.jsx(C,{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",children:t.type})}),e.jsx(I,{leftIcon:e.jsx(Q,{size:18}),iconSpacing:1,borderRadius:10,size:"sm",py:1,colorScheme:"teal",type:"submit",onClick:()=>i(),isDisabled:!!(r&&a.includes(r)),children:"Install"})]}),e.jsxs(w,{children:[e.jsx(R,{size:"md",style:{paddingLeft:4},onChange:m=>{u(m.target.value)},children:s==null?void 0:s.map(m=>{const j=m==null?void 0:m.name;return j?e.jsx("option",{value:j,style:{padding:0},children:j},m.id):null})}),(p==null?void 0:p.sizeKB)&&e.jsx(E,{label:P(p.sizeKB)+"GB",children:e.jsxs(C,{flexShrink:1,noOfLines:1,width:"40%",children:[P(p.sizeKB)," GB"]})})]})]})]})}function ye(){const[t,n]=o.useState(""),a=l=>{const r=l.detail.split(`
`).reverse().find(u=>u.trim()!=="");n(r??"")};return o.useEffect(()=>(window.addEventListener("model_install_message",a),()=>{window.removeEventListener("model_install_message",a)}),[]),e.jsx(w,{children:e.jsx(C,{fontWeight:"500",fontSize:18,py:2,children:t})})}function je({setSearchQuery:t}){const[n,a]=o.useState("");return e.jsxs(T,{gap:1,alignItems:"center",grow:1,children:[e.jsx(Z,{placeholder:"Search models in CivitAI",width:"60%",value:n,onChange:l=>a(l.target.value),onKeyUp:l=>{l.code==="Enter"&&t(n)}}),e.jsx(I,{size:"sm",onClick:()=>t(n),colorScheme:"teal",children:"Search"})]})}const Se=["Checkpoint","TextualInversion","Hypernetwork","LORA","Controlnet","Upscaler","VAE"],we={Checkpoint:"checkpoints",TextualInversion:"embeddings",Hypernetwork:"hypernetworks",LORA:"loras",Controlnet:"controlnet",Upscaler:"upscale_models",VAE:"vae"};function ve({onclose:t}){const[n,a]=o.useState([]),[l,c]=o.useState(!1),[s,r]=o.useState([]),[u,p]=o.useState(!1),[x,i]=o.useState("Checkpoint"),[f,g]=o.useState([]),[h,y]=o.useState(""),S=o.useCallback(async()=>{p(!0);const d={limit:"30",nsfw:"false",types:x};h!==""&&(d.query=h);const v=`https://civitai.com/api/v1/models?${new URLSearchParams(d).toString()}`,D=await(await fetch(v)).json();r(D.items),p(!1)},[h,x]),m=(d,b)=>{if(d.downloadUrl==null||d.name==null){console.error("file.downloadUrl or file.name is null");return}let v=we[b.type];v==null&&(v=prompt("What's the folder path under /ComfyUI/models you want to save the model? ")),v!=null&&(d.name!=null&&g(_=>[..._,d.name??""]),fe({filename:d.name,name:d.name,save_path:v,url:d.downloadUrl}))};o.useEffect(()=>{console.log("searchQuery",h),S()},[h,x]);const j=s.length>0&&n.length===s.length;return e.jsxs(F,{isOpen:!0,onClose:t,blockScrollOnMount:!0,children:[e.jsx(ee,{}),e.jsxs(te,{width:"90%",maxWidth:"90vw",height:"90vh",children:[e.jsxs(ne,{children:[e.jsxs(w,{gap:2,mb:2,alignItems:"center",children:[e.jsx(se,{size:"md",mr:2,children:"Models"}),e.jsx(je,{setSearchQuery:y})]}),e.jsx(ye,{}),e.jsxs(w,{gap:2,mb:2,wrap:"wrap",children:[e.jsx(I,{size:"sm",py:1,onClick:()=>{i(void 0)},isActive:x==null,children:"All"}),Se.map(d=>e.jsx(I,{size:"sm",py:1,isActive:x===d,onClick:()=>{i(d)},children:d}))]}),l&&e.jsxs(w,{gap:3,children:[e.jsx(oe,{isChecked:j,children:"All"}),e.jsxs(C,{fontSize:16,children:[n.length," Selected"]}),e.jsx(le,{size:"sm",icon:e.jsx(ae,{size:19}),onClick:()=>c(!1),"aria-label":"cancel"})]})]}),e.jsx(re,{}),e.jsxs(ie,{overflowY:"auto",children:[u&&e.jsx(ce,{thickness:"4px",emptyColor:"gray.200",color:"pink.500",size:"lg"}),e.jsx(w,{wrap:"wrap",children:s==null?void 0:s.map(d=>e.jsx(ge,{model:d,onClickInstallModel:m,installing:f},d.id))})]})]})]})}function Me(){const[t,n]=o.useState("root");return e.jsx(H.Provider,{value:{setRoute:n},children:e.jsxs(O,{style:{width:"100vh",position:"absolute",top:0,left:0,right:0},zIndex:1e3,draggable:!1,children:[e.jsx(xe,{}),t==="models"&&e.jsx(ve,{onclose:()=>n("root")})]})})}export{Me as default};
