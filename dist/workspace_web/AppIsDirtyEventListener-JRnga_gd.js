import{r as i,j as g}from"./input.js";import{app as n}from"/scripts/app.js";import{a6 as b,j as m,ar as S,o as y,E as v,A as c,as as E,B as A}from"./App-VDFuO2jE.js";import"/scripts/api.js";function W(l,f){const u=i.useRef(0),r=i.useCallback(()=>{u.current!==null&&(clearTimeout(u.current),u.current=0)},[]),d=i.useCallback((...w)=>{r(),u.current=setTimeout(()=>l(...w),f)},[l,f,r]);return i.useEffect(()=>()=>{r()},[]),[d,r]}function D(){const{setIsDirty:l,setRoute:f,saveCurWorkflow:u}=i.useContext(b),r=m();i.useEffect(()=>{const o=async e=>{switch(e){case v.SAVE:u();break;case v.SAVE_AS:f("saveAsModal");break}},t=n.graph.onAfterChange;n.graph.onAfterChange=function(){t==null||t.apply(n.canvas,arguments),p()},document.addEventListener("click",e=>{(n.canvas.node_over!=null||n.canvas.node_capturing_input!=null||n.canvas.node_widget!=null)&&p()}),document.addEventListener("keydown",async function(e){var a;if(document.visibilityState==="hidden")return;const s=await S(e);s?o(s):(a=e.target)!=null&&a.matches("input, textarea")&&Object.keys(n.canvas.selected_nodes??{}).length&&p()})},[]);const d=async()=>{var t,e,s,a;if(!((e=(t=c)==null?void 0:t.curWorkflow)!=null&&e.id))return;const o=JSON.stringify(n.graph.serialize());o!=null&&await((s=c)==null?void 0:s.updateFlow(c.curWorkflow.id,{json:o})),(a=E)==null||a.create({workflowID:c.curWorkflow.id,isAutoSave:!0,json:o}),l(!1),r({position:"bottom-left",duration:1e3,render:()=>g.jsx(A,{color:"white",p:3,children:"Auto saved"})})},[w,x]=W(d,1e3),p=async()=>{var t,e,s,a,h,k;if((e=(t=c)==null?void 0:t.curWorkflow)!=null&&e.saveLock)return;const o=await((s=y)==null?void 0:s.getSetting("autoSave"));if(!o){l(!0);return}(h=(a=c)==null?void 0:a.curWorkflow)!=null&&h.id&&o&&(await((k=c)==null?void 0:k.latestVersionCheck())?w():r({title:"Your changes cannot be saved!",description:"You are working on an outdated version. This workflow is changed by another tab. Please refresh to get the latest version.",status:"warning",isClosable:!0,duration:null}))};return null}export{D as default};
