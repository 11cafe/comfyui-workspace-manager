import{f as oe,n as pe,o as fe,j as e,g as te,e as ae,r as l,m as me,w as X,b as ge,h as L,a0 as Z,M as we,N as xe,O as je,Q as ve,S as ye}from"./input.js";import{B as be,A as ke,a4 as Se,a3 as P,af as z,am as Ce,g as W,H as G,ac as Ie,ay as ee,X as Re,f as De,k as H,F as se,aD as Ee,j as Ne,x as F,$ as Pe,aE as Te,aF as We,aG as _e,aH as Fe,h as Me,T as Oe,aI as ze,Y as Le}from"./App-1AImvRpr.js";import{a as Ae}from"./civitUtils-uJNBxoFV.js";import{I as He}from"./chunk-7D6N5TE5-fihyubSX.js";import{S as Ge,L as $e}from"./chunk-VTV6N5LE-7BSZDdqw.js";import{I as Be}from"./IconCopy-DxyTNBlz.js";var ne=oe(function(n,c){const i=pe("Badge",n),{className:s,...r}=fe(n);return e.jsx(te.span,{ref:c,className:ae("chakra-badge",n.className),...r,__css:{display:"inline-block",whiteSpace:"nowrap",verticalAlign:"middle",...i}})});ne.displayName="Badge";function Ue(t){return t&&X(t)&&X(t.target)}function Ve(t={}){const{onChange:n,value:c,defaultValue:i,name:s,isDisabled:r,isFocusable:o,isNative:k,...h}=t,[S,v]=l.useState(i||""),w=typeof c<"u",p=w?c:S,x=l.useRef(null),a=l.useCallback(()=>{const m=x.current;if(!m)return;let j="input:not(:disabled):checked";const T=m.querySelector(j);if(T){T.focus();return}j="input:not(:disabled)";const E=m.querySelector(j);E==null||E.focus()},[]),y=`radio-${l.useId()}`,C=s||y,I=l.useCallback(m=>{const j=Ue(m)?m.target.value:m;w||v(j),n==null||n(String(j))},[n,w]),f=l.useCallback((m={},j=null)=>({...m,ref:me(j,x),role:"radiogroup"}),[]),A=l.useCallback((m={},j=null)=>({...m,ref:j,name:C,[k?"checked":"isChecked"]:p!=null?m.value===p:void 0,onChange(E){I(E)},"data-radiogroup":!0}),[k,C,I,p]);return{getRootProps:f,getRadioProps:A,name:C,ref:x,focus:a,setValue:v,value:p,onChange:I,isDisabled:r,isFocusable:o,htmlProps:h}}var[Ke,ns]=ge({name:"RadioGroupContext",strict:!1}),re=oe((t,n)=>{const{colorScheme:c,size:i,variant:s,children:r,className:o,isDisabled:k,isFocusable:h,...S}=t,{value:v,onChange:w,getRootProps:p,name:x,htmlProps:a}=Ve(S),R=l.useMemo(()=>({name:x,size:i,onChange:w,colorScheme:c,value:v,variant:s,isDisabled:k,isFocusable:h}),[x,i,w,c,v,s,k,h]);return e.jsx(Ke,{value:R,children:e.jsx(te.div,{...p(a,n),className:ae("chakra-radio-group",o),children:r})})});re.displayName="RadioGroup";function qe({options:t,value:n,onChange:c}){const[i,s]=l.useState(!1),r=l.useRef(null),o=t.find(h=>h.value===n);l.useEffect(()=>{const h=S=>{r.current&&!r.current.contains(S.target)&&s(!1)};return document.addEventListener("mousedown",h),()=>{document.removeEventListener("mousedown",h)}},[r]);const k=()=>s(!i);return e.jsxs(be,{position:"relative",children:[e.jsx(L,{onClick:k,rightIcon:e.jsx(ke,{}),leftIcon:o==null?void 0:o.icon,children:o==null?void 0:o.label}),i&&e.jsx(Se,{gap:4,ref:r,mt:"2",shadow:"md",borderWidth:"1px",p:"2",position:"absolute",zIndex:100,children:t.map(h=>e.jsx(L,{onClick:()=>{s(!1),c(h.value)},leftIcon:h.icon,justifyContent:"flex-start",variant:"ghost",width:"full",children:h.label},h.label))})]})}async function Je(t,n,c){const i=await Ce.models.where("fileName").equals(t).toArray()??[];console.log("fetch modeldata",i);const s=i.at(0);return{name:t,nodeType:n,hash:(s==null?void 0:s.fileHash)??null,folder:(s==null?void 0:s.fileFolder)??null,url:s!=null&&s.civitModelVersionID?Ae(s.civitModelVersionID):(s==null?void 0:s.downloadUrl)??null,inputName:c,length:i.length}}async function Ye(t){var p,x;let n=[],c={};const i=[".ckpt",".pt",".bin",".pth",".safetensors"],s=[".jpeg",".jpg",".png",".gif",".webp"],r=(x=(p=P.graph.extra)==null?void 0:p[z])==null?void 0:x.deps,o=await P.graphToPrompt();Object.values(o.output).forEach(a=>{a.inputs&&Object.keys(a.inputs).forEach(R=>{var C,I;const y=(C=a.inputs)==null?void 0:C[R];typeof y=="string"&&(i.some(f=>y.endsWith(f))&&n.push(Je(y,a.class_type,R)),s.some(f=>y.endsWith(f))&&(c[y]=((I=r==null?void 0:r.images)==null?void 0:I[y])??{filename:y,nodeType:a.class_type}))})});const h=await fetch("workspace/fetch_node_repos",{method:"POST",body:JSON.stringify({nodes:t.map(a=>a.type)})}).then(a=>a.ok?a.json():[]).catch(a=>(console.error("Error fetching node repos",a),[])),S=await Promise.all(n),v={};S.forEach(a=>{v[a.name]=a});const w={};return Object.values(h).forEach(a=>{w[a.gitRepo]=a}),{models:v,images:c,nodeRepos:Object.values(w)}}function Qe({deps:t,setDeps:n,uploadingImage:c}){const i=l.useCallback(async()=>{const r=P.graph.serialize();Ye(r.nodes??[]).then(o=>{n(o)})},[]);l.useEffect(()=>{i()},[]);const s=Object.values((t==null?void 0:t.images)??{});return t?e.jsx(W,{gap:5,children:s.length>0&&e.jsxs(W,{children:[e.jsxs(G,{children:[e.jsxs(Ie,{size:"sm",children:["Images (",s.length,")"]}),e.jsx("p",{style:{color:"GrayText"},children:"Will be uploaded as url"})]}),c&&e.jsxs("span",{children:[e.jsx(Z,{size:"md",color:"teal.400"})," Uploading"]}),s.map(r=>e.jsxs(W,{children:[e.jsx("p",{children:r.filename}),e.jsx(He,{width:250,src:`/workspace/view_media?filename=${r.filename}&isPreview=true&isInput=true`})]},r.filename))]})}):e.jsx(Z,{size:"md",color:"teal.400"})}function rs({onClose:t}){var $,B,U,V,K;const[n,c,i]=ee("v"+Xe()),{saveCurWorkflow:s,setRoute:r}=l.useContext(Re),[o,k]=l.useState(),[h,S]=l.useState(!1),[v,w]=l.useState(!1),p=(B=($=H)==null?void 0:$.settings)==null?void 0:B.cloudHost,[x,a,R]=ee("PRIVATE"),[y,C]=l.useState("new_version"),I=l.useRef(""),f=(U=F)==null?void 0:U.curWorkflow,A=De(),[m,j]=l.useState(!0),T=async d=>{var b;const u=d.data;if(u.type!=="share_workflow_success")return;const g=u.localWorkflowID,N=u.version.id,D=u.version.workflowID;D&&g&&await((b=F)==null?void 0:b.updateMetaInfo(g,{cloudID:D,privacy:R.current})),E(),window.open(I.current+"/workflow/"+D+"/"+N,"_blank"),w(!1)};l.useEffect(()=>(E(),window.addEventListener("message",T),()=>{window.removeEventListener("message",T)}),[]);const E=async()=>{var u;const d=await((u=H)==null?void 0:u.getSetting("cloudHost"));d&&(I.current=d),f!=null&&f.cloudID&&f.cloudOrigin&&Fe(f).then(g=>{a(g)})},ie=d=>{navigator.clipboard.writeText(d).then(()=>{A({title:"Copied to clipboard",status:"success",duration:2e3,isClosable:!0})}).catch(u=>{console.error("Failed to copy text: ",u)})},le=async d=>{var J;w(!0);const u=Te(32),g=await((J=H)==null?void 0:J.getSetting("cloudHost"));let N;N=We();const D={id:_e(),workflowID:f.id,name:i.current,createTime:Date.now(),json:d??JSON.stringify(P.graph.serialize())},b=window.location.protocol,O=window.location.host,_=`${b}//${O}`,de=g+`/share_workflow_confirm/${u}?redirectUrl=${_}`,ue=window.open(de,"Share Workflow","width=800,height=800"),q=Y=>{var Q;if(Y.origin===g&&Y.data==="child_ready"){const he=(Q=F)==null?void 0:Q.curWorkflow;ue.postMessage({workflow:he,version:D,nodeDefs:N,privacy:R.current},g),window.removeEventListener("message",q)}};window.addEventListener("message",q)},ce=async()=>{var N,D;S(!0);const d=Object.values((o==null?void 0:o.images)??{}).filter(b=>!b.url).map(b=>b.filename),u=(o==null?void 0:o.images)??{};if(d.length){const O=await(await Pe("/workspace/upload_image",{method:"POST",body:JSON.stringify({images:d})})).json();Object.keys(O).forEach(_=>{u!=null&&u[_]&&(u[_].url=O[_])})}S(!1);const g=P.graph.serialize();(N=g.extra||(g.extra={}))[D=z]||(N[D]={}),g.extra[z].deps={models:(o==null?void 0:o.models)??{},images:u??{},nodeRepos:(o==null?void 0:o.nodeRepos)??[]},await P.graphToPrompt(P.graph).then(b=>{g.extra[z].apiPrompt=b.output}),await s(),le(JSON.stringify(g))},M=(K=(V=F)==null?void 0:V.curWorkflow)==null?void 0:K.cloudID;return e.jsxs(we,{isOpen:!0,onClose:t,size:"lg",children:[e.jsx(xe,{}),e.jsxs(je,{width:["98%","90%","50%"],maxWidth:"600px",children:[e.jsxs(ve,{children:[e.jsxs(se,{justifyContent:"space-between",children:[e.jsxs("p",{children:['Share "',f==null?void 0:f.name,'"']}),e.jsx(L,{colorScheme:"teal",onClick:ce,size:"sm",isDisabled:v,children:v?"Sharing":"Share"})]}),p&&e.jsxs(Me,{fontSize:16,color:"GrayText",fontWeight:400,children:["Share to ",new URL(p).host]})]}),e.jsx(ye,{pb:10,children:e.jsxs(W,{gap:5,children:[M==null?e.jsx(qe,{options:Ee,value:x,onChange:d=>{a(d)}}):e.jsx(Oe,{variant:"outline",borderRadius:"full",width:"fit-content",children:e.jsx(ze,{privacy:x,showEmoji:!0})}),M&&e.jsxs(G,{spacing:2,color:"teal.400",children:[e.jsxs($e,{wordBreak:"break-all",href:p+"/workflow/"+M,isExternal:!0,children:[p+"/workflow/"+M," ",e.jsx(Le,{size:20,style:{display:"inline-block",verticalAlign:"middle"}})]}),e.jsx(L,{size:"sm",leftIcon:e.jsx(Be,{size:18}),onClick:()=>{var d,u;ie(p+"/workflow/"+((u=(d=F)==null?void 0:d.curWorkflow)==null?void 0:u.cloudID))},children:"Copy link"})]}),e.jsx(re,{gap:4,onChange:d=>{C(d)},value:y,children:e.jsx(W,{children:e.jsxs(G,{mb:5,alignItems:"center",children:[e.jsx(Ne,{value:n,width:"60%",onFocus:()=>{C("new_version")},onChange:d=>{c(d.target.value)}}),e.jsx(se,{color:"green",children:e.jsx(ne,{colorScheme:"purple",children:"Version Name"})})]})})}),e.jsxs(W,{borderRadius:6,borderWidth:"1px",p:2,children:[e.jsx(Ge,{isChecked:m,onChange:()=>j(!m),fontWeight:"600",children:"Share input images"}),e.jsxs("span",{style:{color:"GrayText"},children:["If enabled your input images will be uploaded and shared to"," ",p]}),e.jsx(Qe,{deps:o??null,setDeps:k,uploadingImage:h})]})]})})]})]})}function Xe(){const t=new Date,n=t.getFullYear(),c=String(t.getMonth()+1).padStart(2,"0"),i=String(t.getDate()).padStart(2,"0");return`${n}-${c}-${i}`}export{rs as default};
