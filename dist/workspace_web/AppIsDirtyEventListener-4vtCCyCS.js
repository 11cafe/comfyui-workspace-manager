import{r as l,j as y}from"./input.js";import{app as o}from"/scripts/app.js";import{a6 as S,j as C,ar as E,as as A,E as g,o as W,A as c,at as j,B as x}from"./App-bqAziDgv.js";import"/scripts/api.js";function v(d,f){const i=l.useRef(0),u=l.useCallback(()=>{i.current!==null&&(clearTimeout(i.current),i.current=0)},[]),p=l.useCallback((...k)=>{u(),i.current=setTimeout(()=>d(...k),f)},[d,f,u]);return l.useEffect(()=>()=>{u()},[]),[p,u]}function F(){const{isDirty:d,setIsDirty:f,setRoute:i,saveCurWorkflow:u}=l.useContext(S),p=C();l.useEffect(()=>{const a=async e=>{switch(e){case g.SAVE:u();break;case g.SAVE_AS:i("saveAsModal");break}},s=o.canvas.onAfterChange;o.graph.onAfterChange=function(){s==null||s.apply(this,arguments),h()};const n=o.graph.onConfigure;o.graph.onConfigure=function(){n==null||n.apply(this,arguments),setTimeout(()=>{var t,r;E(o.graph.serialize(),JSON.parse(((r=(t=c)==null?void 0:t.curWorkflow)==null?void 0:r.json)??"{}"))||h()},1e3)},document.addEventListener("click",e=>{Object.keys(o.canvas.selected_nodes??{}).length&&(o.canvas.node_over!=null||o.canvas.node_capturing_input!=null||o.canvas.node_widget!=null)&&h()}),document.addEventListener("keydown",async function(e){var r;if(document.visibilityState==="hidden")return;const t=await A(e);t?a(t):(r=e.target)!=null&&r.matches("input, textarea")&&Object.keys(o.canvas.selected_nodes??{}).length&&h()})},[]);const k=async()=>{var s,n,e,t;if(!((n=(s=c)==null?void 0:s.curWorkflow)!=null&&n.id))return;const a=JSON.stringify(o.graph.serialize());a!=null&&await((e=c)==null?void 0:e.updateFlow(c.curWorkflow.id,{json:a})),(t=j)==null||t.create({workflowID:c.curWorkflow.id,isAutoSave:!0,json:a}),f(!1),p({position:"bottom-left",duration:1e3,render:()=>y.jsx(x,{color:"white",p:3,children:"Auto saved"})})},[b,D]=v(k,1e3),m=async()=>{var s,n,e,t,r,w;if((n=(s=c)==null?void 0:s.curWorkflow)!=null&&n.saveLock)return;const a=await((e=W)==null?void 0:e.getSetting("autoSave"));if(!a){!d&&f(!0);return}(r=(t=c)==null?void 0:t.curWorkflow)!=null&&r.id&&a&&(await((w=c)==null?void 0:w.latestVersionCheck())?b():p({title:"Your changes cannot be saved!",description:"You are working on an outdated version. This workflow is changed by another tab. Please refresh to get the latest version.",status:"warning",isClosable:!0,duration:null}))},[h,_]=v(m,500);return null}export{F as default};
