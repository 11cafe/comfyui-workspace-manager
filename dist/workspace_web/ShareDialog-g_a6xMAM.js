import{f as te,n as fe,o as ge,j as e,g as ae,e as ne,r as u,m as we,w as Q,b as xe,h as M,a0 as X,M as je,T as ve,N as ye,U as be,O as ke}from"./input.js";import{B as Se,z as Ce,a5 as Ie,f as P,H as A,ad as Re,a4 as E,ag as F,am as De,az as ee,W as Ee,e as Ne,F as se,aE as Pe,I as Te,h as oe,w as O,a0 as We,aF as Oe,aG as _e,aH as Fe,T as Me,k as ze,aI as Le,Z as Ae}from"./App-ZTJclgGW.js";import{I as Ge}from"./chunk-7D6N5TE5-wlKuxWhy.js";import{a as He}from"./civitUtils-T1Lq3reo.js";import{S as Ue,L as Be}from"./chunk-VTV6N5LE-qccSGxq6.js";import{I as Ve}from"./IconCopy-zZpZ6D5h.js";var re=te(function(i,l){const r=fe("Badge",i),{className:t,...s}=ge(i);return e.jsx(ae.span,{ref:l,className:ne("chakra-badge",i.className),...s,__css:{display:"inline-block",whiteSpace:"nowrap",verticalAlign:"middle",...r}})});re.displayName="Badge";function $e(o){return o&&Q(o)&&Q(o.target)}function Ke(o={}){const{onChange:i,value:l,defaultValue:r,name:t,isDisabled:s,isFocusable:m,isNative:y,...d}=o,[b,v]=u.useState(r||""),h=typeof l<"u",w=h?l:b,x=u.useRef(null),a=u.useCallback(()=>{const f=x.current;if(!f)return;let g="input:not(:disabled):checked";const T=f.querySelector(g);if(T){T.focus();return}g="input:not(:disabled)";const N=f.querySelector(g);N==null||N.focus()},[]),j=`radio-${u.useId()}`,p=t||j,I=u.useCallback(f=>{const g=$e(f)?f.target.value:f;h||v(g),i==null||i(String(g))},[i,h]),k=u.useCallback((f={},g=null)=>({...f,ref:we(g,x),role:"radiogroup"}),[]),z=u.useCallback((f={},g=null)=>({...f,ref:g,name:p,[y?"checked":"isChecked"]:w!=null?f.value===w:void 0,onChange(N){I(N)},"data-radiogroup":!0}),[y,p,I,w]);return{getRootProps:k,getRadioProps:z,name:p,ref:x,focus:a,setValue:v,value:w,onChange:I,isDisabled:s,isFocusable:m,htmlProps:d}}var[qe,rs]=xe({name:"RadioGroupContext",strict:!1}),ie=te((o,i)=>{const{colorScheme:l,size:r,variant:t,children:s,className:m,isDisabled:y,isFocusable:d,...b}=o,{value:v,onChange:h,getRootProps:w,name:x,htmlProps:a}=Ke(b),D=u.useMemo(()=>({name:x,size:r,onChange:h,colorScheme:l,value:v,variant:t,isDisabled:y,isFocusable:d}),[x,r,h,l,v,t,y,d]);return e.jsx(qe,{value:D,children:e.jsx(ae.div,{...w(a,i),className:ne("chakra-radio-group",m),children:s})})});ie.displayName="RadioGroup";function Je({options:o,value:i,onChange:l}){const[r,t]=u.useState(!1),s=u.useRef(null),m=o.find(d=>d.value===i);u.useEffect(()=>{const d=b=>{s.current&&!s.current.contains(b.target)&&t(!1)};return document.addEventListener("mousedown",d),()=>{document.removeEventListener("mousedown",d)}},[s]);const y=()=>t(!r);return e.jsxs(Se,{position:"relative",children:[e.jsx(M,{onClick:y,rightIcon:e.jsx(Ce,{}),leftIcon:m==null?void 0:m.icon,children:m==null?void 0:m.label}),r&&e.jsx(Ie,{gap:4,ref:s,mt:"2",shadow:"md",borderWidth:"1px",p:"2",position:"absolute",zIndex:100,children:o.map(d=>e.jsx(M,{onClick:()=>{t(!1),l(d.value)},leftIcon:d.icon,justifyContent:"flex-start",variant:"ghost",width:"full",children:d.label},d.label))})]})}function Ye({deps:o,uploadingImage:i}){const l=Object.values((o==null?void 0:o.images)??{});return o?e.jsx(P,{gap:5,children:l.length>0&&e.jsxs(P,{children:[e.jsxs(A,{children:[e.jsxs(Re,{size:"sm",children:["Images (",l.length,")"]}),e.jsx("p",{style:{color:"GrayText"},children:"Will be uploaded as url"})]}),i&&e.jsxs("span",{children:[e.jsx(X,{size:"md",color:"teal.400"})," Uploading"]}),l.map(r=>e.jsxs(P,{children:[e.jsx("p",{children:r.filename}),e.jsx(Ge,{width:250,src:`/workspace/view_media?filename=${r.filename}&isPreview=true&isInput=true`})]},r.filename))]})}):e.jsx(X,{size:"md",color:"teal.400"})}async function Ze(o,i,l){const r=await De.models.where("fileName").equals(o).toArray()??[],t=r.at(0);return{name:o,nodeType:i,hash:(t==null?void 0:t.fileHash)??null,folder:(t==null?void 0:t.fileFolder)??null,url:t!=null&&t.civitModelVersionID?He(t.civitModelVersionID):(t==null?void 0:t.downloadUrl)??null,inputName:l,length:r.length}}async function Qe(o){var w,x;let i=[],l={};const r=[".ckpt",".pt",".bin",".pth",".safetensors"],t=[".jpeg",".jpg",".png",".gif",".webp"],s=(x=(w=E.graph.extra)==null?void 0:w[F])==null?void 0:x.deps,m=await E.graphToPrompt();Object.values(m.output).forEach(a=>{a.inputs&&Object.keys(a.inputs).forEach(D=>{var p,I;const j=(p=a.inputs)==null?void 0:p[D];typeof j=="string"&&(r.some(k=>j.endsWith(k))&&i.push(Ze(j,a.class_type,D)),t.some(k=>j.endsWith(k))&&(l[j]=((I=s==null?void 0:s.images)==null?void 0:I[j])??{filename:j,nodeType:a.class_type}))})});const d=await fetch("workspace/fetch_node_repos",{method:"POST",body:JSON.stringify({nodes:o.map(a=>a.type)})}).then(a=>a.ok?a.json():[]).catch(a=>(console.error("Error fetching node repos",a),[])),b=await Promise.all(i),v={};b.forEach(a=>{v[a.name]=a});const h={};return Object.values(d).forEach(a=>{h[a.gitRepo]=a}),{models:v,images:l,nodeRepos:Object.values(h)}}function is({onClose:o}){var G,H,U,B,V;const[i,l,r]=ee("v"+Xe()),{saveCurWorkflow:t}=u.useContext(Ee),[s,m]=u.useState(),[y,d]=u.useState(!1),[b,v]=u.useState(!1),h=(H=(G=oe)==null?void 0:G.settings)==null?void 0:H.cloudHost,[w,x,a]=ee("PRIVATE"),[D,j]=u.useState("new_version"),p=(U=O)==null?void 0:U.curWorkflow,I=Ne(),[k,z]=u.useState(!0),f=async n=>{var S;const c=n.data;if(c.type!=="share_workflow_success"||!p)return;const C=c.version.id,R=c.version.workflowID;R&&await((S=O)==null?void 0:S.updateMetaInfo(p.id,{cloudID:R})),g(),window.open(h+"/workflow/"+R+"/"+C,"_blank"),v(!1)};u.useEffect(()=>{g();const n=E.graph.serialize();return Qe(n.nodes??[]).then(c=>{m(c)}),window.addEventListener("message",f),()=>{window.removeEventListener("message",f)}},[]);const g=async()=>{p!=null&&p.cloudID&&p.cloudOrigin&&Fe(p).then(n=>{x(n)})},T=n=>{navigator.clipboard.writeText(n).then(()=>{I({title:"Copied to clipboard",status:"success",duration:2e3,isClosable:!0})}).catch(c=>{console.error("Failed to copy text: ",c)})},N=async n=>{var q,J,Y;const c=E.graph.serialize();(q=c.extra||(c.extra={}))[J=F]||(q[J]={}),c.extra[F].deps={models:(s==null?void 0:s.models)??{},images:n??{},nodeRepos:(s==null?void 0:s.nodeRepos)??[]},await t(),await E.graphToPrompt(E.graph).then(W=>(c.extra[F].apiPrompt=W.output,W.output));const C=JSON.stringify(c);v(!0);const R=Oe(32),S=await((Y=oe)==null?void 0:Y.getSetting("cloudHost"));let $;$=_e(),r.current,C??JSON.stringify(E.graph.serialize());const ce=window.location.protocol,de=window.location.host,ue=`${ce}//${de}`,he=S+`/share_workflow_confirm/${R}?redirectUrl=${ue}`,pe=window.open(he,"Share Workflow","width=800,height=800"),K=W=>{var Z;if(W.origin===S&&W.data==="child_ready"){const L=(Z=O)==null?void 0:Z.curWorkflow;if(!L)return;const me={workflow:{name:L.name,cloudID:L.cloudID},version:{name:r.current,json:C},nodeDefs:$,privacy:a.current};pe.postMessage(me,S),window.removeEventListener("message",K)}};window.addEventListener("message",K)},le=async()=>{const n=(s==null?void 0:s.images)??{};if(k){d(!0);const c=Object.values((s==null?void 0:s.images)??{}).map(C=>C.filename);if(c.length)try{const R=await(await We("/workspace/upload_image",{method:"POST",body:JSON.stringify({images:c})})).json();Object.keys(R).forEach(S=>{n!=null&&n[S]&&(n[S].url=R[S])})}catch(C){console.error("Error uploading images:",C)}d(!1)}N(n)},_=(V=(B=O)==null?void 0:B.curWorkflow)==null?void 0:V.cloudID;return e.jsxs(je,{isOpen:!0,onClose:o,size:"lg",children:[e.jsx(ve,{}),e.jsxs(ye,{width:["98%","90%","50%"],maxWidth:"600px",children:[e.jsxs(be,{children:[e.jsxs(se,{justifyContent:"space-between",children:[e.jsxs("p",{children:['Share "',p==null?void 0:p.name,'"']}),e.jsx(M,{colorScheme:"teal",onClick:le,size:"sm",isDisabled:b,children:b?"Sharing":"Share"})]}),h&&e.jsxs(Me,{fontSize:16,color:"GrayText",fontWeight:400,children:["Share to ",new URL(h).host]})]}),e.jsx(ke,{pb:10,children:e.jsxs(P,{gap:5,children:[_==null?e.jsx(Je,{options:Pe,value:w,onChange:n=>{x(n)}}):e.jsx(ze,{variant:"outline",borderRadius:"full",width:"fit-content",children:e.jsx(Le,{privacy:w,showEmoji:!0})}),_&&e.jsxs(A,{spacing:2,color:"teal.400",children:[e.jsxs(Be,{wordBreak:"break-all",href:h+"/workflow/"+_,isExternal:!0,children:[h+"/workflow/"+_," ",e.jsx(Ae,{size:20,style:{display:"inline-block",verticalAlign:"middle"}})]}),e.jsx(M,{size:"sm",leftIcon:e.jsx(Ve,{size:18}),onClick:()=>{var n,c;T(h+"/workflow/"+((c=(n=O)==null?void 0:n.curWorkflow)==null?void 0:c.cloudID))},children:"Copy link"})]}),e.jsx(ie,{gap:4,onChange:n=>{j(n)},value:D,children:e.jsx(P,{children:e.jsxs(A,{mb:5,alignItems:"center",children:[e.jsx(Te,{value:i,width:"60%",onFocus:()=>{j("new_version")},onChange:n=>{l(n.target.value)}}),e.jsx(se,{color:"green",children:e.jsx(re,{colorScheme:"purple",children:"Version Name"})})]})})}),Object.keys((s==null?void 0:s.images)??{}).length>0&&e.jsxs(P,{borderRadius:6,borderWidth:"1px",p:2,children:[e.jsx(Ue,{isChecked:k,onChange:()=>z(!k),fontWeight:"600",children:"Share input images"}),e.jsxs("span",{style:{color:"GrayText"},children:["If enabled your input images will be uploaded and shared to"," ",h]}),k&&e.jsx(Ye,{deps:s??null,setDeps:m,uploadingImage:y})]})]})})]})]})}function Xe(){const o=new Date,i=o.getFullYear(),l=String(o.getMonth()+1).padStart(2,"0"),r=String(o.getDate()).padStart(2,"0");return`${i}-${l}-${r}`}export{is as default};
