import{f as Y,h as Z,o as q,j as s,b as Q,d as V,r as u,F as re,C as ae,B as U,O as he,M as xe,G as ue,H as de,J as ge,K as fe,L as je}from"./input.js";import{A as we,m as N,F as j,G as D,I as f,a6 as ve,a7 as ye,a8 as pe,X as be,B as ee,o as se,T as _,r as C,N as te,J as ne,W as Ce,H as A,a9 as ke,O as Ie,n as Pe,aa as X,C as H}from"./App-Eqg3V87d.js";import{a as ze,S as Oe,C as R,I as Me}from"./IconTrash-wJH79cV-.js";import{I as oe}from"./chunk-JARCRF6W-po8hqWTL.js";import{V as le}from"./chunk-NTCQBYKE-qX6uHBx-.js";import"/scripts/app.js";import"/scripts/api.js";var F=Y(function(e,n){const i=Z("Link",e),{className:l,isExternal:o,...r}=q(e);return s.jsx(Q.a,{target:o?"_blank":void 0,rel:o?"noopener":void 0,ref:n,className:V("chakra-link",l),...r,__css:i})});F.displayName="Link";function Se(t,e=[]){const n=Object.assign({},t);for(const i of e)i in n&&delete n[i];return n}var _e=["h","minH","height","minHeight"],W=Y((t,e)=>{const n=Z("Textarea",t),{className:i,rows:l,...o}=q(t),r=we(o),x=l?Se(n,_e):n;return s.jsx(Q.textarea,{ref:e,rows:l,...r,className:V("chakra-textarea",i),__css:x})});W.displayName="Textarea";var Fe=N("arrow-left","IconArrowLeft",[["path",{d:"M5 12l14 0",key:"svg-0"}],["path",{d:"M5 12l6 6",key:"svg-1"}],["path",{d:"M5 12l6 -6",key:"svg-2"}]]),Ne=N("chevron-left","IconChevronLeft",[["path",{d:"M15 6l-6 6l6 6",key:"svg-0"}]]),ie=N("copy","IconCopy",[["path",{d:"M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z",key:"svg-0"}],["path",{d:"M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1",key:"svg-1"}]]),Te=N("pin-filled","IconPinFilled",[["path",{d:"M15.113 3.21l.094 .083l5.5 5.5a1 1 0 0 1 -1.175 1.59l-3.172 3.171l-1.424 3.797a1 1 0 0 1 -.158 .277l-.07 .08l-1.5 1.5a1 1 0 0 1 -1.32 .082l-.095 -.083l-2.793 -2.792l-3.793 3.792a1 1 0 0 1 -1.497 -1.32l.083 -.094l3.792 -3.793l-2.792 -2.793a1 1 0 0 1 -.083 -1.32l.083 -.094l1.5 -1.5a1 1 0 0 1 .258 -.187l.098 -.042l3.796 -1.425l3.171 -3.17a1 1 0 0 1 1.497 -1.26z",fill:"currentColor",key:"svg-0",strokeWidth:"0"}]]),me=N("pin","IconPin",[["path",{d:"M15 4.5l-4 4l-4 1.5l-1.5 1.5l7 7l1.5 -1.5l1.5 -4l4 -4",key:"svg-0"}],["path",{d:"M9 15l-4.5 4.5",key:"svg-1"}],["path",{d:"M14.5 4l5.5 5.5",key:"svg-2"}]]);const Be=({setMediaAct:t,media:e,currentNum:n})=>{const[i,l]=u.useState(0);u.useEffect(()=>{n!==void 0&&l(n)},[n]);const o=a=>{const d=(i+a+e.length)%e.length;l(d),t&&t(e[d])},r={width:"100%",height:"100%"},x={enter:a=>({x:a>0?500:-500,opacity:1}),center:{x:0,opacity:1},exit:a=>({x:a<0?500:-500,opacity:1})};return s.jsxs(j,{justifyContent:"center",alignItems:"center",position:"relative",width:r.width,height:r.height,overflow:"hidden",children:[s.jsx(re,{custom:i,children:e.map((a,d)=>s.jsx(ae.div,{custom:d-i,variants:x,initial:"enter",animate:"center",exit:"exit",transition:{x:{type:"spring",stiffness:300,damping:30},opacity:{duration:.2}},style:{position:"absolute",cursor:"pointer",width:"100%",height:"100%",display:d===i?"block":"none"},onClick:()=>{window.open(a.imageUrl)},children:D(a.imageUrl)?s.jsx(oe,{src:a.imageUrl,alt:`image-${a.id}`,width:"100%",height:"100%",objectFit:"contain"}):s.jsx("video",{style:{objectFit:"contain"},width:"100%",height:"100%",src:a.imageUrl,loop:!0,autoPlay:!0,muted:!0,children:s.jsx("track",{kind:"captions"})})},a.id))}),s.jsx(f,{size:"sm",color:"white",bgColor:"whiteAlpha.400","aria-label":"Previous image",icon:s.jsx(Ne,{}),onClick:()=>o(-1),position:"absolute",left:"0",zIndex:"2"}),s.jsx(f,{size:"sm",color:"white",bgColor:"whiteAlpha.400","aria-label":"Next image",icon:s.jsx(ze,{}),onClick:()=>o(1),position:"absolute",right:"0",zIndex:"2"})]})};function Ee(t){const e=t.split(".").pop();return fetch(t).then(n=>{if(!n.ok)throw new Error("Network response was not ok");return n.blob()}).then(async n=>{const i=t.split("/").pop()??"",l=new File([n],i);if(ve(t))return ye(l);if(e==="webp")return pe(l);const o=await be(l),r=JSON.parse(o==null?void 0:o.prompt),x=JSON.parse(o==null?void 0:o.workflow);return{prompt:r,workflow:x}})}const K=t=>{if(typeof t=="string")return t};function G(t){navigator.clipboard.writeText(t).then(function(){}).catch(function(e){console.error("Unable to copy to clipboard: ",e)})}function ce(t,e){var d,w,g,T,m,v,k,I,B,P,z,c,h,y,p,O,M,J;const n=K((T=(g=t==null?void 0:t[(w=(d=e==null?void 0:e.inputs)==null?void 0:d.model)==null?void 0:w[0]])==null?void 0:g.inputs)==null?void 0:T.ckpt_name)??K((k=(v=t==null?void 0:t[((m=Object.keys(t))==null?void 0:m.find(E=>{var b,S;return(S=(b=t[E])==null?void 0:b.inputs)==null?void 0:S.ckpt_name}))??""])==null?void 0:v.inputs)==null?void 0:k.ckpt_name)??"",i=K((z=(P=t==null?void 0:t[(B=(I=e==null?void 0:e.inputs)==null?void 0:I.positive)==null?void 0:B[0]])==null?void 0:P.inputs)==null?void 0:z.text),l=K((p=(y=t==null?void 0:t[(h=(c=e==null?void 0:e.inputs)==null?void 0:c.negative)==null?void 0:h[0]])==null?void 0:y.inputs)==null?void 0:p.text),o=["seed","sampler_name","scheduler","steps","cfg"].reduce((E,b)=>{var S,L;return(S=e==null?void 0:e.inputs)!=null&&S[b]?{...E,[b]:(L=e==null?void 0:e.inputs)==null?void 0:L[b]}:E},{}),r=(J=t==null?void 0:t[(M=(O=e==null?void 0:e.inputs)==null?void 0:O.latent_image)==null?void 0:M[0]])==null?void 0:J.inputs,x=r==null?void 0:r.width,a=r==null?void 0:r.height;return{ckptName:n,positive:i,negative:l,...o,width:x,height:a}}const Ae=t=>{var l;const{prompt:e,workflow:n}=t;console.log(n);const i=e==null?void 0:e[((l=Object.keys(e))==null?void 0:l.find(o=>e[o].class_type==="KSampler"))??""];return ce(e,i)},Ke=({metaData:t})=>{const e=Ae(t);return s.jsxs(le,{spacing:2,align:"stretch",children:[s.jsx(ee,{children:s.jsx(U,{size:"sm",onClick:()=>G(JSON.stringify(e)),children:"Copy all"})}),Object.keys(e??{}).map(n=>{var i,l;return s.jsxs(j,{gap:2,children:[s.jsxs(j,{gap:1,alignItems:"center",flexBasis:"200px",children:[n,s.jsx(f,{size:"xm",onClick:()=>G((e==null?void 0:e[n])??""),"aria-label":"copy text",icon:s.jsx(ie,{}),variant:"ghost"})]}),(i=e==null?void 0:e[n])!=null&&i.length&&((l=e==null?void 0:e[n])==null?void 0:l.length)>300?s.jsx(W,{readOnly:!0,value:e==null?void 0:e[n]}):s.jsx(se,{readOnly:!0,value:e==null?void 0:e[n]})]},`meta${n}`)})]})},$e=t=>{var e,n,i;return((i=(n=(e=Object.keys(t==null?void 0:t.prompt))==null?void 0:e.filter)==null?void 0:n.call(e,l=>{var o,r;return((r=(o=t==null?void 0:t.prompt)==null?void 0:o[l])==null?void 0:r.class_type)==="KSampler"}))==null?void 0:i.length)>1},Ge=t=>{const{prompt:e}=t,n=Object.keys(e);return(n==null?void 0:n.filter(l=>{var o;return((o=e==null?void 0:e[l])==null?void 0:o.class_type)==="KSampler"})).reduce((l,o,r)=>{const x=e==null?void 0:e[o],a=ce(e,x),d=Object.keys(a).reduce((w,g)=>({...w,[`${g}_${r+1}`]:a==null?void 0:a[g]}),{});return{...l,...d}},{})},He=({metaData:t})=>{var n;const e=Ge(t);return s.jsxs(le,{spacing:2,align:"stretch",children:[s.jsx(ee,{children:s.jsx(U,{size:"sm",onClick:()=>G(JSON.stringify(e)),children:"Copy all"})}),(n=Object.keys(e??{}))==null?void 0:n.filter(i=>!!(e!=null&&e[i])).map(i=>{var l,o;return s.jsxs(j,{gap:2,children:[s.jsxs(j,{gap:1,alignItems:"center",flexBasis:"200px",children:[i,s.jsx(f,{size:"xm",onClick:()=>G((e==null?void 0:e[i])??""),"aria-label":"copy text",icon:s.jsx(ie,{}),variant:"ghost"})]}),(l=e==null?void 0:e[i])!=null&&l.length&&((o=e==null?void 0:e[i])==null?void 0:o.length)>300?s.jsx(W,{readOnly:!0,value:e==null?void 0:e[i]}):s.jsx(se,{readOnly:!0,value:e==null?void 0:e[i]})]},`meta${i}`)})]})},Re=({media:t})=>{const[e,n]=u.useState(),i=async l=>{try{const o=await Ee(`/workspace/view_media?filename=${l.localPath}`);n(o)}catch(o){console.log(o)}};return u.useEffect(()=>{t&&i(t)},[t]),s.jsxs(j,{overflowY:"auto",mb:4,direction:"column",gap:2,flex:1,children:[s.jsxs(Oe,{alignItems:"center",columns:2,spacing:2,children:[s.jsxs(j,{alignItems:"center",gap:1,children:[s.jsx(_,{children:t==null?void 0:t.localPath}),s.jsx(C,{label:"Donwload image from gallery",children:s.jsx(F,{href:`/workspace/view_media?filename=${t==null?void 0:t.localPath}`,download:t==null?void 0:t.localPath,children:s.jsx(f,{size:"sm",icon:s.jsx(te,{size:19}),"aria-label":"donwload image from gallery"})})})]}),s.jsxs(j,{gap:1,alignItems:"center",children:[s.jsx(_,{children:"Create Time:"}),s.jsx(_,{children:ne((t==null?void 0:t.createTime)??0,!0)})]})]}),(()=>{if(!t||!e)return null;const l={metaData:e,media:t};return $e(e)&&s.jsx(He,{...l})||s.jsx(Ke,{...l})})()]})},Ue=({mediaList:t,media:e})=>{const[n,i]=u.useState();return u.useEffect(()=>{e&&i(e)},[e]),s.jsxs(j,{gap:3,h:"100%",children:[s.jsx(j,{flex:1,children:s.jsx(Be,{media:t.map(l=>({id:l.id,imageUrl:`/workspace/view_media?filename=${l.localPath}`})),currentNum:t==null?void 0:t.findIndex(l=>l.id===(n==null?void 0:n.id)),setMediaAct:l=>i(t==null?void 0:t.find(o=>o.id===l.id))})}),s.jsx(Re,{media:n})]})},$=200;function Qe({onclose:t}){const{curFlowID:e,loadFilePath:n}=u.useContext(Ce),[i,l]=u.useState(""),[o,r]=u.useState([]),[x,a]=u.useState(!1),[d,w]=u.useState(""),[g,T]=u.useState([]),{showDialog:m}=he(),[v,k]=u.useState(),I=async()=>{var h;if(e==null)return;const c=await((h=X)==null?void 0:h.listByWorkflowID(e));T(c??[])};if(u.useEffect(()=>{var c;I(),e&&((c=H)==null||c.get(e).then(h=>{h&&(l(h.name),h!=null&&h.coverMediaPath&&w(h==null?void 0:h.coverMediaPath))}))},[]),e==null)return null;const B=()=>{I()},P=c=>{if(x){o.includes(c.id)?r(o.filter(h=>h!==c.id)):r([...o,c.id]);return}k(c)},z=g.length>0&&o.length===g.length;return s.jsxs(xe,{isOpen:!0,onClose:t,blockScrollOnMount:!0,children:[s.jsx(ue,{}),s.jsxs(de,{width:"90%",maxWidth:"90vw",height:"90vh",children:[s.jsxs(ge,{children:[s.jsx(A,{gap:2,mb:2,children:s.jsxs(ke,{size:"md",mr:2,children:[!!v&&s.jsx(f,{onClick:()=>k(void 0),variant:"ghost",mr:1,"aria-label":"back",icon:s.jsx(Fe,{})}),"Gallery - ",i]})}),x&&s.jsxs(A,{gap:3,children:[s.jsx(R,{isChecked:z,onChange:()=>{r(z?[]:g.map(c=>c.id))},children:"All"}),s.jsxs(_,{fontSize:16,children:[o.length," Selected"]}),s.jsx(f,{size:"sm",icon:s.jsx(Ie,{size:19}),onClick:()=>a(!1),"aria-label":"cancel"})]})]}),s.jsx(fe,{}),s.jsx(je,{overflowY:"auto",children:v?s.jsx(Ue,{mediaList:g,media:v}):s.jsx(A,{wrap:"wrap",children:g.map(c=>{if(c.localPath==null)return null;const h=D(c.localPath)?s.jsxs(F,{isExternal:!0,onClick:()=>P(c),position:"relative",children:[x&&s.jsx(R,{isChecked:o.includes(c.id),position:"absolute",top:2,left:2}),s.jsx(oe,{borderRadius:3,boxSize:$+"px",objectFit:"cover",src:`/workspace/view_media?filename=${c.localPath}`,alt:"workflow image renamed or moved from output folder"})]}):s.jsxs(F,{isExternal:!0,onClick:()=>P(c),children:[x&&s.jsx(R,{isChecked:o.includes(c.id)}),s.jsx("video",{width:$,height:$,src:`/workspace/view_media?filename=${c.localPath}`,loop:!0,autoPlay:!0,muted:!0,children:s.jsx("track",{kind:"captions"})})]}),y=d!=null&&d===c.localPath;return s.jsxs(Pe,{width:$,justifyContent:"space-between",mb:2,children:[s.jsx(C,{label:ne(c.createTime,!0),children:h}),s.jsx(C,{label:c.localPath,children:s.jsx(_,{color:"GrayText",noOfLines:1,children:c.localPath})}),s.jsxs(A,{justifyContent:"space-between",hidden:x,children:[s.jsx(C,{label:"Set as cover",children:s.jsx(f,{size:"sm",variant:"ghost",icon:y?s.jsx(Te,{size:19}):s.jsx(me,{size:19}),"aria-label":"set as cover",isActive:y,onClick:()=>{var p;(p=H)==null||p.updateFlow(e,{coverMediaPath:c.localPath}),w(c.localPath)}})}),s.jsx(U,{flexGrow:1,onClick:()=>m("How do you want to load this workflow?",[{label:"Load in new workflow",onClick:()=>{n(c.localPath)},colorScheme:"teal"},{label:"Overwrite current workflow",onClick:()=>n(c.localPath,!0),colorScheme:"red"}]),size:"sm",children:"Load"}),s.jsx(C,{label:"Donwload image from gallery",children:s.jsx(F,{href:`/workspace/view_media?filename=${c.localPath}`,download:c.localPath,children:s.jsx(f,{size:"sm",variant:"ghost",icon:s.jsx(te,{size:19}),"aria-label":"donwload image from gallery"})})}),s.jsx(C,{label:"Remove image from gallery",children:s.jsx(f,{size:"sm",variant:"ghost",icon:s.jsx(Me,{size:19}),"aria-label":"remove image from gallery",colorScheme:"red",onClick:async()=>{var O,M;confirm("Are you sure to remove this image from gallery? (won't delete image on your disk)")&&(await((O=X)==null?void 0:O.delete(c.id)),y&&(await((M=H)==null?void 0:M.updateFlow(e,{coverMediaPath:void 0})),w("")),B())}})})]})]})})})})]})]})}export{Qe as default};
