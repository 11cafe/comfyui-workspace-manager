import{r,m as pe,v as ae,b as ge,f as ie,j as e,g as J,h as ve,k as x,p as M,n as Z,i as ke,o as ye,G as we,ab as me,B as G,M as be,L as xe,N as Ce,O as Ie,R as je}from"./input.js";import{al as Pe,h as X,B as Se,A as De,a5 as Re,H as Y,T as Q,z as Le,a3 as ce,m as _e,l as re,j as le,k as Me,F as Ee,x as O,am as z}from"./App-Wu6A4dRe.js";import{app as de}from"/scripts/app.js";import{t as Fe}from"./index-pz0vT7Or.js";import{T as Ue}from"./chunk-RPO2WXNL-dt-e86vT.js";import{L as Te,I as Ne}from"./IconCopy-qIb0ql28.js";import"/scripts/api.js";function We(o){return o&&ae(o)&&ae(o.target)}function Ve(o={}){const{onChange:a,value:t,defaultValue:n,name:d,isDisabled:u,isFocusable:i,isNative:p,...g}=o,[m,I]=r.useState(n||""),w=typeof t<"u",j=w?t:m,k=r.useRef(null),P=r.useCallback(()=>{const l=k.current;if(!l)return;let f="input:not(:disabled):checked";const S=l.querySelector(f);if(S){S.focus();return}f="input:not(:disabled)";const s=l.querySelector(f);s==null||s.focus()},[]),v=`radio-${r.useId()}`,F=d||v,R=r.useCallback(l=>{const f=We(l)?l.target.value:l;w||I(f),a==null||a(String(f))},[a,w]),A=r.useCallback((l={},f=null)=>({...l,ref:pe(f,k),role:"radiogroup"}),[]),L=r.useCallback((l={},f=null)=>({...l,ref:f,name:F,[p?"checked":"isChecked"]:j!=null?l.value===j:void 0,onChange(s){R(s)},"data-radiogroup":!0}),[p,F,R,j]);return{getRootProps:A,getRadioProps:L,name:F,ref:k,focus:P,setValue:I,value:j,onChange:R,isDisabled:u,isFocusable:i,htmlProps:g}}var[Ae,ue]=ge({name:"RadioGroupContext",strict:!1}),he=ie((o,a)=>{const{colorScheme:t,size:n,variant:d,children:u,className:i,isDisabled:p,isFocusable:g,...m}=o,{value:I,onChange:w,getRootProps:j,name:k,htmlProps:P}=Ve(m),E=r.useMemo(()=>({name:k,size:n,onChange:w,colorScheme:t,value:I,variant:d,isDisabled:p,isFocusable:g}),[k,n,w,t,I,d,p,g]);return e.jsx(Ae,{value:E,children:e.jsx(J.div,{...j(P,a),className:ve("chakra-radio-group",i),children:u})})});he.displayName="RadioGroup";var Be={border:"0",clip:"rect(0, 0, 0, 0)",height:"1px",width:"1px",margin:"-1px",padding:"0",overflow:"hidden",whiteSpace:"nowrap",position:"absolute"};function He(o={}){const{defaultChecked:a,isChecked:t,isFocusable:n,isDisabled:d,isReadOnly:u,isRequired:i,onChange:p,isInvalid:g,name:m,value:I,id:w,"data-radiogroup":j,"aria-describedby":k,...P}=o,E=`radio-${r.useId()}`,v=Pe(),R=!!ue()||!!j;let L=!!v&&!R?v.id:E;L=w??L;const l=d??(v==null?void 0:v.isDisabled),f=u??(v==null?void 0:v.isReadOnly),S=i??(v==null?void 0:v.isRequired),s=g??(v==null?void 0:v.isInvalid),[c,D]=r.useState(!1),[y,C]=r.useState(!1),[b,U]=r.useState(!1),[T,N]=r.useState(!1),[K,$]=r.useState(!!a),B=typeof t<"u",_=B?t:K;r.useEffect(()=>Fe(D),[]);const W=r.useCallback(h=>{if(f||l){h.preventDefault();return}B||$(h.target.checked),p==null||p(h)},[B,l,f,p]),H=r.useCallback(h=>{h.key===" "&&N(!0)},[N]),q=r.useCallback(h=>{h.key===" "&&N(!1)},[N]),oe=r.useCallback((h={},V=null)=>({...h,ref:V,"data-active":x(T),"data-hover":x(b),"data-disabled":x(l),"data-invalid":x(s),"data-checked":x(_),"data-focus":x(y),"data-focus-visible":x(y&&c),"data-readonly":x(f),"aria-hidden":!0,onMouseDown:M(h.onMouseDown,()=>N(!0)),onMouseUp:M(h.onMouseUp,()=>N(!1)),onMouseEnter:M(h.onMouseEnter,()=>U(!0)),onMouseLeave:M(h.onMouseLeave,()=>U(!1))}),[T,b,l,s,_,y,f,c]),{onFocus:te,onBlur:ne}=v??{},fe=r.useCallback((h={},V=null)=>{const se=l&&!n;return{...h,id:L,ref:V,type:"radio",name:m,value:I,onChange:M(h.onChange,W),onBlur:M(ne,h.onBlur,()=>C(!1)),onFocus:M(te,h.onFocus,()=>C(!0)),onKeyDown:M(h.onKeyDown,H),onKeyUp:M(h.onKeyUp,q),checked:_,disabled:se,readOnly:f,required:S,"aria-invalid":Z(s),"aria-disabled":Z(se),"aria-required":Z(S),"data-readonly":x(f),"aria-describedby":k,style:Be}},[l,n,L,m,I,W,ne,te,H,q,_,f,S,s,k]);return{state:{isInvalid:s,isFocused:y,isChecked:_,isActive:T,isHovered:b,isDisabled:l,isReadOnly:f,isRequired:S},getCheckboxProps:oe,getRadioProps:oe,getInputProps:fe,getLabelProps:(h={},V=null)=>({...h,ref:V,onMouseDown:M(h.onMouseDown,Oe),"data-disabled":x(l),"data-checked":x(_),"data-invalid":x(s)}),getRootProps:(h,V=null)=>({...h,ref:V,"data-disabled":x(l),"data-checked":x(_),"data-invalid":x(s)}),htmlProps:P}}function Oe(o){o.preventDefault(),o.stopPropagation()}function Ge(o,a){const t={},n={};for(const[d,u]of Object.entries(o))a.includes(d)?t[d]=u:n[d]=u;return[t,n]}var ee=ie((o,a)=>{var t;const n=ue(),{onChange:d,value:u}=o,i=ke("Radio",{...n,...o}),p=ye(o),{spacing:g="0.5rem",children:m,isDisabled:I=n==null?void 0:n.isDisabled,isFocusable:w=n==null?void 0:n.isFocusable,inputProps:j,...k}=p;let P=o.isChecked;(n==null?void 0:n.value)!=null&&u!=null&&(P=n.value===u);let E=d;n!=null&&n.onChange&&u!=null&&(E=we(n.onChange,d));const v=(t=o==null?void 0:o.name)!=null?t:n==null?void 0:n.name,{getInputProps:F,getCheckboxProps:R,getLabelProps:A,getRootProps:L,htmlProps:l}=He({...k,isChecked:P,isFocusable:w,isDisabled:I,onChange:E,name:v}),[f,S]=Ge(l,me),s=R(S),c=F(j,a),D=A(),y=Object.assign({},f,L()),C={display:"inline-flex",alignItems:"center",verticalAlign:"top",cursor:"pointer",position:"relative",...i.container},b={display:"inline-flex",alignItems:"center",justifyContent:"center",flexShrink:0,...i.control},U={userSelect:"none",marginStart:g,...i.label};return e.jsxs(J.label,{className:"chakra-radio",...y,__css:C,children:[e.jsx("input",{className:"chakra-radio__input",...c}),e.jsx(J.span,{className:"chakra-radio__control",...s,__css:b}),m&&e.jsx(J.span,{className:"chakra-radio__label",...D,__css:U,children:m})]})});ee.displayName="Radio";var Ke=X("cloud","IconCloud",[["path",{d:"M6.657 18c-2.572 0 -4.657 -2.007 -4.657 -4.483c0 -2.475 2.085 -4.482 4.657 -4.482c.393 -1.762 1.794 -3.2 3.675 -3.773c1.88 -.572 3.956 -.193 5.444 1c1.488 1.19 2.162 3.007 1.77 4.769h.99c1.913 0 3.464 1.56 3.464 3.486c0 1.927 -1.551 3.487 -3.465 3.487h-11.878",key:"svg-0"}]]),$e=X("link","IconLink",[["path",{d:"M9 15l6 -6",key:"svg-0"}],["path",{d:"M11 6l.463 -.536a5 5 0 0 1 7.071 7.072l-.534 .464",key:"svg-1"}],["path",{d:"M13 18l-.397 .534a5.068 5.068 0 0 1 -7.127 0a4.972 4.972 0 0 1 0 -7.071l.524 -.463",key:"svg-2"}]]),qe=X("lock","IconLock",[["path",{d:"M5 13a2 2 0 0 1 2 -2h10a2 2 0 0 1 2 2v6a2 2 0 0 1 -2 2h-10a2 2 0 0 1 -2 -2v-6z",key:"svg-0"}],["path",{d:"M11 16a1 1 0 1 0 2 0a1 1 0 0 0 -2 0",key:"svg-1"}],["path",{d:"M8 11v-4a4 4 0 1 1 8 0v4",key:"svg-2"}]]),ze=X("world","IconWorld",[["path",{d:"M3 12a9 9 0 1 0 18 0a9 9 0 0 0 -18 0",key:"svg-0"}],["path",{d:"M3.6 9h16.8",key:"svg-1"}],["path",{d:"M3.6 15h16.8",key:"svg-2"}],["path",{d:"M11.5 3a17 17 0 0 0 0 18",key:"svg-3"}],["path",{d:"M12.5 3a17 17 0 0 1 0 18",key:"svg-4"}]]);function Je({options:o,value:a,onChange:t}){const[n,d]=r.useState(!1),u=r.useRef(null),i=o.find(g=>g.value===a);r.useEffect(()=>{const g=m=>{u.current&&!u.current.contains(m.target)&&d(!1)};return document.addEventListener("mousedown",g),()=>{document.removeEventListener("mousedown",g)}},[u]);const p=()=>d(!n);return e.jsxs(Se,{position:"relative",children:[e.jsx(G,{onClick:p,rightIcon:e.jsx(De,{}),leftIcon:i==null?void 0:i.icon,children:i==null?void 0:i.label}),n&&e.jsx(Re,{gap:4,ref:u,mt:"2",shadow:"md",borderWidth:"1px",p:"2",position:"absolute",zIndex:100,children:o.map(g=>e.jsx(G,{onClick:()=>{d(!1),t(g.value)},leftIcon:g.icon,justifyContent:"flex-start",variant:"ghost",width:"full",children:g.label},g.label))})]})}function Ye(o){const a=new Uint8Array(o);return window.crypto.getRandomValues(a),Array.from(a,t=>t.toString(16).padStart(2,"0")).join("")}const Qe=[{label:"Private",value:"PRIVATE",icon:e.jsx(qe,{})},{label:"Unlisted, anyone with the link can view",value:"UNLISTED",icon:e.jsx($e,{})},{label:"Public",value:"PUBLIC",icon:e.jsx(ze,{})}],Xe=()=>{const o=de.graph._nodes,a={};for(let t of o)if(t.type in LiteGraph.registered_node_types){const n=structuredClone(LiteGraph.registered_node_types[t.type].nodeData);if(n==null)continue;for(let d in n.input){const u=n.input[d];for(let i in u){const p=u[i];Array.isArray(p[0])&&(p[0]=["value_1","value_2"])}}a[t.type]=n}return a};async function Ze(o){const a=o.cloudURL;if(!a)throw Error("cloudURL is required");const n=new URL(a).origin;return fetch(n+`/api/getWorkflow?id=${o.cloudID}`).then(d=>d.json()).then(d=>{var i;return((i=d.data)==null?void 0:i.privacy)??"PRIVATE"})}function eo({privacy:o,showEmoji:a=!1}){let t;return o==="PRIVATE"?(t="Private",a&&(t="🔒 Private")):o==="UNLISTED"?(t="Unlisted",a&&(t="🔗 Unlisted")):o==="PUBLIC"&&(t="Public",a&&(t="🌐 Public")),e.jsx("span",{children:t})}function oo({version:o,cloudHost:a}){const t=o,n=e.jsxs(Y,{spacing:4,alignItems:"center",children:[e.jsx(Q,{children:t.name}),e.jsx(Q,{color:"GrayText",children:Le(t.createTime,!1)}),t.cloudID&&e.jsx("a",{href:a+"/workflow_ver/"+t.cloudID,target:"_blank",rel:"noopener noreferrer",style:{textDecoration:"none"},children:e.jsx(G,{size:"xs",colorScheme:"teal",variant:"outline",leftIcon:e.jsx(Ke,{}),rightIcon:e.jsx(ce,{size:18}),children:"Shared"})})]});return o.cloudID?e.jsx(e.Fragment,{children:n}):e.jsx(ee,{value:t.id,mb:5,children:n},t.id)}function po({onClose:o}){var f,S;const[a,t]=r.useState("version "+to()),[n,d]=r.useState([]),[u,i]=r.useState(!1),[p,g]=r.useState(""),[m,I]=r.useState("PRIVATE"),[w,j]=r.useState("new_version"),k=r.useRef(""),[P,E]=r.useState(),v=_e(),F=async s=>{var U,T;const c=s.data;if(s.origin!==k.current||c.type!=="share_workflow_success")return;const D=c.localWorkflowID,y=c.localVersionID,C=c.version.id,b=c.version.workflowID;b&&D&&await((U=O)==null?void 0:U.updateFlow(D,{cloudID:b,cloudURL:k.current+"/workflow/"+b})),y&&C&&await((T=z)==null?void 0:T.update(y,{cloudID:C,cloudURL:k.current+"/workflow_ver/"+C})),R(),window.open(k.current+"/workflow_ver/"+C,"_blank"),i(!1)};r.useEffect(()=>(R(),window.addEventListener("message",F),()=>{window.removeEventListener("message",F)}),[]);const R=async()=>{var D,y,C;const s=await((D=re)==null?void 0:D.getSetting("cloudHost"));s&&(g(s),k.current=s);const c=((y=O)==null?void 0:y.curWorkflow)??void 0;E(c),c!=null&&c.cloudID&&c.cloudURL&&Ze(c).then(b=>{I(b)}),(C=z)==null||C.listByWorkflowID(c.id).then(b=>{d(b)})},A=s=>{navigator.clipboard.writeText(s).then(()=>{v({title:"Copied to clipboard",status:"success",duration:2e3,isClosable:!0})}).catch(c=>{console.error("Failed to copy text: ",c)})},L=async()=>{var $,B,_;i(!0);const s=Ye(32),c=await(($=re)==null?void 0:$.getSetting("cloudHost"));let D,y;try{if(D=Xe(),w==="new_version"?y=await((B=z)==null?void 0:B.add({workflowID:P.id,name:a,createTime:Date.now(),json:JSON.stringify(de.graph.serialize())})):y=await((_=z)==null?void 0:_.get(w)),!y){alert(`Failed to find version: ${w}, please try again.`),i(!1);return}}catch(W){console.error(W),i(!1),alert("Failed to share workflow, please try again.");return}const C=window.location.protocol,b=window.location.host,U=`${C}//${b}`,T=c+`/share_workflow_confirm/${s}?redirectUrl=${U}`,N=window.open(T,"Share Workflow","width=800,height=800"),K=W=>{var H;if(W.origin===c&&W.data==="child_ready"){const q=(H=O)==null?void 0:H.curWorkflow;N.postMessage({workflow:q,version:y,nodeDefs:D,privacy:m},c),window.removeEventListener("message",K)}};window.addEventListener("message",K)},l=(S=(f=O)==null?void 0:f.curWorkflow)==null?void 0:S.cloudID;return e.jsxs(be,{isOpen:!0,onClose:o,size:"lg",children:[e.jsx(xe,{}),e.jsxs(Ce,{width:["98%","90%","50%"],maxWidth:"600px",children:[e.jsxs(Ie,{children:['Share "',P==null?void 0:P.name,'"']}),e.jsxs(je,{pb:10,children:[e.jsxs(le,{gap:5,children:[l==null?e.jsx(Je,{options:Qe,value:m,onChange:s=>{I(s)}}):e.jsx(Ue,{variant:"outline",borderRadius:"full",width:"fit-content",children:e.jsx(eo,{privacy:m,showEmoji:!0})}),l&&e.jsxs(Y,{spacing:2,color:"teal.400",children:[e.jsxs(Te,{href:p+"/workflow/"+l,isExternal:!0,children:[p+"/workflow/"+l," ",e.jsx(ce,{size:20,style:{display:"inline-block",verticalAlign:"middle"}})]}),e.jsx(G,{width:"180px",size:"sm",leftIcon:e.jsx(Ne,{}),onClick:()=>{var s,c;A(p+"/workflow/"+((c=(s=O)==null?void 0:s.curWorkflow)==null?void 0:c.cloudID))},children:"Copy link"})]}),e.jsx(Q,{children:"Choose a version to share:"}),e.jsx(he,{gap:4,onChange:s=>{j(s)},value:w,children:e.jsxs(le,{children:[e.jsxs(Y,{mb:5,alignItems:"center",children:[e.jsx(ee,{value:"new_version"},"new_version"),e.jsx(Me,{value:a,width:"60%",onFocus:()=>{j("new_version")},onChange:s=>{t(s.target.value)}}),e.jsx(Ee,{color:"green",children:e.jsx(Q,{children:"New version"})})]}),n.slice(0,4).map(s=>e.jsx(oo,{version:s,cloudHost:p},s.id))]})})]}),e.jsx(Y,{justifyContent:"flex-end",mt:16,children:e.jsx(G,{colorScheme:"teal",onClick:L,isDisabled:u,children:u?"Sharing":"Share"})})]})]})]})}function to(){const o=new Date,a=o.getFullYear(),t=String(o.getMonth()+1).padStart(2,"0"),n=String(o.getDate()).padStart(2,"0");return`${a}-${t}-${n}`}export{po as default};
