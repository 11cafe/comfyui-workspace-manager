import{r as l,j as y}from"./input.js";import{app as r}from"/scripts/app.js";import{Z as W,ah as j,x as o,i as x,T as C,E as d,ai as A,aj as L,k as h,ak as O}from"./App-CrjjADF1.js";import{u as R}from"./useDebounceFn-ld478fd0.js";import"/scripts/api.js";function M(){const{isDirty:p,setIsDirty:k,setRoute:v,saveCurWorkflow:E,setCurFlowIDAndName:T}=l.useContext(W),w=l.useRef(p),[S,b]=l.useState(!1),g=l.useRef(null);l.useEffect(()=>{w.current=p},[p]),l.useEffect(()=>{var i,c;const n=s=>{var t,u,f;if(document.visibilityState==="hidden")return;const e=L(s);if(e)switch(e===d.openSpotlightSearch&&s.preventDefault(),window.dispatchEvent(new CustomEvent(A,{detail:{shortcutType:e}})),e){case d.SAVE:E();break;case d.SAVE_AS:v("saveAsModal");break;case d.openSpotlightSearch:v("spotlightSearch");break}else if((t=s.target)!=null&&t.matches("input, textarea")&&Object.keys(r.canvas.selected_nodes??{}).length){const I=r.graph.serialize();JSON.stringify(I)!==((f=(u=o)==null?void 0:u.curWorkflow)==null?void 0:f.json)&&m()}},a=r.graph.onConfigure;return r.graph.onConfigure=function(){a==null||a.apply(this,arguments),setTimeout(()=>{var e,t,u,f;const s=(t=(e=r.graph.extra)==null?void 0:e[j])==null?void 0:t.id;(s==null||s!=((f=(u=o)==null?void 0:u.curWorkflow)==null?void 0:f.id))&&T(null)},500)},document.addEventListener("click",s=>{var e,t;if(Object.keys(r.canvas.selected_nodes??{}).length&&(r.canvas.node_over!=null||r.canvas.node_capturing_input!=null||r.canvas.node_widget!=null)){const u=r.graph.serialize();JSON.stringify(u)!==((t=(e=o)==null?void 0:e.curWorkflow)==null?void 0:t.json)&&m()}}),document.addEventListener("keydown",n),(c=(i=h)==null?void 0:i.settings)!=null&&c.autoSave&&h.settings.autoSaveDuration&&(g.current=setInterval(()=>{D()},h.settings.autoSaveDuration*1e3)),()=>{document.removeEventListener("keydown",n),g.current&&clearInterval(g.current)}},[]);const D=async()=>{var a,i,c,s,e,t;if((i=(a=o)==null?void 0:a.curWorkflow)!=null&&i.saveLock||!((s=(c=o)==null?void 0:c.curWorkflow)!=null&&s.id)||!w.current)return;const n=JSON.stringify(r.graph.serialize());await((e=o)==null?void 0:e.updateFlow(o.curWorkflow.id,{json:n})),(t=O)==null||t.create({workflowID:o.curWorkflow.id,isAutoSave:!0,json:n}),k(!1)},_=async()=>{var n,a,i,c,s,e,t;(a=(n=o)==null?void 0:n.curWorkflow)!=null&&a.saveLock||w.current||(k(!0),(c=(i=h)==null?void 0:i.settings)!=null&&c.autoSave&&((e=(s=o)==null?void 0:s.curWorkflow)!=null&&e.id)&&!S&&(await((t=o)==null?void 0:t.latestVersionCheck())||b(!0)))},[m,N]=R(_,900);return S?y.jsx(x,{label:"This workflow was changed by another tab, so you are not working on the latest version. Please refresh page to see the latest version of this workflow.",children:y.jsx(C,{colorScheme:"yellow",children:"⚠️Outdated version"})}):null}export{M as default};
