import{f as q,r as m,j as n,g as B,e as ae,a2 as X,b as qe,o as Ye,k as Qe,h as N,V as le,N as H,P as Je,a3 as Xe,W as Ie,a4 as Ze,X as Le,R as Ee,T as et,a1 as tt,M as ve,O as st,Q as nt,S as ot}from"./input.js";import{aj as rt,m as it,ak as at,al as lt,am as R,B as J,T as F,g as ie,F as $,W as Ae,an as ct,h as V,a5 as Ne,a6 as dt,ad as De,I as Z,H as U,ao as Te,ap as ye,f as Y,v as ht,aq as Fe,e as Pe,ar as ut,as as Oe,at as ft,au as mt,av as pt,aw as gt,ax as xt,ay as vt,az as te,aA as yt,aB as wt}from"./App-fNQ8q43E.js";import{f as ce,s as Mt,g as jt}from"./civitUtils-CpMz5inY.js";import{I as Re}from"./chunk-7D6N5TE5-8K7ISY9J.js";import{G as St,C as _t}from"./chunk-JARCRF6W-ms3uzfBH.js";import{api as de}from"/scripts/api.js";import{S as ee}from"./chunk-3RSXBRAN-WDrvJuDE.js";var ze=q(function(e,s){const{spacing:o="0.5rem",spacingX:i,spacingY:r,children:a,justify:c,direction:l,align:d,className:h,shouldWrapChildren:f,...u}=e,g=m.useMemo(()=>f?m.Children.map(a,(p,x)=>n.jsx(he,{children:p},x)):a,[a,f]);return n.jsx(B.div,{ref:s,className:ae("chakra-wrap",h),...u,children:n.jsx(B.ul,{className:"chakra-wrap__list",__css:{display:"flex",flexWrap:"wrap",justifyContent:c,alignItems:d,flexDirection:l,listStyleType:"none",gap:o,columnGap:i,rowGap:r,padding:"0"},children:g})})});ze.displayName="Wrap";var he=q(function(e,s){const{className:o,...i}=e;return n.jsx(B.li,{ref:s,__css:{display:"flex",alignItems:"flex-start"},className:ae("chakra-wrap__listitem",o),...i})});he.displayName="WrapItem";function we(t){return it(t,e=>e==="auto"?"auto":`span ${e}/span ${e}`)}var Be=q(function(e,s){const{area:o,colSpan:i,colStart:r,colEnd:a,rowEnd:c,rowSpan:l,rowStart:d,...h}=e,f=rt({gridArea:o,gridColumn:we(i),gridRow:we(l),gridColumnStart:r,gridColumnEnd:a,gridRowStart:d,gridRowEnd:c});return n.jsx(B.div,{ref:s,__css:f,...h})});Be.displayName="GridItem";var se=(t,e)=>e?`${t}.${e}, ${e}`:void 0;function We(t){var e;const{bg:s,bgColor:o,backgroundColor:i,shadow:r,boxShadow:a,shadowColor:c}=t,{getArrowProps:l,getArrowInnerProps:d}=at(),h=lt(),f=(e=s??o)!=null?e:i,u=r??a;return n.jsx(B.div,{...l(),className:"chakra-popover__arrow-positioner",children:n.jsx(B.div,{className:ae("chakra-popover__arrow",t.className),...d(t),__css:{"--popper-arrow-shadow-color":se("colors",c),"--popper-arrow-bg":se("colors",f),"--popper-arrow-shadow":se("shadows",u),...h.arrow}})})}We.displayName="PopoverArrow";function Ct(t,e,s){return(t-e)*100/(s-e)}X({"0%":{strokeDasharray:"1, 400",strokeDashoffset:"0"},"50%":{strokeDasharray:"400, 400",strokeDashoffset:"-100"},"100%":{strokeDasharray:"400, 400",strokeDashoffset:"-260"}});X({"0%":{transform:"rotate(0deg)"},"100%":{transform:"rotate(360deg)"}});var bt=X({"0%":{left:"-40%"},"100%":{left:"100%"}}),kt=X({from:{backgroundPosition:"1rem 0"},to:{backgroundPosition:"0 0"}});function It(t){const{value:e=0,min:s,max:o,valueText:i,getValueText:r,isIndeterminate:a,role:c="progressbar"}=t,l=Ct(e,s,o);return{bind:{"data-indeterminate":a?"":void 0,"aria-valuemax":o,"aria-valuemin":s,"aria-valuenow":a?void 0:e,"aria-valuetext":(()=>{if(e!=null)return typeof r=="function"?r(e,l):i})(),role:c},percent:l,value:e}}var[Lt,Et]=qe({name:"ProgressStylesContext",errorMessage:`useProgressStyles returned is 'undefined'. Seems you forgot to wrap the components in "<Progress />" `}),At=q((t,e)=>{const{min:s,max:o,value:i,isIndeterminate:r,role:a,...c}=t,l=It({value:i,min:s,max:o,isIndeterminate:r,role:a}),h={height:"100%",...Et().filledTrack};return n.jsx(B.div,{ref:e,style:{width:`${l.percent}%`,...c.style},...l.bind,...c,__css:h})}),$e=q((t,e)=>{var s;const{value:o,min:i=0,max:r=100,hasStripe:a,isAnimated:c,children:l,borderRadius:d,isIndeterminate:h,"aria-label":f,"aria-labelledby":u,"aria-valuetext":g,title:p,role:x,...M}=Ye(t),S=Qe("Progress",t),v=d??((s=S.track)==null?void 0:s.borderRadius),_={animation:`${kt} 1s linear infinite`},T={...!h&&a&&c&&_,...h&&{position:"absolute",willChange:"left",minWidth:"50%",animation:`${bt} 1s ease infinite normal none running`}},k={overflow:"hidden",position:"relative",...S.track};return n.jsx(B.div,{ref:e,borderRadius:v,__css:k,...M,children:n.jsxs(Lt,{value:S,children:[n.jsx(At,{"aria-label":f,"aria-labelledby":u,"aria-valuetext":g,min:i,max:r,value:o,isIndeterminate:h,css:T,borderRadius:v,title:p,role:x}),l]})})});$e.displayName="Progress";function K(t){return Array.isArray?Array.isArray(t):Ke(t)==="[object Array]"}const Nt=1/0;function Dt(t){return t==null?"":function(e){if(typeof e=="string")return e;let s=e+"";return s=="0"&&1/e==-Nt?"-0":s}(t)}function O(t){return typeof t=="string"}function Ue(t){return typeof t=="number"}function Tt(t){return t===!0||t===!1||function(e){return function(s){return typeof s=="object"}(e)&&e!==null}(t)&&Ke(t)=="[object Boolean]"}function D(t){return t!=null}function ne(t){return!t.trim().length}function Ke(t){return t==null?t===void 0?"[object Undefined]":"[object Null]":Object.prototype.toString.call(t)}const Ft=t=>`Missing ${t} property in key`,Pt=t=>`Property 'weight' in key '${t}' must be a positive integer`,Me=Object.prototype.hasOwnProperty;class Ot{constructor(e){this._keys=[],this._keyMap={};let s=0;e.forEach(o=>{let i=Ge(o);this._keys.push(i),this._keyMap[i.id]=i,s+=i.weight}),this._keys.forEach(o=>{o.weight/=s})}get(e){return this._keyMap[e]}keys(){return this._keys}toJSON(){return JSON.stringify(this._keys)}}function Ge(t){let e=null,s=null,o=null,i=1,r=null;if(O(t)||K(t))o=t,e=je(t),s=Se(t);else{if(!Me.call(t,"name"))throw new Error(Ft("name"));const a=t.name;if(o=a,Me.call(t,"weight")&&(i=t.weight,i<=0))throw new Error(Pt(a));e=je(a),s=Se(a),r=t.getFn}return{path:e,id:s,weight:i,src:o,getFn:r}}function je(t){return K(t)?t:t.split(".")}function Se(t){return K(t)?t.join("."):t}var j={isCaseSensitive:!1,includeScore:!1,keys:[],shouldSort:!0,sortFn:(t,e)=>t.score===e.score?t.idx<e.idx?-1:1:t.score<e.score?-1:1,includeMatches:!1,findAllMatches:!1,minMatchCharLength:1,location:0,threshold:.6,distance:100,useExtendedSearch:!1,getFn:function(t,e){let s=[],o=!1;const i=(r,a,c)=>{if(D(r))if(a[c]){const l=r[a[c]];if(!D(l))return;if(c===a.length-1&&(O(l)||Ue(l)||Tt(l)))s.push(Dt(l));else if(K(l)){o=!0;for(let d=0,h=l.length;d<h;d+=1)i(l[d],a,c+1)}else a.length&&i(l,a,c+1)}else s.push(r)};return i(t,O(e)?e.split("."):e,0),o?s:s[0]},ignoreLocation:!1,ignoreFieldNorm:!1,fieldNormWeight:1};const Rt=/[^ ]+/g;class ue{constructor({getFn:e=j.getFn,fieldNormWeight:s=j.fieldNormWeight}={}){this.norm=function(o=1,i=3){const r=new Map,a=Math.pow(10,i);return{get(c){const l=c.match(Rt).length;if(r.has(l))return r.get(l);const d=1/Math.pow(l,.5*o),h=parseFloat(Math.round(d*a)/a);return r.set(l,h),h},clear(){r.clear()}}}(s,3),this.getFn=e,this.isCreated=!1,this.setIndexRecords()}setSources(e=[]){this.docs=e}setIndexRecords(e=[]){this.records=e}setKeys(e=[]){this.keys=e,this._keysMap={},e.forEach((s,o)=>{this._keysMap[s.id]=o})}create(){!this.isCreated&&this.docs.length&&(this.isCreated=!0,O(this.docs[0])?this.docs.forEach((e,s)=>{this._addString(e,s)}):this.docs.forEach((e,s)=>{this._addObject(e,s)}),this.norm.clear())}add(e){const s=this.size();O(e)?this._addString(e,s):this._addObject(e,s)}removeAt(e){this.records.splice(e,1);for(let s=e,o=this.size();s<o;s+=1)this.records[s].i-=1}getValueForItemAtKeyId(e,s){return e[this._keysMap[s]]}size(){return this.records.length}_addString(e,s){if(!D(e)||ne(e))return;let o={v:e,i:s,n:this.norm.get(e)};this.records.push(o)}_addObject(e,s){let o={i:s,$:{}};this.keys.forEach((i,r)=>{let a=i.getFn?i.getFn(e):this.getFn(e,i.path);if(D(a)){if(K(a)){let c=[];const l=[{nestedArrIndex:-1,value:a}];for(;l.length;){const{nestedArrIndex:d,value:h}=l.pop();if(D(h))if(O(h)&&!ne(h)){let f={v:h,i:d,n:this.norm.get(h)};c.push(f)}else K(h)&&h.forEach((f,u)=>{l.push({nestedArrIndex:u,value:f})})}o.$[r]=c}else if(O(a)&&!ne(a)){let c={v:a,n:this.norm.get(a)};o.$[r]=c}}}),this.records.push(o)}toJSON(){return{keys:this.keys,records:this.records}}}function He(t,e,{getFn:s=j.getFn,fieldNormWeight:o=j.fieldNormWeight}={}){const i=new ue({getFn:s,fieldNormWeight:o});return i.setKeys(t.map(Ge)),i.setSources(e),i.create(),i}function Q(t,{errors:e=0,currentLocation:s=0,expectedLocation:o=0,distance:i=j.distance,ignoreLocation:r=j.ignoreLocation}={}){const a=e/t.length;if(r)return a;const c=Math.abs(o-s);return i?a+c/i:c?1:a}const W=32;function zt(t,e,s,{location:o=j.location,distance:i=j.distance,threshold:r=j.threshold,findAllMatches:a=j.findAllMatches,minMatchCharLength:c=j.minMatchCharLength,includeMatches:l=j.includeMatches,ignoreLocation:d=j.ignoreLocation}={}){if(e.length>W)throw new Error(`Pattern length exceeds max of ${W}.`);const h=e.length,f=t.length,u=Math.max(0,Math.min(o,f));let g=r,p=u;const x=c>1||l,M=x?Array(f):[];let S;for(;(S=t.indexOf(e,p))>-1;){let k=Q(e,{currentLocation:S,expectedLocation:u,distance:i,ignoreLocation:d});if(g=Math.min(k,g),p=S+h,x){let L=0;for(;L<h;)M[S+L]=1,L+=1}}p=-1;let v=[],_=1,I=h+f;const P=1<<h-1;for(let k=0;k<h;k+=1){let L=0,E=I;for(;L<E;)Q(e,{errors:k,currentLocation:u+E,expectedLocation:u,distance:i,ignoreLocation:d})<=g?L=E:I=E,E=Math.floor((I-L)/2+L);I=E;let z=Math.max(1,u-E+1),A=a?f:Math.min(u+E,f)+h,y=Array(A+2);y[A+1]=(1<<k)-1;for(let w=A;w>=z;w-=1){let C=w-1,b=s[t.charAt(C)];if(x&&(M[C]=+!!b),y[w]=(y[w+1]<<1|1)&b,k&&(y[w]|=(v[w+1]|v[w])<<1|1|v[w+1]),y[w]&P&&(_=Q(e,{errors:k,currentLocation:C,expectedLocation:u,distance:i,ignoreLocation:d}),_<=g)){if(g=_,p=C,p<=u)break;z=Math.max(1,2*u-p)}}if(Q(e,{errors:k+1,currentLocation:u,expectedLocation:u,distance:i,ignoreLocation:d})>g)break;v=y}const T={isMatch:p>=0,score:Math.max(.001,_)};if(x){const k=function(L=[],E=j.minMatchCharLength){let z=[],A=-1,y=-1,w=0;for(let C=L.length;w<C;w+=1){let b=L[w];b&&A===-1?A=w:b||A===-1||(y=w-1,y-A+1>=E&&z.push([A,y]),A=-1)}return L[w-1]&&w-A>=E&&z.push([A,w-1]),z}(M,c);k.length?l&&(T.indices=k):T.isMatch=!1}return T}function Bt(t){let e={};for(let s=0,o=t.length;s<o;s+=1){const i=t.charAt(s);e[i]=(e[i]||0)|1<<o-s-1}return e}class Wt{constructor(e,{location:s=j.location,threshold:o=j.threshold,distance:i=j.distance,includeMatches:r=j.includeMatches,findAllMatches:a=j.findAllMatches,minMatchCharLength:c=j.minMatchCharLength,isCaseSensitive:l=j.isCaseSensitive,ignoreLocation:d=j.ignoreLocation}={}){if(this.options={location:s,threshold:o,distance:i,includeMatches:r,findAllMatches:a,minMatchCharLength:c,isCaseSensitive:l,ignoreLocation:d},this.pattern=l?e:e.toLowerCase(),this.chunks=[],!this.pattern.length)return;const h=(u,g)=>{this.chunks.push({pattern:u,alphabet:Bt(u),startIndex:g})},f=this.pattern.length;if(f>W){let u=0;const g=f%W,p=f-g;for(;u<p;)h(this.pattern.substr(u,W),u),u+=W;if(g){const x=f-W;h(this.pattern.substr(x),x)}}else h(this.pattern,0)}searchIn(e){const{isCaseSensitive:s,includeMatches:o}=this.options;if(s||(e=e.toLowerCase()),this.pattern===e){let p={isMatch:!0,score:0};return o&&(p.indices=[[0,e.length-1]]),p}const{location:i,distance:r,threshold:a,findAllMatches:c,minMatchCharLength:l,ignoreLocation:d}=this.options;let h=[],f=0,u=!1;this.chunks.forEach(({pattern:p,alphabet:x,startIndex:M})=>{const{isMatch:S,score:v,indices:_}=zt(e,p,x,{location:i+M,distance:r,threshold:a,findAllMatches:c,minMatchCharLength:l,includeMatches:o,ignoreLocation:d});S&&(u=!0),f+=v,S&&_&&(h=[...h,..._])});let g={isMatch:u,score:u?f/this.chunks.length:1};return u&&o&&(g.indices=h),g}}const _e=[];function Ce(t,e){for(let s=0,o=_e.length;s<o;s+=1){let i=_e[s];if(i.condition(t,e))return new i(t,e)}return new Wt(t,e)}function $t(t,e){const s=t.matches;e.matches=[],D(s)&&s.forEach(o=>{if(!D(o.indices)||!o.indices.length)return;const{indices:i,value:r}=o;let a={indices:i,value:r};o.key&&(a.key=o.key.src),o.idx>-1&&(a.refIndex=o.idx),e.matches.push(a)})}function Ut(t,e){e.score=t.score}class G{constructor(e,s={},o){if(this.options={...j,...s},this.options.useExtendedSearch)throw new Error("Extended search is not available");this._keyStore=new Ot(this.options.keys),this.setCollection(e,o)}setCollection(e,s){if(this._docs=e,s&&!(s instanceof ue))throw new Error("Incorrect 'index' type");this._myIndex=s||He(this.options.keys,this._docs,{getFn:this.options.getFn,fieldNormWeight:this.options.fieldNormWeight})}add(e){D(e)&&(this._docs.push(e),this._myIndex.add(e))}remove(e=()=>!1){const s=[];for(let o=0,i=this._docs.length;o<i;o+=1){const r=this._docs[o];e(r,o)&&(this.removeAt(o),o-=1,i-=1,s.push(r))}return s}removeAt(e){this._docs.splice(e,1),this._myIndex.removeAt(e)}getIndex(){return this._myIndex}search(e,{limit:s=-1}={}){const{includeMatches:o,includeScore:i,shouldSort:r,sortFn:a,ignoreFieldNorm:c}=this.options;let l=O(e)?O(this._docs[0])?this._searchStringList(e):this._searchObjectList(e):this._searchLogical(e);return function(d,{ignoreFieldNorm:h=j.ignoreFieldNorm}){d.forEach(f=>{let u=1;f.matches.forEach(({key:g,norm:p,score:x})=>{const M=g?g.weight:null;u*=Math.pow(x===0&&M?Number.EPSILON:x,(M||1)*(h?1:p))}),f.score=u})}(l,{ignoreFieldNorm:c}),r&&l.sort(a),Ue(s)&&s>-1&&(l=l.slice(0,s)),function(d,h,{includeMatches:f=j.includeMatches,includeScore:u=j.includeScore}={}){const g=[];return f&&g.push($t),u&&g.push(Ut),d.map(p=>{const{idx:x}=p,M={item:h[x],refIndex:x};return g.length&&g.forEach(S=>{S(p,M)}),M})}(l,this._docs,{includeMatches:o,includeScore:i})}_searchStringList(e){const s=Ce(e,this.options),{records:o}=this._myIndex,i=[];return o.forEach(({v:r,i:a,n:c})=>{if(!D(r))return;const{isMatch:l,score:d,indices:h}=s.searchIn(r);l&&i.push({item:r,idx:a,matches:[{score:d,value:r,norm:c,indices:h}]})}),i}_searchLogical(e){throw new Error("Logical search is not available")}_searchObjectList(e){const s=Ce(e,this.options),{keys:o,records:i}=this._myIndex,r=[];return i.forEach(({$:a,i:c})=>{if(!D(a))return;let l=[];o.forEach((d,h)=>{l.push(...this._findMatches({key:d,value:a[h],searcher:s}))}),l.length&&r.push({idx:c,item:a,matches:l})}),r}_findMatches({key:e,value:s,searcher:o}){if(!D(s))return[];let i=[];if(K(s))s.forEach(({v:r,i:a,n:c})=>{if(!D(r))return;const{isMatch:l,score:d,indices:h}=o.searchIn(r);l&&i.push({score:d,key:e,value:r,idx:a,norm:c,indices:h})});else{const{v:r,n:a}=s,{isMatch:c,score:l,indices:d}=o.searchIn(r);c&&i.push({score:l,key:e,value:r,norm:a,indices:d})}return i}}G.version="7.0.0",G.createIndex=He,G.parseIndex=function(t,{getFn:e=j.getFn,fieldNormWeight:s=j.fieldNormWeight}={}){const{keys:o,records:i}=t,r=new ue({getFn:e,fieldNormWeight:s});return r.setKeys(o),r.setIndexRecords(i),r},G.config=j;function Kt({selectedModel:t,setSelectedModel:e,modelTypeList:s}){const o=i=>{e(i)};return n.jsx(ze,{children:s.map(i=>n.jsx(he,{children:n.jsx(N,{colorScheme:"blue",variant:t===i?"solid":"outline",onClick:()=>o(i),size:"sm",children:i})},i))})}const Gt={checkpoints:"CheckpointLoaderSimple",vae:"VAELoader",loras:"LoraLoader",controlnet:"ControlNetLoader",upscale_models:"UpscaleModelLoader"},oe=t=>{const e=[".mp4",".webm",".ogg",".mov",".avi",".mkv"],s=t.toLowerCase();return!!(e.some(o=>s.endsWith(o))||s.includes("/video/")||s.includes("_video.")||s.includes("_preview.mp4"))};function Ht({data:t}){const[e,s]=m.useState("https://image.civitai.com/xG1nkqKTMzGDvpLrqFT7WA/27fd7433-cb0a-4a87-88c1-21ccb2b1a842/width=450/00060-881622046.jpeg"),[o,i]=m.useState(!t.file_hash),[r,a]=m.useState(),[c,l]=m.useState("loading"),d=m.useRef(null),[h,f]=m.useState(!1);m.useEffect(()=>{i(!t.file_hash),l("loading"),u()},[t.file_hash]),m.useEffect(()=>{d.current&&c==="video"&&(h?d.current.play().catch(v=>{console.error("Error playing video:",v)}):(d.current.pause(),d.current.currentTime=0))},[h,c]);const u=async()=>{var _;const v=await R.models.get(t.model_name+"@"+t.model_type);if(v!=null&&(a(v),(_=v.imageUrl)!=null&&_.length&&(s(v.imageUrl),l(oe(v.imageUrl)?"video":"image"))),!(v!=null&&v.imageUrl)&&t.file_hash!=null)try{const I=await ce(t.file_hash),P=I.imageUrl;P&&(s(P),l(oe(P)?"video":"image"));const T={id:t.model_name+"@"+t.model_type,fileHash:t.file_hash,fileFolder:t.model_type,fileName:t.model_name+t.model_extension,modelName:I.modelName??null,civitModelID:I.civitModelID,civitModelVersionID:I.civitModelVersionID,imageUrl:P??null};a(T)}catch(I){console.error("Error fetching model data:",I),l("image")}t.preview&&(s(t.preview),l(oe(t.preview)?"video":"image"))},g=()=>{console.log("Media loaded:",e),i(!1)},p=()=>{console.error("Media failed to load:",e),c==="video"&&(console.log("Retrying as image"),l("image"))},x=v=>{const _=Gt[t.model_type];_&&(v.dataTransfer.setData("eventName","WorkspaceManagerAddNode"),v.dataTransfer.setData("modelRelativePath",t.model_name+t.model_extension),v.dataTransfer.setData("nodeType",_))},M=()=>{(r==null?void 0:r.civitModelID)==null||(r==null?void 0:r.civitModelVersionID)==null||window.open(`https://civitai.com/models/${r==null?void 0:r.civitModelID}?modelVersionId=${r==null?void 0:r.civitModelVersionID}`)},S=()=>{if(o)return n.jsx($,{bg:"rgba(0, 0, 0, 0.5)",height:178,justifyContent:"center",alignItems:"center",children:n.jsx(le,{})});const v={cursor:(r==null?void 0:r.civitModelID)!=null?"pointer":"auto",onClick:M,borderRadius:4};return c==="video"?n.jsx(J,{height:"150px",width:"100%",overflow:"hidden",...v,onMouseEnter:()=>f(!0),onMouseLeave:()=>f(!1),children:n.jsx("video",{ref:d,src:e,style:{width:"100%",height:"100%",objectFit:"cover",borderRadius:"4px"},muted:!0,loop:!0,playsInline:!0,draggable:!1,onLoadedData:g,onError:p})}):n.jsx(Re,{src:e,draggable:!1,boxSize:"100%",height:150,objectFit:"cover",onLoad:g,onError:p,...v})};return n.jsxs(J,{children:[n.jsxs(J,{position:"relative",borderRadius:4,draggable:!0,onDragStart:x,children:[S(),n.jsx(F,{position:"absolute",bottom:"0",left:"0",right:"0",color:"white",fontSize:14})]}),n.jsx(ie,{label:n.jsxs("span",{children:[t.model_name+t.model_extension,n.jsx("br",{}),t.date.toLocaleDateString()]}),children:n.jsx(F,{textAlign:"center",p:"1",fontSize:14,noOfLines:2,children:t.model_name+t.model_extension})})]})}function Vt({list:t}){return n.jsx(St,{templateColumns:"repeat(3, minmax(0, 1fr))",gap:1,marginTop:2,children:t.map(e=>n.jsx(Be,{children:n.jsx(Ht,{data:e})},e.model_name+e.date.getTime()))})}function qt(){const{setRoute:t}=m.useContext(Ae);return n.jsx(n.Fragment,{children:n.jsx(N,{size:"sm",colorScheme:"teal",onClick:()=>t("installModels"),children:"Install Models"})})}const Yt=()=>{const[t,e]=m.useState(["checkpoints"]),[s,o]=m.useState([]),[i,r]=m.useState(!0);m.useEffect(()=>{a(),de.addEventListener("model_list",async l=>{c(l.detail)})},[]);const a=async()=>{const l=await ct();c(l)},c=async l=>{if(!l)return;r(!1);const d=Array.from(new Set(l.map(f=>f.model_type))),h=d.indexOf("checkpoints");h>=0&&d.splice(h,1),d.unshift("checkpoints"),e(d),o(l.map(f=>({...f,date:new Date(f.date*1e3)})))};return{modelTypeList:t,modelsList:s,loading:i}};function Qt(){const[t,e]=m.useState(!1),s=()=>{var a;(a=V)==null||a.getSetting("showNsfwModelThumbnail").then(c=>{e(c??!1)})};m.useEffect(()=>{s()},[]);const o=a=>{var l;const c=a.target.checked;(l=V)==null||l.upsert({showNsfwModelThumbnail:c}).then(()=>{s(),i(),window.dispatchEvent(new Event("showNsfwModelThumbnail"))})},i=async()=>{const a=await R.models.toArray();for(let c=0;c<a.length;c+=5){const l=a.slice(c,c+5);await Promise.all(l.map(r))}},r=async a=>{try{if(a.fileHash==null)return;const l=(await ce(a.fileHash)).imageUrl;R.models.update(a.id,{imageUrl:l??null})}catch{}};return n.jsx(_t,{isChecked:t,onChange:o,children:"Show NSFW"})}function Jt(){const t=async e=>{if(e.dataTransfer.getData("eventName")!=="WorkspaceManagerAddNode")return;const o=e.dataTransfer.getData("modelRelativePath"),i=e.dataTransfer.getData("nodeType"),r=LiteGraph.createNode(i);r.pos=[e.canvasX,e.canvasY],r.configure({widgets_values:[o]}),H.graph.add(r)};return m.useEffect(()=>(H.canvasEl.addEventListener("drop",t),()=>{H.canvasEl.removeEventListener("drop",t)}),[]),null}function Xt({onClose:t}){const[e,s]=m.useState("checkpoints"),[o,i]=m.useState(""),[r,a]=m.useState("name"),{loading:c,modelTypeList:l,modelsList:d}=Yt(),[h,f]=m.useState([]),[u,g]=m.useState([]);m.useEffect(()=>{x();async function x(){const M=await R.models.toArray();f(d.map(S=>({...S,db:M.find(v=>v.id===S.model_name+"@"+S.model_type)})))}},[d]),m.useEffect(()=>{let x=[];o.length?x=new G(h,{keys:["model_name","db.modelName"]}).search(o).map(v=>v.item):x=d.filter(M=>M.model_type===e).sort((M,S)=>r==="name"?M.model_name.localeCompare(S.model_name):S.date.getTime()-M.date.getTime()),g(x)},[e,d,o,r,h]),m.useEffect(()=>(H.canvasEl.addEventListener("click",t),()=>{H.canvasEl.removeEventListener("click",t)}),[t]);const p=440;return n.jsx(Je,{children:n.jsxs(J,{style:{width:p},children:[n.jsxs(Ne,{width:p,height:"100vh",p:4,gap:2,position:"fixed",top:0,left:0,shadow:"xl",zIndex:dt,overflowY:"auto",children:[n.jsxs($,{justifyContent:"space-between",alignContent:"center",py:3,children:[n.jsx(De,{size:"md",mr:2,children:"Models"}),n.jsx(qt,{})]}),n.jsx($,{gap:4,justifyContent:"center",alignItems:"center",mb:1,children:n.jsx(Z,{size:"sm",placeholder:"Search",value:o,onChange:x=>i(x.target.value)})}),n.jsxs($,{gap:4,justifyContent:"space-between",alignItems:"center",mb:1,children:[!o.length&&n.jsxs(U,{children:[n.jsx("span",{children:"Sort By"}),n.jsxs(ee,{value:r,size:"sm",width:"120px",onChange:x=>a(x.target.value),children:[n.jsx("option",{value:"name",children:"Name"}),n.jsx("option",{value:"date",children:"Date"})]})]}),n.jsx(Qt,{})]}),!o.length&&n.jsx(Kt,{modelTypeList:l,setSelectedModel:s,selectedModel:e}),n.jsx(Vt,{list:u}),c&&n.jsx($,{justifyContent:"center",alignItems:"center",height:"100%",children:n.jsx(le,{})})]}),n.jsx(Jt,{})]})})}const Zt=async t=>{try{const s=await(await de.fetchApi("/model_manager/install_model",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})).text();window.dispatchEvent(new CustomEvent("model_install_message",{detail:s}))}catch(e){console.error("Failed to connect to the server:",e)}};function be(t,e=1){const i=t/1024;return i>=1024?(i/1024).toFixed(e)+" GB":i.toFixed(e)+" MB"}function ke(t,e){if(!t||t.length===0)return;let s=t.find(o=>o.nsfw==="None"||o.nsfwLevel===1);return e&&(s=s??t[0]),s}function es(t,e=280,s){var o,i,r,a;if(t){if(t.images)return`https://image.civitai.com/xG1nkqKTMzGDvpLrqFT7WA/${(o=ke(t.images,s))==null?void 0:o.url}/width=${e}/`;if(Te(t))return(a=ke((r=(i=t.modelVersions)==null?void 0:i.at(0))==null?void 0:r.images,s))==null?void 0:a.url}}const re=280;function ts({model:t,onClickInstallModel:e,installing:s}){var u,g;const[o,i]=m.useState();m.useEffect(()=>{p();async function p(){var M;const x=await((M=V)==null?void 0:M.getSetting("showNsfwModelThumbnail"));i(es(t,re,x))}},[t]);const r=Te(t)?t.modelVersions:t.versions,[a,c]=m.useState(((u=r==null?void 0:r[0])==null?void 0:u.name)??""),l=r==null?void 0:r.find(p=>(p==null?void 0:p.name)===a),d=()=>{window.open(`https://civitai.com/models/${t.id}`)},h=m.useCallback(()=>{if(l==null){console.error("no file is find by name",a);return}e(ye(l,t.name),t)},[a]),f=(g=ye(l))==null?void 0:g.sizeKB;return n.jsxs(Ne,{width:re,justifyContent:"space-between",mb:2,gap:1,children:[n.jsx(Re,{borderRadius:3,boxSize:re+"px",objectFit:"cover",src:o,alt:"model cover image",cursor:"pointer",onClick:()=>d()}),n.jsxs(Y,{p:1,children:[n.jsx(ie,{label:t.name,children:n.jsx(F,{fontWeight:500,noOfLines:1,children:t.name})}),n.jsxs($,{justifyContent:"space-between",alignItems:"center",children:[n.jsx(N,{borderRadius:14,noOfLines:1,size:"xs",colorScheme:"teal",maxWidth:"40%",flexShrink:1,variant:"outline",px:1,cursor:"text",children:n.jsx(F,{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",children:t.type})}),n.jsx(N,{leftIcon:n.jsx(ht,{size:18}),iconSpacing:1,borderRadius:10,size:"sm",py:1,colorScheme:"teal",type:"submit",onClick:()=>h(),isDisabled:!!(a&&s.includes(a)),children:"Install"})]}),n.jsxs(U,{children:[n.jsx(ee,{size:"md",style:{paddingLeft:4},onChange:p=>{c(p.target.value)},children:r==null?void 0:r.map(p=>{const x=p==null?void 0:p.name;return x?n.jsx("option",{value:x,style:{padding:0},children:x},p.id):null})}),f&&n.jsx(ie,{label:be(f),children:n.jsx(F,{flexShrink:1,noOfLines:1,width:"40%",children:be(f)})})]})]})]})}function ss({searchQuery:t,setSearchQuery:e,onSearch:s}){return n.jsxs($,{gap:1,alignItems:"center",grow:1,children:[n.jsx(Z,{placeholder:"Search models in CivitAI",width:"60%",value:t,onChange:o=>e(o.target.value),onKeyUp:o=>{o.code==="Enter"&&s()}}),n.jsx(N,{size:"sm",onClick:()=>s(),colorScheme:"teal",children:"Search"})]})}function ns({isOpen:t,fileSelected:e,onClose:s,selectFolder:o}){const[i,r]=m.useState(""),[a,c]=m.useState([]),[l,d]=m.useState(""),h=m.useRef(null);m.useEffect(()=>{f()},[]);const f=async()=>{const u=await Fe();u&&(["custom_nodes","config","saved_prompts"].forEach(g=>{delete u[g]}),c(Object.values(u).flatMap(g=>g)))};return n.jsx(Xe,{isOpen:t,leastDestructiveRef:h,onClose:s,children:n.jsx(Ie,{children:n.jsxs(Ze,{children:[n.jsx(Le,{fontSize:"lg",fontWeight:"bold",children:"Choose Folder"}),n.jsx(Ee,{children:n.jsxs(Y,{spacing:4,children:[!e&&n.jsxs(n.Fragment,{children:[n.jsx(F,{children:"Model download url"}),n.jsx(Z,{placeholder:"https://civitai.com/api/download/models/311399",onChange:u=>d(u.target.value),value:l})]}),n.jsx(F,{children:"Choose model install folder"}),n.jsx(ee,{placeholder:"Select option",value:i,onChange:u=>r(u.target.value),children:a.map(u=>n.jsx("option",{value:u,children:u},u))})]})}),n.jsxs(et,{children:[n.jsx(N,{ref:h,onClick:s,children:"Cancel"}),n.jsx(N,{onClick:()=>o(i,l),ml:3,isDisabled:l.length===0,children:"Confirm"})]})]})})})}function os(){const{colorMode:t}=tt(),e=Pe(),[s,o]=m.useState([]);return m.useEffect(()=>{ve.addEventListener("download_progress",i=>{o(i.detail)}),ve.addEventListener("download_error",i=>{e({title:"Download Error",description:i.detail,status:"error",duration:4e3,isClosable:!0})})},[]),n.jsx(Y,{spacing:5,pos:"absolute",bottom:"0",left:"0",width:"50%",zIndex:80,backgroundColor:t==="light"?"white":"#242424",paddingX:5,pt:2,children:s.map(({save_path:i,progress:r})=>n.jsxs(U,{children:[n.jsx(F,{fontSize:16,width:"40%",children:i.replace(/^.*[\\/]/,"")}),n.jsx($e,{isIndeterminate:!r,hasStripe:!0,width:"50%",value:r}),n.jsxs(F,{fontSize:16,width:"10%",children:[r.toFixed(1),"%"]}),n.jsx(N,{variant:"outline",size:"sm",colorScheme:"red",onClick:()=>ut(i),children:"Cancel"})]},i))})}function rs(){const[t,e]=m.useState(""),{onOpen:s,onClose:o,isOpen:i}=Oe(),r=()=>{Mt(t),o()};return n.jsxs(ft,{isOpen:i,onOpen:s,onClose:o,placement:"right",closeOnBlur:!1,children:[n.jsx(mt,{children:n.jsx(N,{size:"sm",py:1,mr:8,children:"Set Civitai API Key"})}),n.jsxs(pt,{p:5,children:[n.jsx(We,{}),n.jsx(gt,{}),n.jsxs(Y,{spacing:4,children:[n.jsx(F,{fontSize:14,children:"Some Civitai.com models require user login to download, you will nedd a Civitai API key to download in that case"}),n.jsx(Z,{value:t,onChange:a=>e(a.target.value),placeholder:"API Key"}),n.jsx(N,{size:"sm",py:1,mr:8,onClick:r,children:"Save"})]})]})]})}async function is(t,e){var l;const s={limit:"30",types:t};e&&(s.query=e);const i=`https://civitai.com/api/v1/models?${new URLSearchParams(s).toString()}`,r=await((l=R.cache)==null?void 0:l.get(i));if((r==null?void 0:r.value)!=null)try{const{data:d,timestamp:h}=JSON.parse(r==null?void 0:r.value);if((Date.now()-h)/(1e3*60*60*24)<xt)return d}catch(d){console.error("err fetching cache",d)}const c=await(await fetch(i)).json();return R.cache.put({id:i,value:JSON.stringify({data:c.items,timestamp:Date.now()})}),c.items}function as({onclose:t,searchQuery:e="",modelType:s}){const[o,i]=m.useState([]),[r,a]=m.useState(!1),[c,l]=m.useState(s),d=Pe(),[h,f]=m.useState([]),[u,g]=m.useState(e),{isOpen:p,onOpen:x,onClose:M}=Oe(),[S,v,_]=vt(),[I,P]=m.useState({}),[T,k]=m.useState(te),L=m.useCallback(async()=>{var b;a(!0);const y=await is(c,u);i(y);const w=await Fe();w&&P(w);const C=await((b=V)==null?void 0:b.getSetting("defaultFolders"));C&&k(C),a(!1)},[u,c]),E=(y,w)=>{var me,pe,ge,xe;if(!((me=_.current)!=null&&me.id)&&!w){console.error("no url to download");return}let C=w??`https://civitai.com/api/download/models/${(pe=_.current)==null?void 0:pe.id}`,b=(ge=_.current)==null?void 0:ge.name;if(!b&&(b=C.split("/").pop(),!b)){console.error("downloadUrl is malformed");return}d({title:"Installing...",description:b,status:"info",duration:4e3,isClosable:!0}),b!=null&&f(Ve=>[...Ve,b??""]);const fe=jt();fe&&(C+=`?token=${fe}`),Zt({file_hash:(xe=_.current)==null?void 0:xe.SHA256,filename:b,save_path:y,url:C}),v(void 0),M()},z=async(y,w)=>{const C=T[w.type];v(y),C==null?x():E(C)},A=async(y,w)=>{var b;const C={...T,[y]:w};await((b=V)==null?void 0:b.upsert({defaultFolders:C})),k(C)};return m.useEffect(()=>{L()},[c]),n.jsxs(n.Fragment,{children:[n.jsxs(st,{isOpen:!0,onClose:t,blockScrollOnMount:!0,children:[n.jsx(Ie,{}),n.jsxs(nt,{width:"90%",maxWidth:"90vw",height:"90vh",children:[n.jsxs(Le,{pb:1,children:[n.jsxs(U,{gap:2,mb:2,alignItems:"center",children:[n.jsx(De,{size:"md",mr:2,children:"Models"}),n.jsx(ss,{searchQuery:u,setSearchQuery:g,onSearch:L}),n.jsx(N,{size:"sm",py:1,mr:8,onClick:x,children:"Custom URL Install"}),n.jsx(rs,{})]}),n.jsxs(U,{gap:2,wrap:"wrap",children:[n.jsx(N,{size:"sm",py:1,onClick:()=>{l(void 0)},isActive:c==null,children:"All"}),yt.map(y=>n.jsx(N,{size:"sm",py:1,isActive:c===y,onClick:()=>{l(y)},children:y},y)),c&&I[te[c]]&&n.jsxs(U,{ml:"auto",children:[n.jsx(F,{fontSize:17,whiteSpace:"nowrap",children:"Default Download Folder:"}),n.jsx(ee,{value:T[c],onChange:y=>A(c,y.target.value),children:I[te[c]].map(y=>n.jsx("option",{value:y,children:y},y))})]})]}),r&&n.jsx(le,{thickness:"4px",emptyColor:"gray.200",color:"pink.500",size:"lg"})]}),n.jsx(ot,{}),n.jsxs(Ee,{overflowY:"auto",children:[n.jsx(U,{wrap:"wrap",children:o==null?void 0:o.map(y=>n.jsx(ts,{model:y,onClickInstallModel:z,installing:h},y.id))}),n.jsx(os,{})]})]})]}),n.jsx(ns,{fileSelected:!!S,isOpen:p,onClose:M,selectFolder:(y,w)=>{E(y,_.current?void 0:w)}})]})}function ps(){const{setRoute:t,route:e}=m.useContext(Ae);return m.useEffect(()=>{de.addEventListener("model_list",async s=>{var r;const o=(r=s.detail)==null?void 0:r.map(async a=>{const c=await R.models.get(a.model_name+"@"+a.model_type);if(c!=null&&c.fileHash)return c;let l={id:a.model_name+"@"+a.model_type,modelName:null,fileHash:a.file_hash??null,fileFolder:a.model_type,fileName:a.model_name+a.model_extension};if(!a.file_hash)return l;const d=await ce(a.file_hash);return l={...l,modelName:d.modelName??null,civitModelID:d.civitModelID,civitModelVersionID:d.civitModelVersionID,imageUrl:d.imageUrl??null},l}),i=(await Promise.all(o)).filter(a=>a!=null);await R.models.clear(),await R.models.bulkPut(i.filter(a=>a!=null)),window.dispatchEvent(new CustomEvent("model_list_updated"))})},[]),n.jsxs(Y,{style:{position:"relative"},children:[n.jsx(N,{size:"sm",backgroundColor:"#434554",color:"white",colorScheme:"blue","aria-label":"My models",onClick:()=>t("modelList"),px:1,height:wt+"px",children:"Models"}),e==="modelList"&&n.jsx(Xt,{onClose:()=>t("root")}),e==="installModels"&&n.jsx(as,{modelType:"Checkpoint",onclose:()=>t("root")})]})}export{ps as default};
