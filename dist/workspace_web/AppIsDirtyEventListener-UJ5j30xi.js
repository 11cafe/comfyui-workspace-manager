import{r as i,j as v}from"./input.js";import{app as n}from"/scripts/app.js";import{a6 as m,j as b,ar as S,o as y,E as k,A as u,as as E,B as A}from"./App-QwvEPfSB.js";import"/scripts/api.js";function C(l,p){const c=i.useRef(0),a=i.useCallback(()=>{c.current!==null&&(clearTimeout(c.current),c.current=0)},[]),w=i.useCallback((...g)=>{a(),c.current=setTimeout(()=>l(...g),p)},[l,p,a]);return i.useEffect(()=>()=>{a()},[]),[w,a]}function D(){const{setIsDirty:l,setRoute:p,saveCurWorkflow:c}=i.useContext(m),a=b();i.useEffect(()=>{let t=!0;const r=async e=>{switch(e){case k.SAVE:c();break;case k.SAVE_AS:p("saveAsModal");break}},o=n.canvas.onAfterChange;n.graph.onAfterChange=function(){o==null||o.apply(this,arguments),h()};const s=n.graph.onConfigure;n.graph.onConfigure=function(){if(t){t=!1;return}s==null||s.apply(this,arguments),h()},document.addEventListener("click",e=>{(n.canvas.node_over!=null||n.canvas.node_capturing_input!=null||n.canvas.node_widget!=null)&&h()}),document.addEventListener("keydown",async function(e){var d;if(document.visibilityState==="hidden")return;const f=await S(e);f?r(f):(d=e.target)!=null&&d.matches("input, textarea")&&Object.keys(n.canvas.selected_nodes??{}).length&&h()})},[]);const w=async()=>{var r,o,s,e;if(!((o=(r=u)==null?void 0:r.curWorkflow)!=null&&o.id))return;const t=JSON.stringify(n.graph.serialize());t!=null&&await((s=u)==null?void 0:s.updateFlow(u.curWorkflow.id,{json:t})),(e=E)==null||e.create({workflowID:u.curWorkflow.id,isAutoSave:!0,json:t}),l(!1),a({position:"bottom-left",duration:1e3,render:()=>v.jsx(A,{color:"white",p:3,children:"Auto saved"})})},[g,W]=C(w,1e3),h=async()=>{var r,o,s,e,f,d;if((o=(r=u)==null?void 0:r.curWorkflow)!=null&&o.saveLock)return;const t=await((s=y)==null?void 0:s.getSetting("autoSave"));if(!t){l(!0);return}(f=(e=u)==null?void 0:e.curWorkflow)!=null&&f.id&&t&&(await((d=u)==null?void 0:d.latestVersionCheck())?g():a({title:"Your changes cannot be saved!",description:"You are working on an outdated version. This workflow is changed by another tab. Please refresh to get the latest version.",status:"warning",isClosable:!0,duration:null}))};return null}export{D as default};
