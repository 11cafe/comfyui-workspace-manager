import{f as k,r as d,j as e,b as C,d as z,Y as N,c as ge,o as X,e as Z,g as xe,a6 as je,B as v,a2 as O,a7 as ye,G as ee,a8 as ve,J as te,L as se,N as _e,S as Se,M as we,H as be,K as Ce,P as Me,_ as Ie}from"./input.js";import{a5 as ke,a4 as Ee,p as Te,a6 as D,F as P,T as M,B as ne,V as oe,f as K,j as $,A as Ae,H as T,g as G,a7 as Le,a8 as ae,a1 as re,a9 as Pe,aa as De}from"./App-EbJ8EOYb.js";import{I as le,G as Re}from"./chunk-JARCRF6W-po8hqWTL.js";import{app as L}from"/scripts/app.js";import{api as R}from"/scripts/api.js";import{b as ie,P as Ne,c as Be,d as ze,e as Oe,f as Ke}from"./chunk-24I2HV4N-zY_d-lSh.js";var ce=k(function(s,r){const{spacing:o="0.5rem",spacingX:a,spacingY:n,children:i,justify:c,direction:l,align:u,className:h,shouldWrapChildren:p,...g}=s,_=d.useMemo(()=>p?d.Children.map(i,(j,y)=>e.jsx(U,{children:j},y)):i,[i,p]);return e.jsx(C.div,{ref:r,className:z("chakra-wrap",h),...g,children:e.jsx(C.ul,{className:"chakra-wrap__list",__css:{display:"flex",flexWrap:"wrap",justifyContent:c,alignItems:u,flexDirection:l,listStyleType:"none",gap:o,columnGap:a,rowGap:n,padding:"0"},children:_})})});ce.displayName="Wrap";var U=k(function(s,r){const{className:o,...a}=s;return e.jsx(C.li,{ref:r,__css:{display:"flex",alignItems:"flex-start"},className:z("chakra-wrap__listitem",o),...a})});U.displayName="WrapItem";function q(t){return Ee(t,s=>s==="auto"?"auto":`span ${s}/span ${s}`)}var de=k(function(s,r){const{area:o,colSpan:a,colStart:n,colEnd:i,rowEnd:c,rowSpan:l,rowStart:u,...h}=s,p=ke({gridArea:o,gridColumn:q(a),gridRow:q(l),gridColumnStart:n,gridColumnEnd:i,gridRowStart:u,gridRowEnd:c});return e.jsx(C.div,{ref:r,__css:p,...h})});de.displayName="GridItem";function Ge(t,s,r){return(t-s)*100/(r-s)}N({"0%":{strokeDasharray:"1, 400",strokeDashoffset:"0"},"50%":{strokeDasharray:"400, 400",strokeDashoffset:"-100"},"100%":{strokeDasharray:"400, 400",strokeDashoffset:"-260"}});N({"0%":{transform:"rotate(0deg)"},"100%":{transform:"rotate(360deg)"}});var Ue=N({"0%":{left:"-40%"},"100%":{left:"100%"}}),We=N({from:{backgroundPosition:"1rem 0"},to:{backgroundPosition:"0 0"}});function Ve(t){const{value:s=0,min:r,max:o,valueText:a,getValueText:n,isIndeterminate:i,role:c="progressbar"}=t,l=Ge(s,r,o);return{bind:{"data-indeterminate":i?"":void 0,"aria-valuemax":o,"aria-valuemin":r,"aria-valuenow":i?void 0:s,"aria-valuetext":(()=>{if(s!=null)return typeof n=="function"?n(s,l):a})(),role:c},percent:l,value:s}}var[He,Ye]=ge({name:"ProgressStylesContext",errorMessage:`useProgressStyles returned is 'undefined'. Seems you forgot to wrap the components in "<Progress />" `}),Fe=k((t,s)=>{const{min:r,max:o,value:a,isIndeterminate:n,role:i,...c}=t,l=Ve({value:a,min:r,max:o,isIndeterminate:n,role:i}),h={height:"100%",...Ye().filledTrack};return e.jsx(C.div,{ref:s,style:{width:`${l.percent}%`,...c.style},...l.bind,...c,__css:h})}),ue=k((t,s)=>{var r;const{value:o,min:a=0,max:n=100,hasStripe:i,isAnimated:c,children:l,borderRadius:u,isIndeterminate:h,"aria-label":p,"aria-labelledby":g,"aria-valuetext":_,title:j,role:y,...f}=X(t),m=Z("Progress",t),I=u??((r=m.track)==null?void 0:r.borderRadius),E={animation:`${We} 1s linear infinite`},x={...!h&&i&&c&&E,...h&&{position:"absolute",willChange:"left",minWidth:"50%",animation:`${Ue} 1s ease infinite normal none running`}},S={overflow:"hidden",position:"relative",...m.track};return e.jsx(C.div,{ref:s,borderRadius:I,__css:S,...f,children:e.jsxs(He,{value:m,children:[e.jsx(Fe,{"aria-label":p,"aria-labelledby":g,"aria-valuetext":_,min:a,max:n,value:o,isIndeterminate:h,css:x,borderRadius:I,title:j,role:y}),l]})})});ue.displayName="Progress";var pe=k(function(s,r){const{children:o,placeholder:a,className:n,...i}=s;return e.jsxs(C.select,{...i,ref:r,className:z("chakra-select",n),children:[a&&e.jsx("option",{value:"",children:a}),o]})});pe.displayName="SelectField";function $e(t,s){const r={},o={};for(const[a,n]of Object.entries(t))s.includes(a)?r[a]=n:o[a]=n;return[r,o]}var W=k((t,s)=>{var r;const o=Z("Select",t),{rootProps:a,placeholder:n,icon:i,color:c,height:l,h:u,minH:h,minHeight:p,iconColor:g,iconSize:_,...j}=X(t),[y,f]=$e(j,je),m=Te(f),I={width:"100%",height:"fit-content",position:"relative",color:c},E={paddingEnd:"2rem",...o.field,_focus:{zIndex:"unset",...(r=o.field)==null?void 0:r._focus}};return e.jsxs(C.div,{className:"chakra-select__wrapper",__css:I,...y,...a,children:[e.jsx(pe,{ref:s,height:u??l,minH:h??p,placeholder:n,...m,__css:E,children:t.children}),e.jsx(he,{"data-disabled":xe(m.disabled),...(g||c)&&{color:g||c},__css:o.icon,..._&&{fontSize:_},children:i})]})});W.displayName="Select";var qe=t=>e.jsx("svg",{viewBox:"0 0 24 24",...t,children:e.jsx("path",{fill:"currentColor",d:"M16.59 8.59L12 13.17 7.41 8.59 6 10l6 6 6-6z"})}),Je=C("div",{baseStyle:{position:"absolute",display:"inline-flex",alignItems:"center",justifyContent:"center",pointerEvents:"none",top:"50%",transform:"translateY(-50%)"}}),he=t=>{const{children:s=e.jsx(qe,{}),...r}=t,o=d.cloneElement(s,{role:"presentation",className:"chakra-select__icon",focusable:!1,"aria-hidden":!0,style:{width:"1em",height:"1em",color:"currentColor"}});return e.jsx(Je,{...r,className:"chakra-select__icon-wrapper",children:d.isValidElement(s)?o:null})};he.displayName="SelectIcon";function Qe({selectedModel:t,setSelectedModel:s,modelTypeList:r}){const o=a=>{s(a)};return e.jsx(ce,{children:r.map(a=>e.jsx(U,{children:e.jsx(v,{colorScheme:"blue",variant:t===a?"solid":"outline",onClick:()=>o(a),size:"sm",children:a})},a))})}const Xe={checkpoints:"CheckpointLoaderSimple",vae:"VAELoader",loras:"LoraLoader",controlnet:"ControlNetLoader",upscale_models:"UpscaleModelLoader"};function Ze({data:t}){const[s,r]=d.useState("https://image.civitai.com/xG1nkqKTMzGDvpLrqFT7WA/27fd7433-cb0a-4a87-88c1-21ccb2b1a842/width=450/00060-881622046.jpeg"),[o,a]=d.useState(!t.file_hash),[n,i]=d.useState();d.useEffect(()=>{a(!t.file_hash),c()},[t.file_hash]);const c=async()=>{var h,p;const u=await D.models.get(t.model_name+"@"+t.model_type);if(u!=null)i(u),(h=u.imageUrl)!=null&&h.length&&r(u.imageUrl);else if(t.file_hash!=null)try{const g=`https://civitai.com/api/v1/model-versions/by-hash/${t.file_hash}`,j=await(await fetch(g)).json(),y=(p=j==null?void 0:j.images)==null?void 0:p.at(0),f=y==null?void 0:y.url;f&&r(f),D.models.add({id:t.model_name+"@"+t.model_type,fileHash:t.file_hash,fileFolder:t.model_type,fileName:t.model_name,civitModelID:j.modelId,civitModelVersionID:j.id,imageUrl:f??null})}catch{}},l=u=>{const h=Xe[t.model_type];h&&(u.dataTransfer.setData("eventName","WorkspaceManagerAddNode"),u.dataTransfer.setData("modelRelativePath",t.model_name+t.model_extension),u.dataTransfer.setData("nodeType",h))};return o?e.jsxs(P,{position:"relative",borderRadius:4,bg:"rgba(0, 0, 0, 0.5)",height:178,justifyContent:"center",alignItems:"center",children:[e.jsx(O,{}),e.jsx(M,{position:"absolute",bottom:"0",left:"0",right:"0",bg:"rgba(0, 0, 0, 0.5)",color:"white",textAlign:"center",p:"0",fontSize:12,borderBottomRightRadius:4,borderBottomLeftRadius:4,children:t.model_name})]}):e.jsxs(ne,{position:"relative",borderRadius:4,draggable:!0,onDragStart:l,children:[e.jsx(le,{src:s,draggable:!1,boxSize:"100%",height:178,objectFit:"cover",borderRadius:4,onClick:()=>{(n==null?void 0:n.civitModelID)==null||(n==null?void 0:n.civitModelVersionID)==null||window.open(`https://civitai.com/models/${n==null?void 0:n.civitModelID}?modelVersionId=${n==null?void 0:n.civitModelVersionID}`)}}),e.jsx(M,{position:"absolute",bottom:"0",left:"0",right:"0",bg:"rgba(0, 0, 0, 0.5)",color:"white",textAlign:"center",p:"0",fontSize:12,borderBottomRightRadius:4,borderBottomLeftRadius:4,children:t.model_name})]})}function et({list:t}){return e.jsx(Re,{templateColumns:"repeat(3, 1fr)",gap:1,marginTop:2,children:t.map(s=>e.jsx(de,{children:e.jsx(Ze,{data:s})},s.model_name))})}const tt=async t=>{window.dispatchEvent(new CustomEvent("model_install_message",{detail:`Installing model ${t.filename} to ${t.save_path}, check progress in the server console.`}));try{const r=await(await R.fetchApi("/model_manager/install_model",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})).text();window.dispatchEvent(new CustomEvent("model_install_message",{detail:r}))}catch(s){console.error("Failed to connect to the server:",s)}};function J(t,s=1){const a=t/1024;return a>=1024?(a/1024).toFixed(s)+" GB":a.toFixed(s)+" MB"}const Q=280;function st({model:t,onClickInstallModel:s,installing:r}){var p,g,_,j,y;const o=(j=(_=(g=(p=t.modelVersions)==null?void 0:p.at(0))==null?void 0:g.images)==null?void 0:_.at(0))==null?void 0:j.url,a=t.modelVersions,n=a==null?void 0:a.map(f=>{var m;return(m=f==null?void 0:f.files)==null?void 0:m.at(0)}),[i,c]=d.useState(((y=n==null?void 0:n.at(0))==null?void 0:y.name)??""),l=n==null?void 0:n.find(f=>(f==null?void 0:f.name)===i),u=()=>{window.open(`https://civitai.com/models/${t.id}`)},h=d.useCallback(()=>{if(l==null){console.error("no file is find by name",i);return}s(l,t)},[i]);return e.jsxs(oe,{width:Q,justifyContent:"space-between",mb:2,gap:1,children:[e.jsx(le,{borderRadius:3,boxSize:Q+"px",objectFit:"cover",src:o,alt:"model cover image",cursor:"pointer",onClick:()=>u()}),e.jsxs(K,{p:1,children:[e.jsx($,{label:t.name,children:e.jsx(M,{fontWeight:500,noOfLines:1,children:t.name})}),e.jsxs(P,{justifyContent:"space-between",alignItems:"center",children:[e.jsx(v,{borderRadius:14,noOfLines:1,size:"xs",colorScheme:"teal",maxWidth:"40%",flexShrink:1,variant:"outline",px:1,cursor:"text",children:e.jsx(M,{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",children:t.type})}),e.jsx(v,{leftIcon:e.jsx(Ae,{size:18}),iconSpacing:1,borderRadius:10,size:"sm",py:1,colorScheme:"teal",type:"submit",onClick:()=>h(),isDisabled:!!(i&&r.includes(i)),children:"Install"})]}),e.jsxs(T,{children:[e.jsx(W,{size:"md",style:{paddingLeft:4},onChange:f=>{c(f.target.value)},children:n==null?void 0:n.map(f=>{const m=f==null?void 0:f.name;return m?e.jsx("option",{value:m,style:{padding:0},children:m},f.id):null})}),(l==null?void 0:l.sizeKB)&&e.jsx($,{label:J(l.sizeKB),children:e.jsx(M,{flexShrink:1,noOfLines:1,width:"40%",children:J(l.sizeKB)})})]})]})]})}function nt({searchQuery:t,setSearchQuery:s,onSearch:r}){return e.jsxs(P,{gap:1,alignItems:"center",grow:1,children:[e.jsx(G,{placeholder:"Search models in CivitAI",width:"60%",value:t,onChange:o=>s(o.target.value),onKeyUp:o=>{o.code==="Enter"&&r()}}),e.jsx(v,{size:"sm",onClick:()=>r(),colorScheme:"teal",children:"Search"})]})}function ot({isOpen:t,onClose:s,selectFolder:r}){const[o,a]=d.useState(""),[n,i]=d.useState([]),[c,l]=d.useState(""),u=d.useRef(null);d.useEffect(()=>{h()},[]);const h=async()=>{const p=await Le();p&&i(p.filter(g=>!["custom_nodes","config","saved_prompts"].includes(g)))};return e.jsx(ye,{isOpen:t,leastDestructiveRef:u,onClose:s,children:e.jsx(ee,{children:e.jsxs(ve,{children:[e.jsx(te,{fontSize:"lg",fontWeight:"bold",children:"Choose Folder"}),e.jsxs(se,{children:[e.jsx(M,{children:"Model download url"}),e.jsx(G,{placeholder:"https://civitai.com/api/download/models/311399",onChange:p=>l(p.target.value),value:c}),e.jsx(W,{placeholder:"Select option",value:o,onChange:p=>a(p.target.value),children:n.map(p=>e.jsx("option",{value:p,children:p},p))})]}),e.jsxs(_e,{children:[e.jsx(v,{ref:u,onClick:s,children:"Cancel"}),e.jsx(v,{onClick:()=>r(o,c),ml:3,isDisabled:c.length===0,children:"Confirm"})]})]})})})}function at(){const{colorMode:t}=Se(),s=ie(),[r,o]=d.useState([]);return d.useEffect(()=>{R.addEventListener("download_progress",a=>{o(a.detail)}),R.addEventListener("download_error",a=>{s({title:"Download Error",description:a.detail,status:"error",duration:4e3,isClosable:!0})})},[]),e.jsx(K,{spacing:5,pos:"absolute",bottom:"0",left:"0",width:"50%",zIndex:80,backgroundColor:t==="light"?"white":"#242424",paddingX:5,children:r.map(({save_path:a,progress:n})=>e.jsxs(T,{children:[e.jsx(M,{fontSize:16,width:"40%",children:a.replace(/^.*[\\/]/,"")}),e.jsx(ue,{isIndeterminate:!n,hasStripe:!0,width:"50%",value:n}),e.jsxs(M,{fontSize:16,width:"10%",children:[n.toFixed(1),"%"]})]},a))})}const me="WORKSPACE_CIVIT_API_KEY_STORAGE_KEY";function rt(){return localStorage.getItem(me)}function lt(t){localStorage.setItem(me,t)}function it(){const[t,s]=d.useState(""),{onOpen:r,onClose:o,isOpen:a}=ae(),n=()=>{lt(t),o()};return e.jsxs(Ne,{isOpen:a,onOpen:r,onClose:o,placement:"right",closeOnBlur:!1,children:[e.jsx(Be,{children:e.jsx(v,{size:"sm",py:1,mr:8,children:"Set API Key"})}),e.jsxs(ze,{p:5,children:[e.jsx(Oe,{}),e.jsx(Ke,{}),e.jsxs(K,{spacing:4,children:[e.jsx(G,{value:t,onChange:i=>s(i.target.value),placeholder:"API Key"}),e.jsx(v,{size:"sm",py:1,mr:8,onClick:n,children:"Save"})]})]})]})}const ct=["Checkpoint","TextualInversion","Hypernetwork","LORA","Controlnet","Upscaler","VAE"],dt=2,ut={Checkpoint:"checkpoints",TextualInversion:"embeddings",Hypernetwork:"hypernetworks",LORA:"loras",Controlnet:"controlnet",Upscaler:"upscale_models",VAE:"vae"};function pt({onclose:t,searchQuery:s="",modelType:r}){const[o,a]=d.useState([]),[n,i]=d.useState(!1),[c,l]=d.useState(r),u=ie(),[h,p]=d.useState([]),[g,_]=d.useState(s),{isOpen:j,onOpen:y,onClose:f}=ae(),m=d.useRef(),I=d.useCallback(async()=>{var F;i(!0);const x={limit:"30",nsfw:"false"};g!==""&&(x.query=g),c!=null&&(x.types=c);const w=`https://civitai.com/api/v1/models?${new URLSearchParams(x).toString()}`,b=await((F=D.cache)==null?void 0:F.get(w));if((b==null?void 0:b.value)!=null)try{const{data:B,timestamp:fe}=JSON.parse(b==null?void 0:b.value);if((Date.now()-fe)/(1e3*60*60*24)<dt){a(B),i(!1);return}}catch(B){console.error("err fetching cache",B)}const A=await(await fetch(w)).json();a(A.items),g===""&&D.cache.put({id:w,value:JSON.stringify({data:A.items,timestamp:Date.now()})}),i(!1)},[g,c]),E=x=>{var b;if(!((b=m.current)!=null&&b.downloadUrl)){console.error("file.downloadUrl is null");return}if(!m.current.name&&(m.current.name=m.current.downloadUrl.split("/").pop(),!m.current.name)){console.error("file.downloadUrl is malformed");return}u({title:"Installing...",description:m.current.name,status:"info",duration:4e3,isClosable:!0}),m.current.name!=null&&p(Y=>{var A;return[...Y,((A=m.current)==null?void 0:A.name)??""]});let S=m.current.downloadUrl;const w=rt();w&&(S+=`?token=${w}`),tt({filename:m.current.name,name:m.current.name,save_path:x,url:S}),f()},V=(x,S)=>{const w=ut[S.type];m.current=x,w==null?y():E(w)},H=()=>{y()};return d.useEffect(()=>{I()},[c]),e.jsxs(e.Fragment,{children:[e.jsxs(we,{isOpen:!0,onClose:t,blockScrollOnMount:!0,children:[e.jsx(ee,{}),e.jsxs(be,{width:"90%",maxWidth:"90vw",height:"90vh",children:[e.jsxs(te,{children:[e.jsxs(T,{gap:2,mb:2,alignItems:"center",children:[e.jsx(re,{size:"md",mr:2,children:"Models"}),e.jsx(nt,{searchQuery:g,setSearchQuery:_,onSearch:I}),e.jsx(v,{size:"sm",py:1,mr:8,onClick:H,children:"Custom URL Install"}),e.jsx(it,{})]}),e.jsxs(T,{gap:2,mb:2,wrap:"wrap",children:[e.jsx(v,{size:"sm",py:1,onClick:()=>{l(void 0)},isActive:c==null,children:"All"}),ct.map(x=>e.jsx(v,{size:"sm",py:1,isActive:c===x,onClick:()=>{l(x)},children:x},x))]}),n&&e.jsx(O,{thickness:"4px",emptyColor:"gray.200",color:"pink.500",size:"lg"})]}),e.jsx(Ce,{}),e.jsxs(se,{overflowY:"auto",children:[e.jsx(T,{wrap:"wrap",children:o==null?void 0:o.map(x=>e.jsx(st,{model:x,onClickInstallModel:V,installing:h},x.id))}),e.jsx(at,{})]})]})]}),e.jsx(ot,{isOpen:j,onClose:f,selectFolder:(x,S)=>{m.current={id:0,downloadUrl:S},E(x)}})]})}function ht(){const[t,s]=d.useState(!1);return e.jsxs(e.Fragment,{children:[e.jsx(v,{size:"sm",colorScheme:"teal",onClick:()=>s(!0),children:"Install Models"}),t&&e.jsx(pt,{modelType:"Checkpoint",onclose:()=>s(!1)})]})}const mt=()=>{const[t,s]=d.useState(["checkpoints"]),[r,o]=d.useState([]),[a,n]=d.useState(!0);d.useEffect(()=>{i(),R.addEventListener("model_list",l=>{c(l.detail)})},[]);const i=async()=>{const l=await Pe();c(l)},c=async l=>{if(!l)return;n(!1);const u=Array.from(new Set(l.map(p=>p.model_type))),h=u.indexOf("checkpoints");h>=0&&u.splice(h,1),u.unshift("checkpoints"),s(u),o(l)};return{modelTypeList:t,modelsList:r,loading:a}};function ft({onClose:t}){const[s,r]=d.useState("checkpoints"),{loading:o,modelTypeList:a,modelsList:n}=mt(),[i,c]=d.useState([]);d.useEffect(()=>{const h=n.filter(p=>p.model_type===s);c(h)},[s,n]),d.useEffect(()=>(L.canvasEl.addEventListener("click",t),()=>{L.canvasEl.removeEventListener("click",t)}),[]);const l=440,u=()=>e.jsxs(e.Fragment,{children:[e.jsx(Qe,{modelTypeList:a,setSelectedModel:r,selectedModel:s}),e.jsx(et,{list:i}),o&&e.jsx(P,{justifyContent:"center",alignItems:"center",height:"100%",children:e.jsx(O,{})})]});return e.jsx(Me,{children:e.jsx(ne,{style:{width:l},children:e.jsxs(oe,{width:l,height:"100vh",p:4,gap:2,position:"fixed",top:0,left:0,shadow:"xl",zIndex:1e3,overflowY:"auto",children:[e.jsx(De,{children:e.jsxs(P,{justifyContent:"space-between",alignContent:"center",children:[e.jsx(re,{size:"md",mr:2,children:"Models"}),e.jsx(ht,{})]})}),u()]})})})}const gt=d.lazy(()=>Ie(()=>import("./InstallMissingModelsButton-CR0pkpRT.js"),__vite__mapDeps([0,1,2,3,4,5,6])));function xt({}){const[t,s]=d.useState(!1),r=async o=>{if(o.dataTransfer.getData("eventName")!=="WorkspaceManagerAddNode")return;const n=o.dataTransfer.getData("modelRelativePath"),i=o.dataTransfer.getData("nodeType"),c=LiteGraph.createNode(i);c.pos=[o.canvasX,o.canvasY],c.configure({widgets_values:[n]}),L.graph.add(c)};return d.useEffect(()=>(L.canvasEl.addEventListener("drop",r),()=>{L.canvasEl.removeEventListener("drop",r)}),[]),e.jsxs(T,{position:"fixed",top:2,right:2,gap:2,children:[e.jsx(gt,{}),e.jsx(v,{size:"sm",colorScheme:"blue","aria-label":"My models",onClick:()=>s(!0),px:1,children:"Models"}),t&&e.jsx(ft,{onClose:()=>s(!1)})]})}const Ct=Object.freeze(Object.defineProperty({__proto__:null,default:xt},Symbol.toStringTag,{value:"Module"}));export{de as G,ht as I,Ct as M};
function __vite__mapDeps(indexes) {
  if (!__vite__mapDeps.viteFileDeps) {
    __vite__mapDeps.viteFileDeps = ["workspace_web/InstallMissingModelsButton-CR0pkpRT.js","workspace_web/input.js","workspace_web/App-EbJ8EOYb.js","workspace_web/assets/App-JXePnJiV.css","workspace_web/chunk-NTCQBYKE-HF59WNUB.js","workspace_web/chunk-JARCRF6W-po8hqWTL.js","workspace_web/chunk-24I2HV4N-zY_d-lSh.js"]
  }
  return indexes.map((i) => __vite__mapDeps.viteFileDeps[i])
}