import{f as M,r as c,j as e,b,d as B,Z as A,c as de,o as Y,e as K,g as ue,a7 as he,B as _,a3 as z,a8 as me,G as q,a9 as pe,J,L as X,N as fe,T as ge,M as xe,H as je,K as ve,P as ye,R as we,_ as _e}from"./input.js";import{ad as Se,ac as be,A as Me,ae as R,F as T,T as k,B as Q,a2 as Z,n as ee,r as H,N as Ce,H as L,o as Ie,af as ke,ag as Le,a9 as te,ah as Ee,ai as De}from"./App-ddGdajIL.js";import{I as se,G as Te}from"./chunk-JARCRF6W-po8hqWTL.js";import{app as D}from"/scripts/app.js";import{api as P}from"/scripts/api.js";import{u as ne}from"./chunk-6RSEZNRH-3Efv3ksN.js";var ae=M(function(s,o){const{spacing:r="0.5rem",spacingX:a,spacingY:n,children:d,justify:u,direction:i,align:l,className:h,shouldWrapChildren:f,...v}=s,y=c.useMemo(()=>f?c.Children.map(d,(x,m)=>e.jsx(O,{children:x},m)):d,[d,f]);return e.jsx(b.div,{ref:o,className:B("chakra-wrap",h),...v,children:e.jsx(b.ul,{className:"chakra-wrap__list",__css:{display:"flex",flexWrap:"wrap",justifyContent:u,alignItems:l,flexDirection:i,listStyleType:"none",gap:r,columnGap:a,rowGap:n,padding:"0"},children:y})})});ae.displayName="Wrap";var O=M(function(s,o){const{className:r,...a}=s;return e.jsx(b.li,{ref:o,__css:{display:"flex",alignItems:"flex-start"},className:B("chakra-wrap__listitem",r),...a})});O.displayName="WrapItem";function V(t){return be(t,s=>s==="auto"?"auto":`span ${s}/span ${s}`)}var oe=M(function(s,o){const{area:r,colSpan:a,colStart:n,colEnd:d,rowEnd:u,rowSpan:i,rowStart:l,...h}=s,f=Se({gridArea:r,gridColumn:V(a),gridRow:V(i),gridColumnStart:n,gridColumnEnd:d,gridRowStart:l,gridRowEnd:u});return e.jsx(b.div,{ref:o,__css:f,...h})});oe.displayName="GridItem";function Re(t,s,o){return(t-s)*100/(o-s)}A({"0%":{strokeDasharray:"1, 400",strokeDashoffset:"0"},"50%":{strokeDasharray:"400, 400",strokeDashoffset:"-100"},"100%":{strokeDasharray:"400, 400",strokeDashoffset:"-260"}});A({"0%":{transform:"rotate(0deg)"},"100%":{transform:"rotate(360deg)"}});var Pe=A({"0%":{left:"-40%"},"100%":{left:"100%"}}),Ae=A({from:{backgroundPosition:"1rem 0"},to:{backgroundPosition:"0 0"}});function Ne(t){const{value:s=0,min:o,max:r,valueText:a,getValueText:n,isIndeterminate:d,role:u="progressbar"}=t,i=Re(s,o,r);return{bind:{"data-indeterminate":d?"":void 0,"aria-valuemax":r,"aria-valuemin":o,"aria-valuenow":d?void 0:s,"aria-valuetext":(()=>{if(s!=null)return typeof n=="function"?n(s,i):a})(),role:u},percent:i,value:s}}var[Be,ze]=de({name:"ProgressStylesContext",errorMessage:`useProgressStyles returned is 'undefined'. Seems you forgot to wrap the components in "<Progress />" `}),Oe=M((t,s)=>{const{min:o,max:r,value:a,isIndeterminate:n,role:d,...u}=t,i=Ne({value:a,min:o,max:r,isIndeterminate:n,role:d}),h={height:"100%",...ze().filledTrack};return e.jsx(b.div,{ref:s,style:{width:`${i.percent}%`,...u.style},...i.bind,...u,__css:h})}),re=M((t,s)=>{var o;const{value:r,min:a=0,max:n=100,hasStripe:d,isAnimated:u,children:i,borderRadius:l,isIndeterminate:h,"aria-label":f,"aria-labelledby":v,"aria-valuetext":y,title:x,role:m,...p}=Y(t),j=K("Progress",t),C=l??((o=j.track)==null?void 0:o.borderRadius),E={animation:`${Ae} 1s linear infinite`},S={...!h&&d&&u&&E,...h&&{position:"absolute",willChange:"left",minWidth:"50%",animation:`${Pe} 1s ease infinite normal none running`}},w={overflow:"hidden",position:"relative",...j.track};return e.jsx(b.div,{ref:s,borderRadius:C,__css:w,...p,children:e.jsxs(Be,{value:j,children:[e.jsx(Oe,{"aria-label":f,"aria-labelledby":v,"aria-valuetext":y,min:a,max:n,value:r,isIndeterminate:h,css:S,borderRadius:C,title:x,role:m}),i]})})});re.displayName="Progress";var le=M(function(s,o){const{children:r,placeholder:a,className:n,...d}=s;return e.jsxs(b.select,{...d,ref:o,className:B("chakra-select",n),children:[a&&e.jsx("option",{value:"",children:a}),r]})});le.displayName="SelectField";function Ue(t,s){const o={},r={};for(const[a,n]of Object.entries(t))s.includes(a)?o[a]=n:r[a]=n;return[o,r]}var U=M((t,s)=>{var o;const r=K("Select",t),{rootProps:a,placeholder:n,icon:d,color:u,height:i,h:l,minH:h,minHeight:f,iconColor:v,iconSize:y,...x}=Y(t),[m,p]=Ue(x,he),j=Me(p),C={width:"100%",height:"fit-content",position:"relative",color:u},E={paddingEnd:"2rem",...r.field,_focus:{zIndex:"unset",...(o=r.field)==null?void 0:o._focus}};return e.jsxs(b.div,{className:"chakra-select__wrapper",__css:C,...m,...a,children:[e.jsx(le,{ref:s,height:l??i,minH:h??f,placeholder:n,...j,__css:E,children:t.children}),e.jsx(ie,{"data-disabled":ue(j.disabled),...(v||u)&&{color:v||u},__css:r.icon,...y&&{fontSize:y},children:d})]})});U.displayName="Select";var Ge=t=>e.jsx("svg",{viewBox:"0 0 24 24",...t,children:e.jsx("path",{fill:"currentColor",d:"M16.59 8.59L12 13.17 7.41 8.59 6 10l6 6 6-6z"})}),We=b("div",{baseStyle:{position:"absolute",display:"inline-flex",alignItems:"center",justifyContent:"center",pointerEvents:"none",top:"50%",transform:"translateY(-50%)"}}),ie=t=>{const{children:s=e.jsx(Ge,{}),...o}=t,r=c.cloneElement(s,{role:"presentation",className:"chakra-select__icon",focusable:!1,"aria-hidden":!0,style:{width:"1em",height:"1em",color:"currentColor"}});return e.jsx(We,{...o,className:"chakra-select__icon-wrapper",children:c.isValidElement(s)?r:null})};ie.displayName="SelectIcon";function He({selectedModel:t,setSelectedModel:s,modelTypeList:o}){const r=a=>{s(a)};return e.jsx(ae,{children:o.map(a=>e.jsx(O,{children:e.jsx(_,{colorScheme:"blue",variant:t===a?"solid":"outline",onClick:()=>r(a),size:"sm",children:a})}))})}const Ve={checkpoints:"CheckpointLoaderSimple",vae:"VAELoader",loras:"LoraLoader",controlnet:"ControlNetLoader",upscale_models:"UpscaleModelLoader"};function Fe({data:t}){const[s,o]=c.useState("https://image.civitai.com/xG1nkqKTMzGDvpLrqFT7WA/27fd7433-cb0a-4a87-88c1-21ccb2b1a842/width=450/00060-881622046.jpeg"),[r,a]=c.useState(!t.file_hash),[n,d]=c.useState();c.useEffect(()=>{a(!t.file_hash),u()},[t.file_hash]);const u=async()=>{var h,f;const l=await R.models.get(t.model_name+"@"+t.model_type);if(l!=null)d(l),(h=l.imageUrl)!=null&&h.length&&o(l.imageUrl);else if(t.file_hash!=null)try{const v=`https://civitai.com/api/v1/model-versions/by-hash/${t.file_hash}`,x=await(await fetch(v)).json(),m=(f=x==null?void 0:x.images)==null?void 0:f.at(0),p=m==null?void 0:m.url;p&&o(p),R.models.add({id:t.model_name+"@"+t.model_type,fileHash:t.file_hash,fileFolder:t.model_type,fileName:t.model_name,civitModelID:x.modelId,civitModelVersionID:x.id,imageUrl:p??null})}catch{}},i=l=>{const h=Ve[t.model_type];h&&(l.dataTransfer.setData("eventName","WorkspaceManagerAddNode"),l.dataTransfer.setData("modelRelativePath",t.model_name+t.model_extension),l.dataTransfer.setData("nodeType",h))};return r?e.jsxs(T,{position:"relative",borderRadius:4,bg:"rgba(0, 0, 0, 0.5)",height:178,justifyContent:"center",alignItems:"center",children:[e.jsx(z,{}),e.jsx(k,{position:"absolute",bottom:"0",left:"0",right:"0",bg:"rgba(0, 0, 0, 0.5)",color:"white",textAlign:"center",p:"0",fontSize:12,borderBottomRightRadius:4,borderBottomLeftRadius:4,children:t.model_name})]}):e.jsxs(Q,{position:"relative",borderRadius:4,draggable:!0,onDragStart:i,children:[e.jsx(se,{src:s,draggable:!1,boxSize:"100%",height:178,objectFit:"cover",borderRadius:4,onClick:()=>{(n==null?void 0:n.civitModelID)==null||(n==null?void 0:n.civitModelVersionID)==null||window.open(`https://civitai.com/models/${n==null?void 0:n.civitModelID}?modelVersionId=${n==null?void 0:n.civitModelVersionID}`)}}),e.jsx(k,{position:"absolute",bottom:"0",left:"0",right:"0",bg:"rgba(0, 0, 0, 0.5)",color:"white",textAlign:"center",p:"0",fontSize:12,borderBottomRightRadius:4,borderBottomLeftRadius:4,children:t.model_name})]})}function $e({list:t}){return e.jsx(Te,{templateColumns:"repeat(3, 1fr)",gap:1,marginTop:2,children:t.map(s=>e.jsx(oe,{children:e.jsx(Fe,{data:s},s.model_name)}))})}const Ye=async t=>{window.dispatchEvent(new CustomEvent("model_install_message",{detail:`Installing model ${t.filename} to ${t.save_path}, check progress in the server console.`}));try{const o=await(await P.fetchApi("/model_manager/install_model",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})).text();window.dispatchEvent(new CustomEvent("model_install_message",{detail:o}))}catch(s){console.error("Failed to connect to the server:",s)}};function F(t,s=1){const a=t/1024;return a>=1024?(a/1024).toFixed(s)+" GB":a.toFixed(s)+" MB"}const $=280;function Ke({model:t,onClickInstallModel:s,installing:o}){var f,v,y,x,m;const r=(x=(y=(v=(f=t.modelVersions)==null?void 0:f.at(0))==null?void 0:v.images)==null?void 0:y.at(0))==null?void 0:x.url,a=t.modelVersions,n=a==null?void 0:a.map(p=>{var j;return(j=p==null?void 0:p.files)==null?void 0:j.at(0)}),[d,u]=c.useState(((m=n==null?void 0:n.at(0))==null?void 0:m.name)??""),i=n==null?void 0:n.find(p=>(p==null?void 0:p.name)===d),l=()=>{window.open(`https://civitai.com/models/${t.id}`)},h=c.useCallback(()=>{if(i==null){console.error("no file is find by name",d);return}s(i,t)},[d]);return e.jsxs(Z,{width:$,justifyContent:"space-between",mb:2,gap:1,children:[e.jsx(se,{borderRadius:3,boxSize:$+"px",objectFit:"cover",src:r,alt:"model cover image",cursor:"pointer",onClick:()=>l()}),e.jsxs(ee,{p:1,children:[e.jsx(H,{label:t.name,children:e.jsx(k,{fontWeight:500,noOfLines:1,children:t.name})}),e.jsxs(T,{justifyContent:"space-between",alignItems:"center",children:[e.jsx(_,{borderRadius:14,noOfLines:1,size:"xs",colorScheme:"teal",maxWidth:"40%",flexShrink:1,variant:"outline",px:1,cursor:"text",children:e.jsx(k,{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",children:t.type})}),e.jsx(_,{leftIcon:e.jsx(Ce,{size:18}),iconSpacing:1,borderRadius:10,size:"sm",py:1,colorScheme:"teal",type:"submit",onClick:()=>h(),isDisabled:!!(d&&o.includes(d)),children:"Install"})]}),e.jsxs(L,{children:[e.jsx(U,{size:"md",style:{paddingLeft:4},onChange:p=>{u(p.target.value)},children:n==null?void 0:n.map(p=>{const j=p==null?void 0:p.name;return j?e.jsx("option",{value:j,style:{padding:0},children:j},p.id):null})}),(i==null?void 0:i.sizeKB)&&e.jsx(H,{label:F(i.sizeKB),children:e.jsx(k,{flexShrink:1,noOfLines:1,width:"40%",children:F(i.sizeKB)})})]})]})]})}function qe({setSearchQuery:t}){const[s,o]=c.useState("");return e.jsxs(T,{gap:1,alignItems:"center",grow:1,children:[e.jsx(Ie,{placeholder:"Search models in CivitAI",width:"60%",value:s,onChange:r=>o(r.target.value),onKeyUp:r=>{r.code==="Enter"&&t(s)}}),e.jsx(_,{size:"sm",onClick:()=>t(s),colorScheme:"teal",children:"Search"})]})}function Je({isOpen:t,onClose:s,selectFolder:o}){const[r,a]=c.useState(""),[n,d]=c.useState([]),u=c.useRef(null);c.useEffect(()=>{i()},[]);const i=async()=>{const l=await ke();l&&d(l)};return e.jsx(me,{isOpen:t,leastDestructiveRef:u,onClose:s,children:e.jsx(q,{children:e.jsxs(pe,{children:[e.jsx(J,{fontSize:"lg",fontWeight:"bold",children:"Choose Folder"}),e.jsx(X,{children:e.jsx(U,{placeholder:"Select option",value:r,onChange:l=>a(l.target.value),children:n.map(l=>e.jsx("option",{value:l,children:l}))})}),e.jsxs(fe,{children:[e.jsx(_,{ref:u,onClick:s,children:"Cancel"}),e.jsx(_,{onClick:()=>o(r),ml:3,children:"Confirm"})]})]})})})}function Xe(){const{colorMode:t}=ge(),s=ne(),[o,r]=c.useState([]);return c.useEffect(()=>{P.addEventListener("download_progress",a=>{r(a.detail)}),P.addEventListener("download_error",a=>{s({title:"Download Error",description:a.detail,status:"error",duration:4e3,isClosable:!0})})},[]),e.jsx(ee,{spacing:5,pos:"absolute",bottom:"0",left:"0",width:"50%",zIndex:80,backgroundColor:t==="light"?"white":"#242424",paddingX:5,children:o.map(({save_path:a,progress:n})=>e.jsxs(L,{children:[e.jsx(k,{fontSize:16,width:"40%",children:a.replace(/^.*[\\/]/,"")}),e.jsx(re,{isIndeterminate:!n,hasStripe:!0,width:"60%",value:n})]}))})}const Qe=["Checkpoint","TextualInversion","Hypernetwork","LORA","Controlnet","Upscaler","VAE"],Ze=2,et={Checkpoint:"checkpoints",TextualInversion:"embeddings",Hypernetwork:"hypernetworks",LORA:"loras",Controlnet:"controlnet",Upscaler:"upscale_models",VAE:"vae"};function tt({onclose:t}){const[s,o]=c.useState([]),[r,a]=c.useState(!1),[n,d]=c.useState("Checkpoint"),u=ne(),[i,l]=c.useState([]),[h,f]=c.useState(""),{isOpen:v,onOpen:y,onClose:x}=Le(),m=c.useRef(),p=c.useCallback(async()=>{var W;a(!0);const g={limit:"30",nsfw:"false"};h!==""&&(g.query=h),n!=null&&(g.types=n);const S=`https://civitai.com/api/v1/models?${new URLSearchParams(g).toString()}`,w=await((W=R.cache)==null?void 0:W.get(S));if((w==null?void 0:w.value)!=null)try{const{data:N,timestamp:ce}=JSON.parse(w==null?void 0:w.value);if((Date.now()-ce)/(1e3*60*60*24)<Ze){o(N),a(!1);return}}catch(N){console.error("err fetching cache",N)}const G=await(await fetch(S)).json();o(G.items),h===""&&R.cache.add({id:S,value:JSON.stringify({data:G.items,timestamp:Date.now()})}),a(!1)},[h,n]),j=g=>{var I;if(!((I=m.current)!=null&&I.downloadUrl)){console.error("file.downloadUrl is null");return}if(!m.current.name&&(m.current.name=m.current.downloadUrl.split("/").pop(),!m.current.name)){console.error("file.downloadUrl is malformed");return}u({title:"Installing...",description:m.current.name,status:"info",duration:4e3,isClosable:!0}),m.current.name!=null&&l(S=>{var w;return[...S,((w=m.current)==null?void 0:w.name)??""]}),Ye({filename:m.current.name,name:m.current.name,save_path:g,url:m.current.downloadUrl}),x()},C=(g,I)=>{let S=et[I.type];m.current=g,S==null?y():j(S)},E=()=>{const g=prompt("Enter the URL to download");g&&(m.current={id:0,downloadUrl:g},y())};return c.useEffect(()=>{p()},[h,n]),e.jsxs(e.Fragment,{children:[e.jsxs(xe,{isOpen:!0,onClose:t,blockScrollOnMount:!0,children:[e.jsx(q,{}),e.jsxs(je,{width:"90%",maxWidth:"90vw",height:"90vh",children:[e.jsxs(J,{children:[e.jsxs(L,{gap:2,mb:2,alignItems:"center",children:[e.jsx(te,{size:"md",mr:2,children:"Models"}),e.jsx(qe,{setSearchQuery:f}),e.jsx(_,{size:"sm",py:1,mr:8,onClick:E,children:"Custom URL Install"})]}),e.jsxs(L,{gap:2,mb:2,wrap:"wrap",children:[e.jsx(_,{size:"sm",py:1,onClick:()=>{d(void 0)},isActive:n==null,children:"All"}),Qe.map(g=>e.jsx(_,{size:"sm",py:1,isActive:n===g,onClick:()=>{d(g)},children:g}))]}),r&&e.jsx(z,{thickness:"4px",emptyColor:"gray.200",color:"pink.500",size:"lg"})]}),e.jsx(ve,{}),e.jsxs(X,{overflowY:"auto",children:[e.jsx(L,{wrap:"wrap",children:s==null?void 0:s.map(g=>e.jsx(Ke,{model:g,onClickInstallModel:C,installing:i},g.id))}),e.jsx(Xe,{})]})]})]}),e.jsx(Je,{isOpen:v,onClose:x,selectFolder:j})]})}function st(){const[t,s]=c.useState(!1);return e.jsxs(e.Fragment,{children:[e.jsx(_,{size:"sm",colorScheme:"teal",onClick:()=>s(!0),children:"Install Models"}),t&&e.jsx(tt,{onclose:()=>s(!1)})]})}const nt=()=>{const[t,s]=c.useState(["checkpoints"]),[o,r]=c.useState([]),[a,n]=c.useState(!0);c.useEffect(()=>{d(),P.addEventListener("model_list",i=>{u(i.detail)})},[]);const d=async()=>{const i=await Ee();u(i)},u=async i=>{if(!i)return;n(!1);const l=Array.from(new Set(i.map(f=>f.model_type))),h=l.indexOf("checkpoints");h>=0&&l.splice(h,1),l.unshift("checkpoints"),s(l),r(i)};return{modelTypeList:t,modelsList:o,loading:a}};function at({onClose:t}){const[s,o]=c.useState("checkpoints"),{loading:r,modelTypeList:a,modelsList:n}=nt(),[d,u]=c.useState([]);c.useEffect(()=>{const h=n.filter(f=>f.model_type===s);u(h)},[s,n]),c.useEffect(()=>(D.canvasEl.addEventListener("click",t),()=>{D.canvasEl.removeEventListener("click",t)}),[]);const i=440,l=()=>e.jsxs(e.Fragment,{children:[e.jsx(He,{modelTypeList:a,setSelectedModel:o,selectedModel:s}),e.jsx($e,{list:d}),r&&e.jsx(T,{justifyContent:"center",alignItems:"center",height:"100%",children:e.jsx(z,{})})]});return e.jsx(ye,{children:e.jsx(Q,{style:{width:i},children:e.jsxs(Z,{width:i,height:"100vh",p:4,gap:2,position:"fixed",top:0,left:0,shadow:"xl",zIndex:1e3,overflowY:"auto",children:[e.jsx(De,{children:e.jsxs(T,{justifyContent:"space-between",alignContent:"center",children:[e.jsx(te,{size:"md",mr:2,children:"Models"}),e.jsx(st,{})]})}),l()]})})})}we.lazy(()=>_e(()=>import("./InstallMissingModelsButton-H3N_YWfZ.js"),__vite__mapDeps([0,1])));function mt({}){const[t,s]=c.useState(!1),o=async r=>{if(r.dataTransfer.getData("eventName")!=="WorkspaceManagerAddNode")return;const n=r.dataTransfer.getData("modelRelativePath"),d=r.dataTransfer.getData("nodeType"),u=LiteGraph.createNode(d);u.pos=[r.canvasX,r.canvasY],u.configure({widgets_values:[n]}),D.graph.add(u)};return c.useEffect(()=>(D.canvasEl.addEventListener("drop",o),()=>{D.canvasEl.removeEventListener("drop",o)}),[]),e.jsxs(L,{position:"fixed",top:2,right:2,gap:2,children:[e.jsx(_,{size:"sm",colorScheme:"blue","aria-label":"My models",onClick:()=>s(!0),px:1,children:"Models"}),t&&e.jsx(at,{onClose:()=>s(!1)})]})}export{mt as default};
function __vite__mapDeps(indexes) {
  if (!__vite__mapDeps.viteFileDeps) {
    __vite__mapDeps.viteFileDeps = ["workspace_web/InstallMissingModelsButton-H3N_YWfZ.js","workspace_web/input.js"]
  }
  return indexes.map((i) => __vite__mapDeps.viteFileDeps[i])
}