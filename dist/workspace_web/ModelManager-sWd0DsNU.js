import{f as P,j as e,c as b,a as H,u as D,o as W,b as U,d as G,r as o,l as V,H as S,I as Y,B as L,e as w,C as K,g as $,S as q,T as k,h as C,F as O,i as J,k as X,M as Q,m as Z,n as F,p as ee,q as te,s as se,t as ne,v as oe,w as le,x as ae,y as re}from"./input.js";import{api as ie}from"/scripts/api.js";import"/scripts/app.js";var T=P(function(s,a){const{children:n,placeholder:l,className:d,...h}=s;return e.jsxs(b.select,{...h,ref:a,className:H("chakra-select",d),children:[l&&e.jsx("option",{value:"",children:l}),n]})});T.displayName="SelectField";function ce(t,s){const a={},n={};for(const[l,d]of Object.entries(t))s.includes(l)?a[l]=d:n[l]=d;return[a,n]}var B=P((t,s)=>{var a;const n=D("Select",t),{rootProps:l,placeholder:d,icon:h,color:r,height:g,h:p,minH:c,minHeight:m,iconColor:x,iconSize:f,...y}=W(t),[u,i]=ce(y,V),v=U(i),j={width:"100%",height:"fit-content",position:"relative",color:r},M={paddingEnd:"2rem",...n.field,_focus:{zIndex:"unset",...(a=n.field)==null?void 0:a._focus}};return e.jsxs(b.div,{className:"chakra-select__wrapper",__css:j,...u,...l,children:[e.jsx(T,{ref:s,height:p??g,minH:c??m,placeholder:d,...v,__css:M,children:t.children}),e.jsx(N,{"data-disabled":G(v.disabled),...(x||r)&&{color:x||r},__css:n.icon,...f&&{fontSize:f},children:h})]})});B.displayName="Select";var de=t=>e.jsx("svg",{viewBox:"0 0 24 24",...t,children:e.jsx("path",{fill:"currentColor",d:"M16.59 8.59L12 13.17 7.41 8.59 6 10l6 6 6-6z"})}),ue=b("div",{baseStyle:{position:"absolute",display:"inline-flex",alignItems:"center",justifyContent:"center",pointerEvents:"none",top:"50%",transform:"translateY(-50%)"}}),N=t=>{const{children:s=e.jsx(de,{}),...a}=t,n=o.cloneElement(s,{role:"presentation",className:"chakra-select__icon",focusable:!1,"aria-hidden":!0,style:{width:"1em",height:"1em",color:"currentColor"}});return e.jsx(ue,{...a,className:"chakra-select__icon-wrapper",children:o.isValidElement(s)?n:null})};N.displayName="SelectIcon";const I={x:0,y:0};function he({children:t,onDragEnd:s}){const a=o.useRef(I),n=o.useRef(!1),[l,d]=o.useState(I),h=c=>{var m,x,f;if([(m=c.target)==null?void 0:m.id,(f=(x=c.target)==null?void 0:x.parentNode)==null?void 0:f.id].includes("dragPanelIcon")){a.current={x:c.clientX,y:c.clientY},n.current=!0,window.addEventListener("mousemove",r),window.addEventListener("mouseup",g);const y=document.getElementsByTagName("body")[0];y.style.userSelect="none"}},r=o.useCallback(c=>{const m={x:c.clientX-a.current.x,y:c.clientY-a.current.y};d(m)},[]),g=o.useCallback(()=>{d(m=>(s(m),I)),n.current=!1;const c=document.getElementsByTagName("body")[0];c.style.userSelect="auto",window.removeEventListener("mousemove",r),window.removeEventListener("mouseup",g)},[s,r]),p={transform:`translate(${l.x}px, ${l.y}px)`,zIndex:n.current?1e3:1};return e.jsx("div",{style:p,onMouseDown:h,children:t})}const R=o.createContext({setRoute:()=>{}}),_=200;function me({}){const[t,s]=o.useState({top:0,left:0});o.useEffect(()=>{const h=()=>{const r=localStorage.getItem("model_manager_position");if(r!=null){s(JSON.parse(r));return}s({left:window.innerWidth-_,top:0})};return window.addEventListener("resize",h),h(),()=>window.removeEventListener("resize",h)},[]);const[a,n]=o.useState(!1),{setRoute:l}=o.useContext(R),d=o.useCallback(h=>{const{top:r=0,left:g=0}=t||{};let{top:p=0,left:c=600}=h??{};p+=r,c+=g;const m=document.documentElement.clientWidth,x=document.documentElement.clientHeight,f=document.getElementById("modelManagerPanel"),y=(f==null?void 0:f.offsetWidth)||392;p+36>x&&(p=x-36),c+y>=m&&(c=m-y);const u={top:Math.max(0,p),left:Math.max(0,c)};s(u),localStorage.setItem("model_manager_position",JSON.stringify(u))},[t]);return e.jsx(he,{onDragEnd:h=>{d({top:h.y,left:h.x})},children:e.jsxs(S,{width:`${_}px`,style:{padding:2,position:"fixed",...t},justifyContent:"flex-end",alignItems:"center",gap:2,draggable:!1,id:"modelManagerPanel",onMouseEnter:()=>n(!0),onMouseLeave:()=>n(!1),children:[a?e.jsx(Y,{id:"dragPanelIcon",cursor:"move",size:15,color:"#FFF",width:"20px"}):e.jsx(L,{width:"20px"}),e.jsx(w,{size:"sm","aria-label":"models",onClick:()=>l("models"),px:2,children:"Models"})]})})}const pe=async t=>{try{const s=await ie.fetchApi("/model_manager/install_model_stream",{method:"POST",body:JSON.stringify(t)});window.dispatchEvent(new CustomEvent("model_install_message",{detail:"Please check the server for progress logs"}))}catch(s){console.error("Failed to connect to the server:",s)}};function E(t,s=1){var a=t/1048576;return Number(a.toFixed(s))}const z=280;function fe({model:t,onClickInstallModel:s}){var c,m,x,f,y;const a=(f=(x=(m=(c=t.modelVersions)==null?void 0:c.at(0))==null?void 0:m.images)==null?void 0:x.at(0))==null?void 0:f.url,n=t.modelVersions,l=n==null?void 0:n.map(u=>{var i;return(i=u==null?void 0:u.files)==null?void 0:i.at(0)}),[d,h]=o.useState(((y=l==null?void 0:l.at(0))==null?void 0:y.name)??""),r=l==null?void 0:l.find(u=>(u==null?void 0:u.name)===d),g=()=>{window.open(`https://civitai.com/models/${t.id}`)},p=o.useCallback(()=>{if(r==null){console.error("no file is find by name",d);return}s(r,t)},[d]);return e.jsxs(K,{width:z,justifyContent:"space-between",mb:2,gap:1,children:[e.jsx($,{borderRadius:3,boxSize:z+"px",objectFit:"cover",src:a,alt:"model cover image",cursor:"pointer",onClick:()=>g()}),e.jsxs(q,{p:1,children:[e.jsx(k,{label:t.name,children:e.jsx(C,{fontWeight:500,noOfLines:1,children:t.name})}),e.jsxs(O,{justifyContent:"space-between",alignItems:"center",children:[e.jsx(w,{borderRadius:14,noOfLines:1,size:"xs",colorScheme:"teal",maxWidth:"40%",flexShrink:1,variant:"outline",px:1,cursor:"text",children:e.jsx(C,{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",children:t.type})}),e.jsx(w,{leftIcon:e.jsx(J,{size:18}),iconSpacing:1,borderRadius:10,size:"sm",py:1,colorScheme:"teal",type:"submit",onClick:()=>p(),children:"Install"})]}),e.jsxs(S,{children:[e.jsx(B,{size:"md",style:{paddingLeft:4},onChange:u=>{h(u.target.value)},children:l==null?void 0:l.map(u=>{const i=u==null?void 0:u.name;return i?e.jsx("option",{value:i,style:{padding:0},children:i},u.id):null})}),(r==null?void 0:r.sizeKB)&&e.jsx(k,{label:E(r.sizeKB)+"GB",children:e.jsxs(C,{flexShrink:1,noOfLines:1,width:"40%",children:[E(r.sizeKB)," GB"]})})]})]})]})}function xe(){const[t,s]=o.useState(""),a=n=>{const h=n.detail.split(`
`).reverse().find(r=>r.trim()!=="");s(h??"")};return o.useEffect(()=>(window.addEventListener("model_install_message",a),()=>{window.removeEventListener("model_install_message",a)}),[]),e.jsx(S,{children:e.jsx(C,{fontWeight:"500",fontSize:18,py:2,children:t})})}function ge({setSearchQuery:t}){const[s,a]=o.useState("");return e.jsxs(O,{gap:1,alignItems:"center",grow:1,children:[e.jsx(X,{placeholder:"Search models in CivitAI",width:"60%",value:s,onChange:n=>a(n.target.value),onKeyUp:n=>{n.code==="Enter"&&t(s)}}),e.jsx(w,{size:"sm",onClick:()=>t(s),colorScheme:"teal",children:"Search"})]})}const ye=["Checkpoint","TextualInversion","Hypernetwork","LORA","Controlnet","Upscaler","VAE"],je={Checkpoint:"checkpoints",TextualInversion:"embeddings",Hypernetwork:"hypernetworks",LORA:"loras",Controlnet:"controlnet",Upscaler:"upscale_models",VAE:"vae"};function Se({onclose:t}){const[s,a]=o.useState([]),[n,l]=o.useState(!1),[d,h]=o.useState([]),[r,g]=o.useState(!1),[p,c]=o.useState("Checkpoint"),[m,x]=o.useState(""),f=o.useCallback(async()=>{g(!0);const i={limit:"30",nsfw:"false",types:p};m!==""&&(i.query=m);const j=`https://civitai.com/api/v1/models?${new URLSearchParams(i).toString()}`,A=await(await fetch(j)).json();h(A.items),g(!1)},[m,p]),y=(i,v)=>{if(i.downloadUrl==null||i.name==null){console.error("file.downloadUrl or file.name is null");return}let j=je[v.type];j==null&&(j=prompt("What's the folder path under /ComfyUI/models you want to save the model? ")),j!=null&&pe({filename:i.name,name:i.name,save_path:j,url:i.downloadUrl})};o.useEffect(()=>{console.log("searchQuery",m),f()},[m,p]);const u=d.length>0&&s.length===d.length;return e.jsxs(Q,{isOpen:!0,onClose:t,blockScrollOnMount:!0,children:[e.jsx(Z,{}),e.jsxs(F,{width:"90%",maxWidth:"90vw",height:"90vh",children:[e.jsxs(ee,{children:[e.jsxs(S,{gap:2,mb:2,alignItems:"center",children:[e.jsx(te,{size:"md",mr:2,children:"Models"}),e.jsx(ge,{setSearchQuery:x})]}),e.jsx(xe,{}),e.jsxs(S,{gap:2,mb:2,wrap:"wrap",children:[e.jsx(w,{size:"sm",py:1,onClick:()=>{c(void 0)},isActive:p==null,children:"All"}),ye.map(i=>e.jsx(w,{size:"sm",py:1,isActive:p===i,onClick:()=>{c(i)},children:i}))]}),n&&e.jsxs(S,{gap:3,children:[e.jsx(se,{isChecked:u,children:"All"}),e.jsxs(C,{fontSize:16,children:[s.length," Selected"]}),e.jsx(ne,{size:"sm",icon:e.jsx(oe,{size:19}),onClick:()=>l(!1),"aria-label":"cancel"})]})]}),e.jsx(le,{}),e.jsxs(ae,{overflowY:"auto",children:[r&&e.jsx(re,{thickness:"4px",emptyColor:"gray.200",color:"pink.500",size:"lg"}),e.jsx(S,{wrap:"wrap",children:d==null?void 0:d.map(i=>e.jsx(fe,{model:i,onClickInstallModel:y},i.id))})]})]})]})}function Ie(){const[t,s]=o.useState("root");return e.jsx(R.Provider,{value:{setRoute:s},children:e.jsxs(L,{style:{width:"100vh",position:"absolute",top:0,left:0,right:0},zIndex:1e3,draggable:!1,children:[e.jsx(me,{}),t==="models"&&e.jsx(Se,{onclose:()=>s("root")})]})})}export{Ie as default};
