import{f as N,j as e,c as b,a as U,u as G,o as K,b as $,d as V,r as l,l as Y,H as S,I as q,B as T,e as I,C as J,g as X,S as F,T as B,h as _,F as O,i as Q,k as Z,M as ee,m as te,n as ne,p as se,q as oe,s as le,t as ae,v as re,w as ie,x as ce,y as de}from"./input.js";import{api as ue}from"/scripts/api.js";import{u as he}from"./chunk-6RSEZNRH-VBwaogZp.js";import"/scripts/app.js";var R=N(function(n,a){const{children:s,placeholder:r,className:o,...i}=n;return e.jsxs(b.select,{...i,ref:a,className:U("chakra-select",o),children:[r&&e.jsx("option",{value:"",children:r}),s]})});R.displayName="SelectField";function me(t,n){const a={},s={};for(const[r,o]of Object.entries(t))n.includes(r)?a[r]=o:s[r]=o;return[a,s]}var A=N((t,n)=>{var a;const s=G("Select",t),{rootProps:r,placeholder:o,icon:i,color:u,height:m,h:p,minH:c,minHeight:x,iconColor:y,iconSize:f,...g}=K(t),[w,h]=me(g,Y),j=$(h),C={width:"100%",height:"fit-content",position:"relative",color:u},d={paddingEnd:"2rem",...s.field,_focus:{zIndex:"unset",...(a=s.field)==null?void 0:a._focus}};return e.jsxs(b.div,{className:"chakra-select__wrapper",__css:C,...w,...r,children:[e.jsx(R,{ref:n,height:p??m,minH:c??x,placeholder:o,...j,__css:d,children:t.children}),e.jsx(H,{"data-disabled":V(j.disabled),...(y||u)&&{color:y||u},__css:s.icon,...f&&{fontSize:f},children:i})]})});A.displayName="Select";var pe=t=>e.jsx("svg",{viewBox:"0 0 24 24",...t,children:e.jsx("path",{fill:"currentColor",d:"M16.59 8.59L12 13.17 7.41 8.59 6 10l6 6 6-6z"})}),xe=b("div",{baseStyle:{position:"absolute",display:"inline-flex",alignItems:"center",justifyContent:"center",pointerEvents:"none",top:"50%",transform:"translateY(-50%)"}}),H=t=>{const{children:n=e.jsx(pe,{}),...a}=t,s=l.cloneElement(n,{role:"presentation",className:"chakra-select__icon",focusable:!1,"aria-hidden":!0,style:{width:"1em",height:"1em",color:"currentColor"}});return e.jsx(xe,{...a,className:"chakra-select__icon-wrapper",children:l.isValidElement(n)?s:null})};H.displayName="SelectIcon";const M={x:0,y:0};function fe({children:t,onDragEnd:n}){const a=l.useRef(M),s=l.useRef(!1),[r,o]=l.useState(M),i=c=>{var x,y,f;if([(x=c.target)==null?void 0:x.id,(f=(y=c.target)==null?void 0:y.parentNode)==null?void 0:f.id].includes("dragPanelIcon")){a.current={x:c.clientX,y:c.clientY},s.current=!0,window.addEventListener("mousemove",u),window.addEventListener("mouseup",m);const g=document.getElementsByTagName("body")[0];g.style.userSelect="none"}},u=l.useCallback(c=>{const x={x:c.clientX-a.current.x,y:c.clientY-a.current.y};o(x)},[]),m=l.useCallback(()=>{o(x=>(n(x),M)),s.current=!1;const c=document.getElementsByTagName("body")[0];c.style.userSelect="auto",window.removeEventListener("mousemove",u),window.removeEventListener("mouseup",m)},[n,u]),p={transform:`translate(${r.x}px, ${r.y}px)`,zIndex:s.current?1e3:1};return e.jsx("div",{style:p,onMouseDown:i,children:t})}const D=l.createContext({setRoute:()=>{}}),z=200;function ge({}){const[t,n]=l.useState({top:0,left:0});l.useEffect(()=>{const i=()=>{const u=localStorage.getItem("model_manager_position");if(u!=null){n(JSON.parse(u));return}n({left:window.innerWidth-z,top:0})};return window.addEventListener("resize",i),i(),()=>window.removeEventListener("resize",i)},[]);const[a,s]=l.useState(!1),{setRoute:r}=l.useContext(D),o=l.useCallback(i=>{const{top:u=0,left:m=0}=t||{};let{top:p=0,left:c=600}=i??{};p+=u,c+=m;const x=document.documentElement.clientWidth,y=document.documentElement.clientHeight,f=document.getElementById("modelManagerPanel"),g=(f==null?void 0:f.offsetWidth)||392;p+36>y&&(p=y-36),c+g>=x&&(c=x-g);const w={top:Math.max(0,p),left:Math.max(0,c)};n(w),localStorage.setItem("model_manager_position",JSON.stringify(w))},[t]);return e.jsx(fe,{onDragEnd:i=>{o({top:i.y,left:i.x})},children:e.jsxs(S,{width:`${z}px`,style:{padding:2,position:"fixed",...t},justifyContent:"flex-end",alignItems:"center",gap:2,draggable:!1,id:"modelManagerPanel",onMouseEnter:()=>s(!0),onMouseLeave:()=>s(!1),children:[a?e.jsx(q,{id:"dragPanelIcon",cursor:"move",size:15,color:"#FFF",width:"20px"}):e.jsx(T,{width:"20px"}),e.jsx(I,{size:"sm","aria-label":"models",onClick:()=>r("models"),px:2,children:"Models"})]})})}const ye=async t=>{window.dispatchEvent(new CustomEvent("model_install_message",{detail:`Installing model ${t.filename} to ${t.save_path}, check progress in the server console.`}));try{const a=await(await ue.fetchApi("/model_manager/install_model",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})).text();window.dispatchEvent(new CustomEvent("model_install_message",{detail:a}))}catch(n){console.error("Failed to connect to the server:",n)}};function L(t,n=1){const r=t/1024;return r>=1024?(r/1024).toFixed(n)+" GB":r.toFixed(n)+" MB"}const P=280;function je({model:t,onClickInstallModel:n,installing:a}){var x,y,f,g,w;const s=(g=(f=(y=(x=t.modelVersions)==null?void 0:x.at(0))==null?void 0:y.images)==null?void 0:f.at(0))==null?void 0:g.url,r=t.modelVersions,o=r==null?void 0:r.map(h=>{var j;return(j=h==null?void 0:h.files)==null?void 0:j.at(0)}),[i,u]=l.useState(((w=o==null?void 0:o.at(0))==null?void 0:w.name)??""),m=o==null?void 0:o.find(h=>(h==null?void 0:h.name)===i),p=()=>{window.open(`https://civitai.com/models/${t.id}`)},c=l.useCallback(()=>{if(m==null){console.error("no file is find by name",i);return}n(m,t)},[i]);return e.jsxs(J,{width:P,justifyContent:"space-between",mb:2,gap:1,children:[e.jsx(X,{borderRadius:3,boxSize:P+"px",objectFit:"cover",src:s,alt:"model cover image",cursor:"pointer",onClick:()=>p()}),e.jsxs(F,{p:1,children:[e.jsx(B,{label:t.name,children:e.jsx(_,{fontWeight:500,noOfLines:1,children:t.name})}),e.jsxs(O,{justifyContent:"space-between",alignItems:"center",children:[e.jsx(I,{borderRadius:14,noOfLines:1,size:"xs",colorScheme:"teal",maxWidth:"40%",flexShrink:1,variant:"outline",px:1,cursor:"text",children:e.jsx(_,{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",children:t.type})}),e.jsx(I,{leftIcon:e.jsx(Q,{size:18}),iconSpacing:1,borderRadius:10,size:"sm",py:1,colorScheme:"teal",type:"submit",onClick:()=>c(),isDisabled:!!(i&&a.includes(i)),children:"Install"})]}),e.jsxs(S,{children:[e.jsx(A,{size:"md",style:{paddingLeft:4},onChange:h=>{u(h.target.value)},children:o==null?void 0:o.map(h=>{const j=h==null?void 0:h.name;return j?e.jsx("option",{value:j,style:{padding:0},children:j},h.id):null})}),(m==null?void 0:m.sizeKB)&&e.jsx(B,{label:L(m.sizeKB),children:e.jsx(_,{flexShrink:1,noOfLines:1,width:"40%",children:L(m.sizeKB)})})]})]})]})}function we(){const[t,n]=l.useState(""),a=s=>{const i=s.detail.split(`
`).reverse().find(u=>u.trim()!=="");n(i??"")};return l.useEffect(()=>(window.addEventListener("model_install_message",a),()=>{window.removeEventListener("model_install_message",a)}),[]),e.jsx(S,{children:e.jsx(_,{fontWeight:"500",fontSize:18,py:2,children:t})})}function Se({setSearchQuery:t}){const[n,a]=l.useState("");return e.jsxs(O,{gap:1,alignItems:"center",grow:1,children:[e.jsx(Z,{placeholder:"Search models in CivitAI",width:"60%",value:n,onChange:s=>a(s.target.value),onKeyUp:s=>{s.code==="Enter"&&t(n)}}),e.jsx(I,{size:"sm",onClick:()=>t(n),colorScheme:"teal",children:"Search"})]})}const ve=["Checkpoint","TextualInversion","Hypernetwork","LORA","Controlnet","Upscaler","VAE"],Ie={Checkpoint:"checkpoints",TextualInversion:"embeddings",Hypernetwork:"hypernetworks",LORA:"loras",Controlnet:"controlnet",Upscaler:"upscale_models",VAE:"vae"};function _e({onclose:t}){const[n,a]=l.useState([]),[s,r]=l.useState(!1),[o,i]=l.useState([]),[u,m]=l.useState(!1),[p,c]=l.useState("Checkpoint"),x=he(),[y,f]=l.useState([]),[g,w]=l.useState(""),h=l.useCallback(async()=>{m(!0);const d={limit:"30",nsfw:"false",types:p};g!==""&&(d.query=g);const v=`https://civitai.com/api/v1/models?${new URLSearchParams(d).toString()}`,W=await(await fetch(v)).json();i(W.items),m(!1)},[g,p]),j=(d,k)=>{if(d.downloadUrl==null||d.name==null){console.error("file.downloadUrl or file.name is null");return}let v=Ie[k.type];v==null&&(v=prompt("What's the folder path under /ComfyUI/models you want to save the model? ")),v!=null&&(x({title:"Installing...Please check the progress in your python server console",description:d.name,status:"info",duration:4e3,isClosable:!0}),d.name!=null&&f(E=>[...E,d.name??""]),ye({filename:d.name,name:d.name,save_path:v,url:d.downloadUrl}))};l.useEffect(()=>{h()},[g,p]);const C=o.length>0&&n.length===o.length;return e.jsxs(ee,{isOpen:!0,onClose:t,blockScrollOnMount:!0,children:[e.jsx(te,{}),e.jsxs(ne,{width:"90%",maxWidth:"90vw",height:"90vh",children:[e.jsxs(se,{children:[e.jsxs(S,{gap:2,mb:2,alignItems:"center",children:[e.jsx(oe,{size:"md",mr:2,children:"Models"}),e.jsx(Se,{setSearchQuery:w})]}),e.jsx(we,{}),e.jsxs(S,{gap:2,mb:2,wrap:"wrap",children:[e.jsx(I,{size:"sm",py:1,onClick:()=>{c(void 0)},isActive:p==null,children:"All"}),ve.map(d=>e.jsx(I,{size:"sm",py:1,isActive:p===d,onClick:()=>{c(d)},children:d}))]}),s&&e.jsxs(S,{gap:3,children:[e.jsx(le,{isChecked:C,children:"All"}),e.jsxs(_,{fontSize:16,children:[n.length," Selected"]}),e.jsx(ae,{size:"sm",icon:e.jsx(re,{size:19}),onClick:()=>r(!1),"aria-label":"cancel"})]})]}),e.jsx(ie,{}),e.jsxs(ce,{overflowY:"auto",children:[u&&e.jsx(de,{thickness:"4px",emptyColor:"gray.200",color:"pink.500",size:"lg"}),e.jsx(S,{wrap:"wrap",children:o==null?void 0:o.map(d=>e.jsx(je,{model:d,onClickInstallModel:j,installing:y},d.id))})]})]})]})}function Ee(){const[t,n]=l.useState("root");return e.jsx(D.Provider,{value:{setRoute:n},children:e.jsxs(T,{style:{width:"100vh",position:"absolute",top:0,left:0,right:0},zIndex:1e3,draggable:!1,children:[e.jsx(ge,{}),t==="models"&&e.jsx(_e,{onclose:()=>n("root")})]})})}export{Ee as default};
