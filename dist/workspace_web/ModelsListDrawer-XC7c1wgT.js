import{f as Y,r as g,j as n,g as G,e as Me,a4 as J,b as $e,o as Ve,k as Ue,h as A,a9 as re,af as He,N as _e,ag as Ye,Q as be,S as Ce,T as qe,Z as Qe,M as Je,O as Xe,R as Ze,P as et}from"./input.js";import{at as tt,ao as st,au as H,o as $,B as ie,F as B,l as D,m as oe,av as ke,aw as me,ad as Ie,k as X,z as nt,H as R,n as Z,ax as Le,j as Ee,ay as it,az as Ae,a0 as ot,a1 as rt,a2 as at,a3 as lt,a4 as ct,aA as Te,aB as te,an as Ne,aC as dt,aD as ht,ae as ut}from"./App-VDFuO2jE.js";import{I as De,G as ft,C as mt}from"./chunk-JARCRF6W-MhzYgnSi.js";import{app as U}from"/scripts/app.js";import{api as Q}from"/scripts/api.js";import{S as ee}from"./chunk-3RSXBRAN-_hUGXHpc.js";var Fe=Y(function(e,s){const{spacing:i="0.5rem",spacingX:r,spacingY:o,children:a,justify:c,direction:l,align:d,className:h,shouldWrapChildren:f,...u}=e,p=g.useMemo(()=>f?g.Children.map(a,(m,x)=>n.jsx(ae,{children:m},x)):a,[a,f]);return n.jsx(G.div,{ref:s,className:Me("chakra-wrap",h),...u,children:n.jsx(G.ul,{className:"chakra-wrap__list",__css:{display:"flex",flexWrap:"wrap",justifyContent:c,alignItems:d,flexDirection:l,listStyleType:"none",gap:i,columnGap:r,rowGap:o,padding:"0"},children:p})})});Fe.displayName="Wrap";var ae=Y(function(e,s){const{className:i,...r}=e;return n.jsx(G.li,{ref:s,__css:{display:"flex",alignItems:"flex-start"},className:Me("chakra-wrap__listitem",i),...r})});ae.displayName="WrapItem";function pe(t){return st(t,e=>e==="auto"?"auto":`span ${e}/span ${e}`)}var Pe=Y(function(e,s){const{area:i,colSpan:r,colStart:o,colEnd:a,rowEnd:c,rowSpan:l,rowStart:d,...h}=e,f=tt({gridArea:i,gridColumn:pe(r),gridRow:pe(l),gridColumnStart:o,gridColumnEnd:a,gridRowStart:d,gridRowEnd:c});return n.jsx(G.div,{ref:s,__css:f,...h})});Pe.displayName="GridItem";function pt(t,e,s){return(t-e)*100/(s-e)}J({"0%":{strokeDasharray:"1, 400",strokeDashoffset:"0"},"50%":{strokeDasharray:"400, 400",strokeDashoffset:"-100"},"100%":{strokeDasharray:"400, 400",strokeDashoffset:"-260"}});J({"0%":{transform:"rotate(0deg)"},"100%":{transform:"rotate(360deg)"}});var gt=J({"0%":{left:"-40%"},"100%":{left:"100%"}}),xt=J({from:{backgroundPosition:"1rem 0"},to:{backgroundPosition:"0 0"}});function yt(t){const{value:e=0,min:s,max:i,valueText:r,getValueText:o,isIndeterminate:a,role:c="progressbar"}=t,l=pt(e,s,i);return{bind:{"data-indeterminate":a?"":void 0,"aria-valuemax":i,"aria-valuemin":s,"aria-valuenow":a?void 0:e,"aria-valuetext":(()=>{if(e!=null)return typeof o=="function"?o(e,l):r})(),role:c},percent:l,value:e}}var[wt,vt]=$e({name:"ProgressStylesContext",errorMessage:`useProgressStyles returned is 'undefined'. Seems you forgot to wrap the components in "<Progress />" `}),jt=Y((t,e)=>{const{min:s,max:i,value:r,isIndeterminate:o,role:a,...c}=t,l=yt({value:r,min:s,max:i,isIndeterminate:o,role:a}),h={height:"100%",...vt().filledTrack};return n.jsx(G.div,{ref:e,style:{width:`${l.percent}%`,...c.style},...l.bind,...c,__css:h})}),Oe=Y((t,e)=>{var s;const{value:i,min:r=0,max:o=100,hasStripe:a,isAnimated:c,children:l,borderRadius:d,isIndeterminate:h,"aria-label":f,"aria-labelledby":u,"aria-valuetext":p,title:m,role:x,...y}=Ve(t),j=Ue("Progress",t),C=d??((s=j.track)==null?void 0:s.borderRadius),b={animation:`${xt} 1s linear infinite`},F={...!h&&a&&c&&b,...h&&{position:"absolute",willChange:"left",minWidth:"50%",animation:`${gt} 1s ease infinite normal none running`}},k={overflow:"hidden",position:"relative",...j.track};return n.jsx(G.div,{ref:e,borderRadius:C,__css:k,...y,children:n.jsxs(wt,{value:j,children:[n.jsx(jt,{"aria-label":f,"aria-labelledby":u,"aria-valuetext":p,min:r,max:o,value:i,isIndeterminate:h,css:F,borderRadius:C,title:m,role:x}),l]})})});Oe.displayName="Progress";function W(t){return Array.isArray?Array.isArray(t):Be(t)==="[object Array]"}const St=1/0;function Mt(t){return t==null?"":function(e){if(typeof e=="string")return e;let s=e+"";return s=="0"&&1/e==-St?"-0":s}(t)}function P(t){return typeof t=="string"}function ze(t){return typeof t=="number"}function _t(t){return t===!0||t===!1||function(e){return function(s){return typeof s=="object"}(e)&&e!==null}(t)&&Be(t)=="[object Boolean]"}function N(t){return t!=null}function se(t){return!t.trim().length}function Be(t){return t==null?t===void 0?"[object Undefined]":"[object Null]":Object.prototype.toString.call(t)}const bt=t=>`Missing ${t} property in key`,Ct=t=>`Property 'weight' in key '${t}' must be a positive integer`,ge=Object.prototype.hasOwnProperty;class kt{constructor(e){this._keys=[],this._keyMap={};let s=0;e.forEach(i=>{let r=Re(i);this._keys.push(r),this._keyMap[r.id]=r,s+=r.weight}),this._keys.forEach(i=>{i.weight/=s})}get(e){return this._keyMap[e]}keys(){return this._keys}toJSON(){return JSON.stringify(this._keys)}}function Re(t){let e=null,s=null,i=null,r=1,o=null;if(P(t)||W(t))i=t,e=xe(t),s=ye(t);else{if(!ge.call(t,"name"))throw new Error(bt("name"));const a=t.name;if(i=a,ge.call(t,"weight")&&(r=t.weight,r<=0))throw new Error(Ct(a));e=xe(a),s=ye(a),o=t.getFn}return{path:e,id:s,weight:r,src:i,getFn:o}}function xe(t){return W(t)?t:t.split(".")}function ye(t){return W(t)?t.join("."):t}var S={isCaseSensitive:!1,includeScore:!1,keys:[],shouldSort:!0,sortFn:(t,e)=>t.score===e.score?t.idx<e.idx?-1:1:t.score<e.score?-1:1,includeMatches:!1,findAllMatches:!1,minMatchCharLength:1,location:0,threshold:.6,distance:100,useExtendedSearch:!1,getFn:function(t,e){let s=[],i=!1;const r=(o,a,c)=>{if(N(o))if(a[c]){const l=o[a[c]];if(!N(l))return;if(c===a.length-1&&(P(l)||ze(l)||_t(l)))s.push(Mt(l));else if(W(l)){i=!0;for(let d=0,h=l.length;d<h;d+=1)r(l[d],a,c+1)}else a.length&&r(l,a,c+1)}else s.push(o)};return r(t,P(e)?e.split("."):e,0),i?s:s[0]},ignoreLocation:!1,ignoreFieldNorm:!1,fieldNormWeight:1};const It=/[^ ]+/g;class le{constructor({getFn:e=S.getFn,fieldNormWeight:s=S.fieldNormWeight}={}){this.norm=function(i=1,r=3){const o=new Map,a=Math.pow(10,r);return{get(c){const l=c.match(It).length;if(o.has(l))return o.get(l);const d=1/Math.pow(l,.5*i),h=parseFloat(Math.round(d*a)/a);return o.set(l,h),h},clear(){o.clear()}}}(s,3),this.getFn=e,this.isCreated=!1,this.setIndexRecords()}setSources(e=[]){this.docs=e}setIndexRecords(e=[]){this.records=e}setKeys(e=[]){this.keys=e,this._keysMap={},e.forEach((s,i)=>{this._keysMap[s.id]=i})}create(){!this.isCreated&&this.docs.length&&(this.isCreated=!0,P(this.docs[0])?this.docs.forEach((e,s)=>{this._addString(e,s)}):this.docs.forEach((e,s)=>{this._addObject(e,s)}),this.norm.clear())}add(e){const s=this.size();P(e)?this._addString(e,s):this._addObject(e,s)}removeAt(e){this.records.splice(e,1);for(let s=e,i=this.size();s<i;s+=1)this.records[s].i-=1}getValueForItemAtKeyId(e,s){return e[this._keysMap[s]]}size(){return this.records.length}_addString(e,s){if(!N(e)||se(e))return;let i={v:e,i:s,n:this.norm.get(e)};this.records.push(i)}_addObject(e,s){let i={i:s,$:{}};this.keys.forEach((r,o)=>{let a=r.getFn?r.getFn(e):this.getFn(e,r.path);if(N(a)){if(W(a)){let c=[];const l=[{nestedArrIndex:-1,value:a}];for(;l.length;){const{nestedArrIndex:d,value:h}=l.pop();if(N(h))if(P(h)&&!se(h)){let f={v:h,i:d,n:this.norm.get(h)};c.push(f)}else W(h)&&h.forEach((f,u)=>{l.push({nestedArrIndex:u,value:f})})}i.$[o]=c}else if(P(a)&&!se(a)){let c={v:a,n:this.norm.get(a)};i.$[o]=c}}}),this.records.push(i)}toJSON(){return{keys:this.keys,records:this.records}}}function We(t,e,{getFn:s=S.getFn,fieldNormWeight:i=S.fieldNormWeight}={}){const r=new le({getFn:s,fieldNormWeight:i});return r.setKeys(t.map(Re)),r.setSources(e),r.create(),r}function q(t,{errors:e=0,currentLocation:s=0,expectedLocation:i=0,distance:r=S.distance,ignoreLocation:o=S.ignoreLocation}={}){const a=e/t.length;if(o)return a;const c=Math.abs(i-s);return r?a+c/r:c?1:a}const z=32;function Lt(t,e,s,{location:i=S.location,distance:r=S.distance,threshold:o=S.threshold,findAllMatches:a=S.findAllMatches,minMatchCharLength:c=S.minMatchCharLength,includeMatches:l=S.includeMatches,ignoreLocation:d=S.ignoreLocation}={}){if(e.length>z)throw new Error(`Pattern length exceeds max of ${z}.`);const h=e.length,f=t.length,u=Math.max(0,Math.min(i,f));let p=o,m=u;const x=c>1||l,y=x?Array(f):[];let j;for(;(j=t.indexOf(e,m))>-1;){let k=q(e,{currentLocation:j,expectedLocation:u,distance:r,ignoreLocation:d});if(p=Math.min(k,p),m=j+h,x){let I=0;for(;I<h;)y[j+I]=1,I+=1}}m=-1;let C=[],b=1,T=h+f;const K=1<<h-1;for(let k=0;k<h;k+=1){let I=0,L=T;for(;I<L;)q(e,{errors:k,currentLocation:u+L,expectedLocation:u,distance:r,ignoreLocation:d})<=p?I=L:T=L,L=Math.floor((T-I)/2+I);T=L;let O=Math.max(1,u-L+1),E=a?f:Math.min(u+L,f)+h,w=Array(E+2);w[E+1]=(1<<k)-1;for(let v=E;v>=O;v-=1){let M=v-1,_=s[t.charAt(M)];if(x&&(y[M]=+!!_),w[v]=(w[v+1]<<1|1)&_,k&&(w[v]|=(C[v+1]|C[v])<<1|1|C[v+1]),w[v]&K&&(b=q(e,{errors:k,currentLocation:M,expectedLocation:u,distance:r,ignoreLocation:d}),b<=p)){if(p=b,m=M,m<=u)break;O=Math.max(1,2*u-m)}}if(q(e,{errors:k+1,currentLocation:u,expectedLocation:u,distance:r,ignoreLocation:d})>p)break;C=w}const F={isMatch:m>=0,score:Math.max(.001,b)};if(x){const k=function(I=[],L=S.minMatchCharLength){let O=[],E=-1,w=-1,v=0;for(let M=I.length;v<M;v+=1){let _=I[v];_&&E===-1?E=v:_||E===-1||(w=v-1,w-E+1>=L&&O.push([E,w]),E=-1)}return I[v-1]&&v-E>=L&&O.push([E,v-1]),O}(y,c);k.length?l&&(F.indices=k):F.isMatch=!1}return F}function Et(t){let e={};for(let s=0,i=t.length;s<i;s+=1){const r=t.charAt(s);e[r]=(e[r]||0)|1<<i-s-1}return e}class At{constructor(e,{location:s=S.location,threshold:i=S.threshold,distance:r=S.distance,includeMatches:o=S.includeMatches,findAllMatches:a=S.findAllMatches,minMatchCharLength:c=S.minMatchCharLength,isCaseSensitive:l=S.isCaseSensitive,ignoreLocation:d=S.ignoreLocation}={}){if(this.options={location:s,threshold:i,distance:r,includeMatches:o,findAllMatches:a,minMatchCharLength:c,isCaseSensitive:l,ignoreLocation:d},this.pattern=l?e:e.toLowerCase(),this.chunks=[],!this.pattern.length)return;const h=(u,p)=>{this.chunks.push({pattern:u,alphabet:Et(u),startIndex:p})},f=this.pattern.length;if(f>z){let u=0;const p=f%z,m=f-p;for(;u<m;)h(this.pattern.substr(u,z),u),u+=z;if(p){const x=f-z;h(this.pattern.substr(x),x)}}else h(this.pattern,0)}searchIn(e){const{isCaseSensitive:s,includeMatches:i}=this.options;if(s||(e=e.toLowerCase()),this.pattern===e){let m={isMatch:!0,score:0};return i&&(m.indices=[[0,e.length-1]]),m}const{location:r,distance:o,threshold:a,findAllMatches:c,minMatchCharLength:l,ignoreLocation:d}=this.options;let h=[],f=0,u=!1;this.chunks.forEach(({pattern:m,alphabet:x,startIndex:y})=>{const{isMatch:j,score:C,indices:b}=Lt(e,m,x,{location:r+y,distance:o,threshold:a,findAllMatches:c,minMatchCharLength:l,includeMatches:i,ignoreLocation:d});j&&(u=!0),f+=C,j&&b&&(h=[...h,...b])});let p={isMatch:u,score:u?f/this.chunks.length:1};return u&&i&&(p.indices=h),p}}const we=[];function ve(t,e){for(let s=0,i=we.length;s<i;s+=1){let r=we[s];if(r.condition(t,e))return new r(t,e)}return new At(t,e)}function Tt(t,e){const s=t.matches;e.matches=[],N(s)&&s.forEach(i=>{if(!N(i.indices)||!i.indices.length)return;const{indices:r,value:o}=i;let a={indices:r,value:o};i.key&&(a.key=i.key.src),i.idx>-1&&(a.refIndex=i.idx),e.matches.push(a)})}function Nt(t,e){e.score=t.score}class V{constructor(e,s={},i){if(this.options={...S,...s},this.options.useExtendedSearch)throw new Error("Extended search is not available");this._keyStore=new kt(this.options.keys),this.setCollection(e,i)}setCollection(e,s){if(this._docs=e,s&&!(s instanceof le))throw new Error("Incorrect 'index' type");this._myIndex=s||We(this.options.keys,this._docs,{getFn:this.options.getFn,fieldNormWeight:this.options.fieldNormWeight})}add(e){N(e)&&(this._docs.push(e),this._myIndex.add(e))}remove(e=()=>!1){const s=[];for(let i=0,r=this._docs.length;i<r;i+=1){const o=this._docs[i];e(o,i)&&(this.removeAt(i),i-=1,r-=1,s.push(o))}return s}removeAt(e){this._docs.splice(e,1),this._myIndex.removeAt(e)}getIndex(){return this._myIndex}search(e,{limit:s=-1}={}){const{includeMatches:i,includeScore:r,shouldSort:o,sortFn:a,ignoreFieldNorm:c}=this.options;let l=P(e)?P(this._docs[0])?this._searchStringList(e):this._searchObjectList(e):this._searchLogical(e);return function(d,{ignoreFieldNorm:h=S.ignoreFieldNorm}){d.forEach(f=>{let u=1;f.matches.forEach(({key:p,norm:m,score:x})=>{const y=p?p.weight:null;u*=Math.pow(x===0&&y?Number.EPSILON:x,(y||1)*(h?1:m))}),f.score=u})}(l,{ignoreFieldNorm:c}),o&&l.sort(a),ze(s)&&s>-1&&(l=l.slice(0,s)),function(d,h,{includeMatches:f=S.includeMatches,includeScore:u=S.includeScore}={}){const p=[];return f&&p.push(Tt),u&&p.push(Nt),d.map(m=>{const{idx:x}=m,y={item:h[x],refIndex:x};return p.length&&p.forEach(j=>{j(m,y)}),y})}(l,this._docs,{includeMatches:i,includeScore:r})}_searchStringList(e){const s=ve(e,this.options),{records:i}=this._myIndex,r=[];return i.forEach(({v:o,i:a,n:c})=>{if(!N(o))return;const{isMatch:l,score:d,indices:h}=s.searchIn(o);l&&r.push({item:o,idx:a,matches:[{score:d,value:o,norm:c,indices:h}]})}),r}_searchLogical(e){throw new Error("Logical search is not available")}_searchObjectList(e){const s=ve(e,this.options),{keys:i,records:r}=this._myIndex,o=[];return r.forEach(({$:a,i:c})=>{if(!N(a))return;let l=[];i.forEach((d,h)=>{l.push(...this._findMatches({key:d,value:a[h],searcher:s}))}),l.length&&o.push({idx:c,item:a,matches:l})}),o}_findMatches({key:e,value:s,searcher:i}){if(!N(s))return[];let r=[];if(W(s))s.forEach(({v:o,i:a,n:c})=>{if(!N(o))return;const{isMatch:l,score:d,indices:h}=i.searchIn(o);l&&r.push({score:d,key:e,value:o,idx:a,norm:c,indices:h})});else{const{v:o,n:a}=s,{isMatch:c,score:l,indices:d}=i.searchIn(o);c&&r.push({score:l,key:e,value:o,norm:a,indices:d})}return r}}V.version="7.0.0",V.createIndex=We,V.parseIndex=function(t,{getFn:e=S.getFn,fieldNormWeight:s=S.fieldNormWeight}={}){const{keys:i,records:r}=t,o=new le({getFn:e,fieldNormWeight:s});return o.setKeys(i),o.setIndexRecords(r),o},V.config=S;function Dt({selectedModel:t,setSelectedModel:e,modelTypeList:s}){const i=r=>{e(r)};return n.jsx(Fe,{children:s.map(r=>n.jsx(ae,{children:n.jsx(A,{colorScheme:"blue",variant:t===r?"solid":"outline",onClick:()=>i(r),size:"sm",children:r})},r))})}const Ft={checkpoints:"CheckpointLoaderSimple",vae:"VAELoader",loras:"LoraLoader",controlnet:"ControlNetLoader",upscale_models:"UpscaleModelLoader"};function Pt({data:t}){const[e,s]=g.useState("https://image.civitai.com/xG1nkqKTMzGDvpLrqFT7WA/27fd7433-cb0a-4a87-88c1-21ccb2b1a842/width=450/00060-881622046.jpeg"),[i,r]=g.useState(!t.file_hash),[o,a]=g.useState();g.useEffect(()=>{r(!t.file_hash),c()},[t.file_hash]);const c=async()=>{var h,f,u,p;const d=await H.models.get(t.model_name+"@"+t.model_type);if(d!=null&&(a(d),(h=d.imageUrl)!=null&&h.length&&s(d.imageUrl)),t.file_hash!=null)try{const m=`https://civitai.com/api/v1/model-versions/by-hash/${t.file_hash}`,y=await(await fetch(m)).json();let j;if(await((f=$)==null?void 0:f.getSetting("showNsfwModelThumbnail"))===!0)j=(p=(u=y==null?void 0:y.images)==null?void 0:u[0])==null?void 0:p.url;else if(!y.model.nsfw){const T=y.images.find(K=>K.nsfw==="None");j=T==null?void 0:T.url}j&&s(j);const b={id:t.model_name+"@"+t.model_type,fileHash:t.file_hash,fileFolder:t.model_type,fileName:t.model_name+t.model_extension,modelName:y.model.name,civitModelID:String(y.modelId),civitModelVersionID:String(y.id),imageUrl:j??null};H.models.put(b),a(b)}catch{}t.preview&&s(t.preview)},l=d=>{const h=Ft[t.model_type];h&&(d.dataTransfer.setData("eventName","WorkspaceManagerAddNode"),d.dataTransfer.setData("modelRelativePath",t.model_name+t.model_extension),d.dataTransfer.setData("nodeType",h))};return n.jsxs(ie,{children:[n.jsxs(ie,{position:"relative",borderRadius:4,draggable:!0,onDragStart:l,children:[i?n.jsx(B,{bg:"rgba(0, 0, 0, 0.5)",height:178,justifyContent:"center",alignItems:"center",children:n.jsx(re,{})}):n.jsx(De,{src:e,draggable:!1,boxSize:"100%",height:150,objectFit:"cover",borderRadius:4,cursor:(o==null?void 0:o.civitModelID)!=null?"pointer":"auto",onClick:()=>{(o==null?void 0:o.civitModelID)==null||(o==null?void 0:o.civitModelVersionID)==null||window.open(`https://civitai.com/models/${o==null?void 0:o.civitModelID}?modelVersionId=${o==null?void 0:o.civitModelVersionID}`)}}),n.jsx(D,{position:"absolute",bottom:"0",left:"0",right:"0",color:"white",fontSize:14})]}),n.jsx(oe,{label:n.jsxs("span",{children:[t.model_name+t.model_extension,n.jsx("br",{}),t.date.toLocaleDateString()]}),children:n.jsx(D,{textAlign:"center",p:"1",fontSize:14,noOfLines:2,children:(o==null?void 0:o.modelName)??t.model_name+t.model_extension})})]})}function Ot({list:t}){return n.jsx(ft,{templateColumns:"repeat(3, minmax(0, 1fr))",gap:1,marginTop:2,children:t.map(e=>n.jsx(Pe,{children:n.jsx(Pt,{data:e})},e.model_name+e.date.getTime()))})}const zt=async t=>{try{const s=await(await Q.fetchApi("/model_manager/install_model",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})).text();window.dispatchEvent(new CustomEvent("model_install_message",{detail:s}))}catch(e){console.error("Failed to connect to the server:",e)}};function je(t,e=1){const r=t/1024;return r>=1024?(r/1024).toFixed(e)+" GB":r.toFixed(e)+" MB"}function Se(t,e){if(!t||t.length===0)return;let s=t.find(i=>i.nsfw==="None");return e&&(s=s??t[0]),s}function Bt(t,e=280,s){var i,r,o,a;if(t)return ke(t)?(o=Se((r=(i=t.modelVersions)==null?void 0:i.at(0))==null?void 0:r.images,s))==null?void 0:o.url:`https://image.civitai.com/xG1nkqKTMzGDvpLrqFT7WA/${(a=Se(t.images,s))==null?void 0:a.url}/width=${e}/`}const ne=280;function Rt({model:t,onClickInstallModel:e,installing:s}){var u,p;const[i,r]=g.useState();g.useEffect(()=>{m();async function m(){var y;const x=await((y=$)==null?void 0:y.getSetting("showNsfwModelThumbnail"));r(Bt(t,ne,x))}},[t]);const o=ke(t)?t.modelVersions:t.versions,[a,c]=g.useState(((u=o==null?void 0:o[0])==null?void 0:u.name)??""),l=o==null?void 0:o.find(m=>(m==null?void 0:m.name)===a),d=()=>{window.open(`https://civitai.com/models/${t.id}`)},h=g.useCallback(()=>{if(l==null){console.error("no file is find by name",a);return}e(me(l,t.name),t)},[a]),f=(p=me(l))==null?void 0:p.sizeKB;return n.jsxs(Ie,{width:ne,justifyContent:"space-between",mb:2,gap:1,children:[n.jsx(De,{borderRadius:3,boxSize:ne+"px",objectFit:"cover",src:i,alt:"model cover image",cursor:"pointer",onClick:()=>d()}),n.jsxs(X,{p:1,children:[n.jsx(oe,{label:t.name,children:n.jsx(D,{fontWeight:500,noOfLines:1,children:t.name})}),n.jsxs(B,{justifyContent:"space-between",alignItems:"center",children:[n.jsx(A,{borderRadius:14,noOfLines:1,size:"xs",colorScheme:"teal",maxWidth:"40%",flexShrink:1,variant:"outline",px:1,cursor:"text",children:n.jsx(D,{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",children:t.type})}),n.jsx(A,{leftIcon:n.jsx(nt,{size:18}),iconSpacing:1,borderRadius:10,size:"sm",py:1,colorScheme:"teal",type:"submit",onClick:()=>h(),isDisabled:!!(a&&s.includes(a)),children:"Install"})]}),n.jsxs(R,{children:[n.jsx(ee,{size:"md",style:{paddingLeft:4},onChange:m=>{c(m.target.value)},children:o==null?void 0:o.map(m=>{const x=m==null?void 0:m.name;return x?n.jsx("option",{value:x,style:{padding:0},children:x},m.id):null})}),f&&n.jsx(oe,{label:je(f),children:n.jsx(D,{flexShrink:1,noOfLines:1,width:"40%",children:je(f)})})]})]})]})}function Wt({searchQuery:t,setSearchQuery:e,onSearch:s}){return n.jsxs(B,{gap:1,alignItems:"center",grow:1,children:[n.jsx(Z,{placeholder:"Search models in CivitAI",width:"60%",value:t,onChange:i=>e(i.target.value),onKeyUp:i=>{i.code==="Enter"&&s()}}),n.jsx(A,{size:"sm",onClick:()=>s(),colorScheme:"teal",children:"Search"})]})}function Kt({isOpen:t,fileSelected:e,onClose:s,selectFolder:i}){const[r,o]=g.useState(""),[a,c]=g.useState([]),[l,d]=g.useState(""),h=g.useRef(null);g.useEffect(()=>{f()},[]);const f=async()=>{const u=await Le();u&&(["custom_nodes","config","saved_prompts"].forEach(p=>{delete u[p]}),c(Object.values(u).flatMap(p=>p)))};return n.jsx(He,{isOpen:t,leastDestructiveRef:h,onClose:s,children:n.jsx(_e,{children:n.jsxs(Ye,{children:[n.jsx(be,{fontSize:"lg",fontWeight:"bold",children:"Choose Folder"}),n.jsx(Ce,{children:n.jsxs(X,{spacing:4,children:[!e&&n.jsxs(n.Fragment,{children:[n.jsx(D,{children:"Model download url"}),n.jsx(Z,{placeholder:"https://civitai.com/api/download/models/311399",onChange:u=>d(u.target.value),value:l})]}),n.jsx(D,{children:"Choose model install folder"}),n.jsx(ee,{placeholder:"Select option",value:r,onChange:u=>o(u.target.value),children:a.map(u=>n.jsx("option",{value:u,children:u},u))})]})}),n.jsxs(qe,{children:[n.jsx(A,{ref:h,onClick:s,children:"Cancel"}),n.jsx(A,{onClick:()=>i(r,l),ml:3,isDisabled:l.length===0,children:"Confirm"})]})]})})})}function Gt(){const{colorMode:t}=Qe(),e=Ee(),[s,i]=g.useState([]);return g.useEffect(()=>{Q.addEventListener("download_progress",r=>{i(r.detail)}),Q.addEventListener("download_error",r=>{e({title:"Download Error",description:r.detail,status:"error",duration:4e3,isClosable:!0})})},[]),n.jsx(X,{spacing:5,pos:"absolute",bottom:"0",left:"0",width:"50%",zIndex:80,backgroundColor:t==="light"?"white":"#242424",paddingX:5,pt:2,children:s.map(({save_path:r,progress:o})=>n.jsxs(R,{children:[n.jsx(D,{fontSize:16,width:"40%",children:r.replace(/^.*[\\/]/,"")}),n.jsx(Oe,{isIndeterminate:!o,hasStripe:!0,width:"50%",value:o}),n.jsxs(D,{fontSize:16,width:"10%",children:[o.toFixed(1),"%"]}),n.jsx(A,{variant:"outline",size:"sm",colorScheme:"red",onClick:()=>it(r),children:"Cancel"})]},r))})}const Ke="WORKSPACE_CIVIT_API_KEY_STORAGE_KEY";function $t(){return localStorage.getItem(Ke)}function Vt(t){localStorage.setItem(Ke,t)}function Ut(){const[t,e]=g.useState(""),{onOpen:s,onClose:i,isOpen:r}=Ae(),o=()=>{Vt(t),i()};return n.jsxs(ot,{isOpen:r,onOpen:s,onClose:i,placement:"right",closeOnBlur:!1,children:[n.jsx(rt,{children:n.jsx(A,{size:"sm",py:1,mr:8,children:"Set Civitai API Key"})}),n.jsxs(at,{p:5,children:[n.jsx(lt,{}),n.jsx(ct,{}),n.jsxs(X,{spacing:4,children:[n.jsx(D,{fontSize:14,children:"Some Civitai.com models require user login to download, you will nedd a Civitai API key to download in that case"}),n.jsx(Z,{value:t,onChange:a=>e(a.target.value),placeholder:"API Key"}),n.jsx(A,{size:"sm",py:1,mr:8,onClick:o,children:"Save"})]})]})]})}async function Ht(t,e){var a,c;const s={queries:[{q:t,indexUid:"models_v5",facets:["category.name","checkpointType","fileFormats","lastVersionAtUnix","tags.name","type","user.username","version.baseModel"],attributesToHighlight:["*"],highlightPreTag:"__ais-highlight__",highlightPostTag:"__/ais-highlight__",limit:80,offset:0}]};return e&&(s.queries[0].filter=[[`"type"="${e}"`]]),((c=(a=await(await fetch("https://meilisearch-v1-6.civitai.com/multi-search",{headers:{"Content-Type":"application/json",Authorization:"Bearer 102312c2b83ea0ef9ac32e7858f742721bbfd7319a957272e746f84fd1e974af"},method:"POST",body:JSON.stringify(s)})).json())==null?void 0:a.results)==null?void 0:c.at(0)).hits??[]}function Yt({onclose:t,searchQuery:e="",modelType:s}){const[i,r]=g.useState([]),[o,a]=g.useState(!1),[c,l]=g.useState(s),d=Ee(),[h,f]=g.useState([]),[u,p]=g.useState(e),{isOpen:m,onOpen:x,onClose:y}=Ae(),[j,C,b]=Te(),[T,K]=g.useState({}),[F,k]=g.useState(te),I=g.useCallback(async()=>{var _;a(!0);const w=await Ht(u,c);r(w);const v=await Le();v&&K(v);const M=await((_=$)==null?void 0:_.getSetting("defaultFolders"));M&&k(M),a(!1)},[u,c]),L=(w,v)=>{var de,he,ue,fe;if(!((de=b.current)!=null&&de.id)&&!v){console.error("no url to download");return}let M=v??`https://civitai.com/api/download/models/${(he=b.current)==null?void 0:he.id}`,_=(ue=b.current)==null?void 0:ue.name;if(!_&&(_=M.split("/").pop(),!_)){console.error("downloadUrl is malformed");return}d({title:"Installing...",description:_,status:"info",duration:4e3,isClosable:!0}),_!=null&&f(Ge=>[...Ge,_??""]);const ce=$t();ce&&(M+=`?token=${ce}`),zt({file_hash:(fe=b.current)==null?void 0:fe.SHA256,filename:_,save_path:w,url:M}),C(void 0),y()},O=async(w,v)=>{const M=F[v.type];C(w),M==null?x():L(M)},E=async(w,v)=>{var _;const M={...F,[w]:v};await((_=$)==null?void 0:_.upsert({defaultFolders:M})),k(M)};return g.useEffect(()=>{I()},[c]),n.jsxs(n.Fragment,{children:[n.jsxs(Je,{isOpen:!0,onClose:t,blockScrollOnMount:!0,children:[n.jsx(_e,{}),n.jsxs(Xe,{width:"90%",maxWidth:"90vw",height:"90vh",children:[n.jsxs(be,{pb:1,children:[n.jsxs(R,{gap:2,mb:2,alignItems:"center",children:[n.jsx(Ne,{size:"md",mr:2,children:"Models"}),n.jsx(Wt,{searchQuery:u,setSearchQuery:p,onSearch:I}),n.jsx(A,{size:"sm",py:1,mr:8,onClick:x,children:"Custom URL Install"}),n.jsx(Ut,{})]}),n.jsxs(R,{gap:2,wrap:"wrap",children:[n.jsx(A,{size:"sm",py:1,onClick:()=>{l(void 0)},isActive:c==null,children:"All"}),dt.map(w=>n.jsx(A,{size:"sm",py:1,isActive:c===w,onClick:()=>{l(w)},children:w},w)),c&&T[te[c]]&&n.jsxs(R,{ml:"auto",children:[n.jsx(D,{fontSize:17,whiteSpace:"nowrap",children:"Default Download Folder:"}),n.jsx(ee,{value:F[c],onChange:w=>E(c,w.target.value),children:T[te[c]].map(w=>n.jsx("option",{value:w,children:w}))})]})]}),o&&n.jsx(re,{thickness:"4px",emptyColor:"gray.200",color:"pink.500",size:"lg"})]}),n.jsx(Ze,{}),n.jsxs(Ce,{overflowY:"auto",children:[n.jsx(R,{wrap:"wrap",children:i==null?void 0:i.map(w=>n.jsx(Rt,{model:w,onClickInstallModel:O,installing:h},w.id))}),n.jsx(Gt,{})]})]})]}),n.jsx(Kt,{fileSelected:!!j,isOpen:m,onClose:y,selectFolder:(w,v)=>{L(w,b.current?void 0:v)}})]})}function qt(){const[t,e]=g.useState(!1);return n.jsxs(n.Fragment,{children:[n.jsx(A,{size:"sm",colorScheme:"teal",onClick:()=>e(!0),children:"Install Models"}),t&&n.jsx(Yt,{modelType:"Checkpoint",onclose:()=>e(!1)})]})}const Qt=()=>{const[t,e]=g.useState(["checkpoints"]),[s,i]=g.useState([]),[r,o]=g.useState(!0);g.useEffect(()=>{a(),Q.addEventListener("model_list",l=>{c(l.detail)})},[]);const a=async()=>{const l=await ht();c(l)},c=async l=>{if(!l)return;o(!1);const d=Array.from(new Set(l.map(f=>f.model_type))),h=d.indexOf("checkpoints");h>=0&&d.splice(h,1),d.unshift("checkpoints"),e(d),i(l.map(f=>({...f,date:new Date(f.date*1e3)})))};return{modelTypeList:t,modelsList:s,loading:r}};function Jt(){const[t,e,s]=Te(!1),i=()=>{var c;(c=$)==null||c.getSetting("showNsfwModelThumbnail").then(l=>{e(l??!1)})};g.useEffect(()=>{i()},[]);const r=c=>{var d;const l=c.target.checked;(d=$)==null||d.upsert({showNsfwModelThumbnail:l}).then(()=>{i(),o(),window.dispatchEvent(new Event("showNsfwModelThumbnail"))})},o=async()=>{const c=await H.models.toArray();for(let l=0;l<c.length;l+=5){const d=c.slice(l,l+5);await Promise.all(d.map(a))}},a=async c=>{var l,d;try{const h=`https://civitai.com/api/v1/model-versions/by-hash/${c.fileHash}`,u=await(await fetch(h)).json();let p;if(s.current)p=(d=(l=u==null?void 0:u.images)==null?void 0:l[0])==null?void 0:d.url;else if(!u.model.nsfw){const m=u.images.find(x=>x.nsfw==="None");p=m==null?void 0:m.url}H.models.update(c.id,{imageUrl:p??null})}catch{}};return n.jsx(mt,{isChecked:t,onChange:r,children:"Show NSFW"})}function Xt(){const t=async e=>{if(e.dataTransfer.getData("eventName")!=="WorkspaceManagerAddNode")return;const i=e.dataTransfer.getData("modelRelativePath"),r=e.dataTransfer.getData("nodeType"),o=LiteGraph.createNode(r);o.pos=[e.canvasX,e.canvasY],o.configure({widgets_values:[i]}),U.graph.add(o)};return g.useEffect(()=>(U.canvasEl.addEventListener("drop",t),()=>{U.canvasEl.removeEventListener("drop",t)}),[]),null}function Zt({onClose:t}){const[e,s]=g.useState("checkpoints"),[i,r]=g.useState(""),[o,a]=g.useState("name"),{loading:c,modelTypeList:l,modelsList:d}=Qt(),[h,f]=g.useState([]),[u,p]=g.useState([]);g.useEffect(()=>{x();async function x(){const y=await H.models.toArray();f(d.map(j=>({...j,db:y.find(C=>C.id===j.model_name+"@"+j.model_type)})))}},[d]),g.useEffect(()=>{let x=[];i.length?x=new V(h,{keys:["model_name","db.modelName"]}).search(i).map(C=>C.item):x=d.filter(y=>y.model_type===e).sort((y,j)=>o==="name"?y.model_name.localeCompare(j.model_name):j.date.getTime()-y.date.getTime()),p(x)},[e,d,i,o,h]),g.useEffect(()=>(U.canvasEl.addEventListener("click",t),()=>{U.canvasEl.removeEventListener("click",t)}),[t]);const m=440;return n.jsx(et,{children:n.jsxs(ie,{style:{width:m},children:[n.jsxs(Ie,{width:m,height:"100vh",p:4,gap:2,position:"fixed",top:0,left:0,shadow:"xl",zIndex:ut,overflowY:"auto",children:[n.jsxs(B,{justifyContent:"space-between",alignContent:"center",py:3,children:[n.jsx(Ne,{size:"md",mr:2,children:"Models"}),n.jsx(qt,{})]}),n.jsx(B,{gap:4,justifyContent:"center",alignItems:"center",mb:1,children:n.jsx(Z,{size:"sm",placeholder:"Search",value:i,onChange:x=>r(x.target.value)})}),n.jsxs(B,{gap:4,justifyContent:"space-between",alignItems:"center",mb:1,children:[!i.length&&n.jsxs(R,{children:[n.jsx("span",{children:"Sort By"}),n.jsxs(ee,{value:o,size:"sm",width:"120px",onChange:x=>a(x.target.value),children:[n.jsx("option",{value:"name",children:"Name"}),n.jsx("option",{value:"date",children:"Date"})]})]}),n.jsx(Jt,{})]}),!i.length&&n.jsx(Dt,{modelTypeList:l,setSelectedModel:s,selectedModel:e}),n.jsx(Ot,{list:u}),c&&n.jsx(B,{justifyContent:"center",alignItems:"center",height:"100%",children:n.jsx(re,{})})]}),n.jsx(Xt,{})]})})}const rs=Object.freeze(Object.defineProperty({__proto__:null,default:Zt},Symbol.toStringTag,{value:"Module"}));export{Pe as G,qt as I,Zt as M,rs as a,Ht as g};
