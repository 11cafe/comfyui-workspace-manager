import{f as P,j as e,c as b,a as H,u as D,o as W,b as U,d as G,r as a,l as V,H as w,I as Y,B as T,e as S,C as K,g as $,S as q,T as _,h as C,F as O,i as J,k as X,M as Q,m as Z,n as F,p as ee,q as te,s as ne,t as se,v as oe,w as le,x as ae,y as re}from"./input.js";import{api as ie}from"/scripts/api.js";import"/scripts/app.js";var B=P(function(n,l){const{children:s,placeholder:o,className:i,...h}=n;return e.jsxs(b.select,{...h,ref:l,className:H("chakra-select",i),children:[o&&e.jsx("option",{value:"",children:o}),s]})});B.displayName="SelectField";function ce(t,n){const l={},s={};for(const[o,i]of Object.entries(t))n.includes(o)?l[o]=i:s[o]=i;return[l,s]}var R=P((t,n)=>{var l;const s=D("Select",t),{rootProps:o,placeholder:i,icon:h,color:c,height:g,h:p,minH:d,minHeight:m,iconColor:f,iconSize:x,...y}=W(t),[u,r]=ce(y,V),v=U(r),j={width:"100%",height:"fit-content",position:"relative",color:c},M={paddingEnd:"2rem",...s.field,_focus:{zIndex:"unset",...(l=s.field)==null?void 0:l._focus}};return e.jsxs(b.div,{className:"chakra-select__wrapper",__css:j,...u,...o,children:[e.jsx(B,{ref:n,height:p??g,minH:d??m,placeholder:i,...v,__css:M,children:t.children}),e.jsx(N,{"data-disabled":G(v.disabled),...(f||c)&&{color:f||c},__css:s.icon,...x&&{fontSize:x},children:h})]})});R.displayName="Select";var de=t=>e.jsx("svg",{viewBox:"0 0 24 24",...t,children:e.jsx("path",{fill:"currentColor",d:"M16.59 8.59L12 13.17 7.41 8.59 6 10l6 6 6-6z"})}),ue=b("div",{baseStyle:{position:"absolute",display:"inline-flex",alignItems:"center",justifyContent:"center",pointerEvents:"none",top:"50%",transform:"translateY(-50%)"}}),N=t=>{const{children:n=e.jsx(de,{}),...l}=t,s=a.cloneElement(n,{role:"presentation",className:"chakra-select__icon",focusable:!1,"aria-hidden":!0,style:{width:"1em",height:"1em",color:"currentColor"}});return e.jsx(ue,{...l,className:"chakra-select__icon-wrapper",children:a.isValidElement(n)?s:null})};N.displayName="SelectIcon";const I={x:0,y:0};function he({children:t,onDragEnd:n}){const l=a.useRef(I),s=a.useRef(!1),[o,i]=a.useState(I),h=d=>{var m,f,x;if([(m=d.target)==null?void 0:m.id,(x=(f=d.target)==null?void 0:f.parentNode)==null?void 0:x.id].includes("dragPanelIcon")){l.current={x:d.clientX,y:d.clientY},s.current=!0,window.addEventListener("mousemove",c),window.addEventListener("mouseup",g);const y=document.getElementsByTagName("body")[0];y.style.userSelect="none"}},c=a.useCallback(d=>{const m={x:d.clientX-l.current.x,y:d.clientY-l.current.y};i(m)},[]),g=a.useCallback(()=>{i(m=>(n(m),I)),s.current=!1;const d=document.getElementsByTagName("body")[0];d.style.userSelect="auto",window.removeEventListener("mousemove",c),window.removeEventListener("mouseup",g)},[n,c]),p={transform:`translate(${o.x}px, ${o.y}px)`,zIndex:s.current?1e3:1};return e.jsx("div",{style:p,onMouseDown:h,children:t})}const A=a.createContext({setRoute:()=>{}}),E=200;function me({}){const[t,n]=a.useState({top:0,left:0});a.useEffect(()=>{const h=()=>{const c=localStorage.getItem("model_manager_position");if(c!=null){n(JSON.parse(c));return}n({left:window.innerWidth-E,top:0})};return window.addEventListener("resize",h),h(),()=>window.removeEventListener("resize",h)},[]);const[l,s]=a.useState(!1),{setRoute:o}=a.useContext(A),i=a.useCallback(h=>{const{top:c=0,left:g=0}=t||{};let{top:p=0,left:d=600}=h??{};p+=c,d+=g;const m=document.documentElement.clientWidth,f=document.documentElement.clientHeight,x=document.getElementById("modelManagerPanel"),y=(x==null?void 0:x.offsetWidth)||392;p+36>f&&(p=f-36),d+y>=m&&(d=m-y);const u={top:Math.max(0,p),left:Math.max(0,d)};n(u),localStorage.setItem("model_manager_position",JSON.stringify(u))},[t]);return e.jsx(he,{onDragEnd:h=>{i({top:h.y,left:h.x})},children:e.jsxs(w,{width:`${E}px`,style:{padding:2,position:"fixed",...t},justifyContent:"flex-end",alignItems:"center",gap:2,draggable:!1,id:"modelManagerPanel",onMouseEnter:()=>s(!0),onMouseLeave:()=>s(!1),children:[l?e.jsx(Y,{id:"dragPanelIcon",cursor:"move",size:15,color:"#FFF",width:"20px"}):e.jsx(T,{width:"20px"}),e.jsx(S,{size:"sm","aria-label":"models",onClick:()=>o("models"),px:2,children:"Models"})]})})}const pe=async t=>{try{const l=(await ie.fetchApi("/model_manager/install_model_stream",{method:"POST",body:JSON.stringify(t)})).body.getReader();for(;;){const{done:s,value:o}=await l.read();if(s)break;const i=new TextDecoder().decode(o);window.dispatchEvent(new CustomEvent("model_install_message",{detail:i}))}}catch(n){console.error("Failed to connect to the server:",n)}};function z(t,n=1){var l=t/1048576;return Number(l.toFixed(n))}const L=280;function xe({model:t,onClickInstallModel:n}){var d,m,f,x,y;const l=(x=(f=(m=(d=t.modelVersions)==null?void 0:d.at(0))==null?void 0:m.images)==null?void 0:f.at(0))==null?void 0:x.url,s=t.modelVersions,o=s==null?void 0:s.map(u=>{var r;return(r=u==null?void 0:u.files)==null?void 0:r.at(0)}),[i,h]=a.useState(((y=o==null?void 0:o.at(0))==null?void 0:y.name)??""),c=o==null?void 0:o.find(u=>(u==null?void 0:u.name)===i),g=()=>{window.open(`https://civitai.com/models/${t.id}`)},p=a.useCallback(()=>{if(c==null){console.error("no file is find by name",i);return}n(c,t)},[i]);return e.jsxs(K,{width:L,justifyContent:"space-between",mb:2,gap:1,children:[e.jsx($,{borderRadius:3,boxSize:L+"px",objectFit:"cover",src:l,alt:"model cover image",cursor:"pointer",onClick:()=>g()}),e.jsxs(q,{p:1,children:[e.jsx(_,{label:t.name,children:e.jsx(C,{fontWeight:500,noOfLines:1,children:t.name})}),e.jsxs(O,{justifyContent:"space-between",alignItems:"center",children:[e.jsx(S,{borderRadius:14,noOfLines:1,size:"xs",colorScheme:"teal",maxWidth:"40%",flexShrink:1,variant:"outline",px:1,cursor:"text",children:e.jsx(C,{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",children:t.type})}),e.jsx(S,{leftIcon:e.jsx(J,{size:18}),iconSpacing:1,borderRadius:10,size:"sm",py:1,colorScheme:"teal",type:"submit",onClick:()=>p(),children:"Install"})]}),e.jsxs(w,{children:[e.jsx(R,{size:"md",style:{paddingLeft:4},onChange:u=>{h(u.target.value)},children:o==null?void 0:o.map(u=>{const r=u==null?void 0:u.name;return r?e.jsx("option",{value:r,style:{padding:0},children:r},u.id):null})}),(c==null?void 0:c.sizeKB)&&e.jsx(_,{label:z(c.sizeKB)+"GB",children:e.jsxs(C,{flexShrink:1,noOfLines:1,width:"40%",children:[z(c.sizeKB)," GB"]})})]})]})]})}function fe(){const[t,n]=a.useState(""),l=s=>{const h=s.detail.split(`
`).reverse().find(c=>c.trim()!=="");n(h??"")};return a.useEffect(()=>(window.addEventListener("model_install_message",l),()=>{window.removeEventListener("model_install_message",l)}),[]),e.jsx(C,{fontWeight:"500",fontSize:18,py:2,children:t})}function ge({setSearchQuery:t}){const[n,l]=a.useState("");return e.jsxs(O,{gap:1,alignItems:"center",grow:1,children:[e.jsx(X,{placeholder:"Search models in CivitAI",width:"60%",value:n,onChange:s=>l(s.target.value),onKeyUp:s=>{s.code==="Enter"&&t(n)}}),e.jsx(S,{size:"sm",onClick:()=>t(n),colorScheme:"teal",children:"Search"})]})}const ye=["Checkpoint","TextualInversion","Hypernetwork","LORA","Controlnet","Upscaler","VAE"],je={Checkpoint:"checkpoints",TextualInversion:"embeddings",Hypernetwork:"hypernetworks",LORA:"loras",Controlnet:"controlnet",Upscaler:"upscale_models",VAE:"vae"};function we({onclose:t}){const[n,l]=a.useState([]),[s,o]=a.useState(!1),[i,h]=a.useState([]),[c,g]=a.useState(!1),[p,d]=a.useState("Checkpoint"),[m,f]=a.useState(""),x=a.useCallback(async()=>{g(!0);const r={limit:"30",nsfw:"false",types:p};m!==""&&(r.query=m);const j=`https://civitai.com/api/v1/models?${new URLSearchParams(r).toString()}`,k=await(await fetch(j)).json();console.log("json",k),h(k.items),g(!1)},[m,p]),y=(r,v)=>{if(console.log("file",r),r.downloadUrl==null||r.name==null){console.error("file.downloadUrl or file.name is null");return}let j=je[v.type];j==null&&(j=prompt("What's the folder path under /ComfyUI/models you want to save the model? ")),j!=null&&pe({filename:r.name,name:r.name,save_path:j,url:r.downloadUrl})};a.useEffect(()=>{console.log("searchQuery",m),x()},[m,p]);const u=i.length>0&&n.length===i.length;return e.jsxs(Q,{isOpen:!0,onClose:t,blockScrollOnMount:!0,children:[e.jsx(Z,{}),e.jsxs(F,{width:"90%",maxWidth:"90vw",height:"90vh",children:[e.jsxs(ee,{children:[e.jsxs(w,{gap:2,mb:2,alignItems:"center",children:[e.jsx(te,{size:"md",mr:2,children:"Models"}),e.jsx(ge,{setSearchQuery:f})]}),e.jsx(fe,{}),e.jsxs(w,{gap:2,mb:2,wrap:"wrap",children:[e.jsx(S,{size:"sm",py:1,onClick:()=>{d(void 0)},isActive:p==null,children:"All"}),ye.map(r=>e.jsx(S,{size:"sm",py:1,isActive:p===r,onClick:()=>{d(r)},children:r}))]}),s&&e.jsxs(w,{gap:3,children:[e.jsx(ne,{isChecked:u,children:"All"}),e.jsxs(C,{fontSize:16,children:[n.length," Selected"]}),e.jsx(se,{size:"sm",icon:e.jsx(oe,{size:19}),onClick:()=>o(!1),"aria-label":"cancel"})]})]}),e.jsx(le,{}),e.jsxs(ae,{overflowY:"auto",children:[c&&e.jsx(re,{thickness:"4px",emptyColor:"gray.200",color:"pink.500",size:"lg"}),e.jsx(w,{wrap:"wrap",children:i==null?void 0:i.map(r=>e.jsx(xe,{model:r,onClickInstallModel:y},r.id))})]})]})]})}function Ie(){const[t,n]=a.useState("root");return e.jsx(A.Provider,{value:{setRoute:n},children:e.jsxs(T,{style:{width:"100vh",position:"absolute",top:0,left:0,right:0},zIndex:1e3,draggable:!1,children:[e.jsx(me,{}),t==="models"&&e.jsx(we,{onclose:()=>n("root")})]})})}export{Ie as default};
